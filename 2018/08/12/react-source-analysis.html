<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">






  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-flash.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: true,
    lazyload: true,
    tabs: true,
    motion: {"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="版本：v16.5.2 前言当时在各种前端框架或库充斥市场的情况下，出现了大量优秀的框架，比如 Backbone、Angular、Knockout、Ember 这些框架大都采用了 MV* 的理念，把数据与视图分离。而就在这样纷繁复杂的时期，React 诞生于 Facebook 的内部项目，因为该公司对市场上所有 JavaScript MVC 框架，都不满意，就决定自己写一套，用来架设 Instagr">
<meta name="keywords" content="react">
<meta property="og:type" content="article">
<meta property="og:title" content="React 源码全方位剖析">
<meta property="og:url" content="http://sosout.com/2018/08/12/react-source-analysis.html">
<meta property="og:site_name" content="每天一探">
<meta property="og:description" content="版本：v16.5.2 前言当时在各种前端框架或库充斥市场的情况下，出现了大量优秀的框架，比如 Backbone、Angular、Knockout、Ember 这些框架大都采用了 MV* 的理念，把数据与视图分离。而就在这样纷繁复杂的时期，React 诞生于 Facebook 的内部项目，因为该公司对市场上所有 JavaScript MVC 框架，都不满意，就决定自己写一套，用来架设 Instagr">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://sosout.com/images/react-source-analysis/img2.png">
<meta property="og:updated_time" content="2018-09-29T15:48:33.625Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="React 源码全方位剖析">
<meta name="twitter:description" content="版本：v16.5.2 前言当时在各种前端框架或库充斥市场的情况下，出现了大量优秀的框架，比如 Backbone、Angular、Knockout、Ember 这些框架大都采用了 MV* 的理念，把数据与视图分离。而就在这样纷繁复杂的时期，React 诞生于 Facebook 的内部项目，因为该公司对市场上所有 JavaScript MVC 框架，都不满意，就决定自己写一套，用来架设 Instagr">
<meta name="twitter:image" content="http://sosout.com/images/react-source-analysis/img2.png">



  <link rel="alternate" href="/atom.xml" title="每天一探" type="application/atom+xml" />




  <link rel="canonical" href="http://sosout.com/2018/08/12/react-source-analysis.html"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>React 源码全方位剖析 | 每天一探</title>
  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123825183-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123825183-1');
</script>



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?aed6dded356af07f3b5991c346dc812d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">每天一探</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">无法停止探索的脚步</h1>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-首页">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-分类">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-标签">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-归档">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-开源项目">
    <a href="/project/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-github"></i> <br />开源项目</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-关于">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-站点地图">
    <a href="/sitemap.xml" rel="section">
      <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />站点地图</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://sosout.com/2018/08/12/react-source-analysis.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Weich">
      <meta itemprop="description" content="看博客上一探">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="每天一探">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">React 源码全方位剖析
              
            
          </h2>
        

        <div class="post-meta">
          
            <span class="post-meta-item-icon">
              <i class="fa fa-thumb-tack"></i>
            </span>
            <font color="red">置顶</font>
            <span class="post-meta-divider">|</span>
          
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-08-12 22:10:52" itemprop="dateCreated datePublished" datetime="2018-08-12T22:10:52+08:00">2018-08-12</time>
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/react/" itemprop="url" rel="index"><span itemprop="name">react</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/08/12/react-source-analysis.html" class="leancloud_visitors" data-flag-title="React 源码全方位剖析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">140k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">2:07</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><code>版本：v16.5.2</code></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>当时在各种前端框架或库充斥市场的情况下，出现了大量优秀的框架，比如 Backbone、Angular、Knockout、Ember 这些框架大都采用了 MV* 的理念，把数据与视图分离。而就在这样纷繁复杂的时期，React 诞生于 Facebook 的内部项目，因为该公司对市场上所有 JavaScript MVC 框架，都不满意，就决定自己写一套，用来架设 Instagram 的网站。做出来以后，发现这套东西很好用，就在2013年5月开源了。所谓知其然还要知其所以然，加上 React 真是一天一改，如果现在不看，以后也真的很难看懂了。目前社区有很多 React 的源码剖析文章，趁着最近工作不忙，我打算分享一下 React 源码，并自形成一个系列，欢迎一起交流。在开始之前我们先做以下几点约定：</p>
<p><strong>第一：</strong>目前分析的版本是 React 的最新版本 16.5.2；<br><strong>第二：</strong>React web应用是最常见的，也是最易于理解的，所以该源码均围绕 React web应用剖析；<br><strong>第三：</strong>我尽可能站在我自己的角度去剖析，当然我会借鉴社区比较优秀的文章，同时面对大家的拍砖，我无条件接受，也很乐意与大家一起交换意见，努力写好该 React 源码系列；<br><strong>第四：</strong>如果有幸您读到该 React 源码系列，感觉写得还行，还望收藏、分享或打赏。</p>
<h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><p>我们从这一章开始即将分析 React 的源码，在分析源码之前我们很有必要介绍一些前置知识如flow、Rollup等。除此之外，我们最好已经用过 React 做过实际项目，对 React 的思想有了一定的了解，对绝大部分的 API 都已经有使用，同时，我们应该有一定的HTML、CSS、JavaScript、ES6+、node &amp; npm等功底，并对代码调试有一定的了解。</p>
<p>如果具备了以上条件，并且对 React 的实现原理很感兴趣，那么就可以开始 React 的底层学习了，对它的实现细节一探究竟。</p>
<h3 id="Flow-JavaScript静态类型检查工具"><a href="#Flow-JavaScript静态类型检查工具" class="headerlink" title="Flow - JavaScript静态类型检查工具"></a>Flow - JavaScript静态类型检查工具</h3><p><a href="https://flow.org/" target="_blank" rel="noopener">Flow</a> 是 facebook 出品的 JavaScript 静态类型检查工具，它与 Typescript 不同的是，它可以部分引入，不需要完全重构整个项目，所以对于一个已有一定规模的项目来说，迁移成本更小，也更加可行。除此之外，Flow 可以提供实时增量的反馈，通过运行 Flow server 不需要在每次更改项目的时候完全从头运行类型检查，提高运行效率。可以简单总结为：<strong>对于新项目，可以考虑使用 TypeScript 或者 Flow，对于已有一定规模的项目则建议使用 Flow 进行较小成本的逐步迁移来引入类型检查。React 的源码利用了 Flow 做了静态类型检查，所以了解 Flow 有助于我们阅读源码。</strong></p>
<h4 id="为什么用静态类型检查工具-Flow"><a href="#为什么用静态类型检查工具-Flow" class="headerlink" title="为什么用静态类型检查工具 Flow"></a>为什么用静态类型检查工具 Flow</h4><p>JavaScript 是动态类型语言，它的灵活性有目共睹，但是过于灵活的副作用就是很容易就写出非常隐蔽的隐患代码，在编译期甚至运行时看上去都不会报错，但是可能会发生各种各样奇怪的和难以解决的bug。</p>
<p>类型检查是当前动态类型语言的发展趋势，所谓类型检查，就是在编译期尽早发现（由类型错误引起的）bug，又不影响代码运行（不需要运行时动态检查类型），使编写 JavaScript 具有和编写 Java 等强类型语言相近的体验。</p>
<p>项目越复杂就越需要通过工具的手段来保证项目的维护性和增强代码的可读性。React 源码在 ES2015 的基础上，除了用 ESLint 保证代码风格之外，也引入了 Flow 做静态类型检查。之所以选择 Flow，<strong>最根本原因应该和 Vue 一样，还是在于工程上成本和收益的考量。</strong> 大致体现在以下几点：</p>
<p><strong>第一点：</strong>使用 Flow 可以一个一个文件地迁移，如果使用 TypeScript，则需要全部替换，成本极高，短期内并不现实；<br><strong>第二点：</strong>Babel 和 ESLint 都有对应的 Flow 插件以支持语法，可以完全沿用现有的构建配置，非常小成本的改动就可以拥有静态类型检查的能力；<br><strong>第三点：</strong>更贴近 ES 规范。除了 Flow 的类型声明之外，其他都是标准的 ES。万一哪天不想用 Flow 了，用<code>babel-plugin-transform-flow-strip-types</code>转一下，就得到符合规范的 ES；<br><strong>第四点：</strong>在需要的地方保留 ES 的灵活性，并且对于生成的代码尺寸有更好的控制力 (rollup / 自定义 babel 插件）。</p>
<h4 id="如何用静态类型检查工具-Flow"><a href="#如何用静态类型检查工具-Flow" class="headerlink" title="如何用静态类型检查工具 Flow"></a>如何用静态类型检查工具 Flow</h4><p>在这里我们就简单说一说 Flow 的用法，其他用法可以参考<a href="https://flow.org/" target="_blank" rel="noopener">Flow官网</a>（可能需要 VPN，非常不稳定），有时间我会详细写一篇 Flow 使用指南。</p>
<p>Flow 仅仅是一个用于检查的工具，安装使用都很方便，使用时注意以下3点即可：</p>
<p>1.将 Flow 安装到我们的项目中。<br>2.确保编译之后的代码移除了 Flow 相关的语法。<br>3.在需要检查的地方增加了 Flow 相关的类型注解。</p>
<p><strong>第一点：将Flow增加到我们的项目中</strong></p>
<p>安装最新版本的 Flow：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --save-dev flow-bin</span><br></pre></td></tr></table></figure></p>
<p>安装完成之后在 package.json 文件中增加执行脚本：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  // ...</span><br><span class="line">  "scripts": &#123;</span><br><span class="line">    "your-script-name": "flow",</span><br><span class="line">    // ...</span><br><span class="line">  &#125;,</span><br><span class="line">  // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后初始化 Flow：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm run flow init</span><br></pre></td></tr></table></figure>
<p>执行完成后，Flow 会在终端输出以下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; yourProjectName@1.0.0 flow /yourProjectPath</span><br><span class="line">&gt; flow &quot;init&quot;</span><br></pre></td></tr></table></figure>
<p>然后在根目录下生成一个名为 .flowconfig 的文件，打开之后是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[ignore]</span><br><span class="line"></span><br><span class="line">[include]</span><br><span class="line"></span><br><span class="line">[libs]</span><br><span class="line"></span><br><span class="line">[lints]</span><br><span class="line"></span><br><span class="line">[options]</span><br><span class="line"></span><br><span class="line">[strict]</span><br></pre></td></tr></table></figure>
<p>基本上，配置文件没有什么特殊需求是不用去配置的，Flow 默认涵盖了当前目录之后的所有文件。[include] 用于引入项目之外的文件。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[include]</span><br><span class="line"></span><br><span class="line">../otherProject/a.js</span><br><span class="line"></span><br><span class="line">[libs]</span><br></pre></td></tr></table></figure>
<p>它会将和当前项目平级的 otherProject/a.js 文件纳入进来。详细配置文件请看<a href="https://flow.org/en/docs/config/" target="_blank" rel="noopener">官网</a>。</p>
<p><strong>第二点：编译之后的代码移除 Flow 相关的语法</strong></p>
<p>Flow 在 JavaScript 语法的基础上使用了一些注解（annotation）进行了扩展。因此浏览器无法正确的解读这些 Flow 相关的语法，我们必须在编译之后的代码中（最终发布的代码）将增加的 Flow 注解移除掉。具体方法需要看我们使用了什么样的编译工具。下面将说明一些 React 开发常用的编译工具：</p>
<p><strong>方式一：</strong>create-react-app</p>
<p>如果我们的项目是使用<a href="https://github.com/facebook/create-react-app" target="_blank" rel="noopener">create-react-app</a>直接创建的，那么移除 Flow 语法的事项就不用操心了，create-react-app 已经帮我们搞定了这个事。</p>
<p><strong>方式二：</strong>Babel</p>
<p>如果使用 Babel 我们需要安装一个 Babel 对于 Flow 的 preset：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --save-dev babel-preset-flow</span><br></pre></td></tr></table></figure></p>
<p>然后，我们需要在项目根目录<a href="http://babeljs.io/docs/en/babelrc/" target="_blank" rel="noopener">Babel 的配置文件 .babelrc</a>中添加一个 Flow 相关的 preset：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"presets"</span>: [</span><br><span class="line">    <span class="string">"flow"</span>,</span><br><span class="line">    //other config</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>方式三：</strong>flow-remove-types</p>
<p>如果我们既没有使用 create-react-app 也没使用 Babel 作为语法糖编译器，那么可以使用 <a href="https://github.com/flowtype/flow-remove-types" target="_blank" rel="noopener">flow-remove-types</a> 这个工具在发布之前移除 Flow 代码。</p>
<p><strong>第三点：在需要检查的地方增加 Flow 相关的类型注解</strong></p>
<p>如果我们了解 C++/C# 的元编程或者 Java 的 Annotation，那么理解 Flow 的 Annotation 就会非常轻松。大概就是在文件、方法、代码块之前增加一个注解（Annotation）用来告知 Flow 的执行行为。</p>
<p>首先，Flow 只检查包含<code>// @flow</code>注解的文件，所以如果需要检查，我们需要这样编写我们的文件，首先我们写一个正确的示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* @flow */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">x: number, y: number</span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> x + y</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">add(<span class="number">22</span>, <span class="number">11</span>)</span><br></pre></td></tr></table></figure>
<p>运行 Flow 终端会打印出以下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; yourProjectName@1.0.0 flow /yourProjectPath</span><br><span class="line">&gt; flow &quot;init&quot;</span><br><span class="line"></span><br><span class="line">Found 0 errors</span><br></pre></td></tr></table></figure>
<p>承接上面代码，我们把代码修改成带有检查错误的例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* @flow */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">x: number, y: number</span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> x + y</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">add(<span class="string">"Hello"</span>, <span class="number">11</span>)</span><br></pre></td></tr></table></figure>
<p>运行 Flow 终端会打印出以下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&gt; yourProjectName@1.0.0 flow /yourProjectPath</span><br><span class="line">&gt; flow &quot;init&quot;</span><br><span class="line"></span><br><span class="line">Error ------------------------------------------------------------------------------------- src/platforms/web/mnr.js:8:5</span><br><span class="line"></span><br><span class="line">Cannot call `add` with `&quot;Hello&quot;` bound to `x` because string [1] is incompatible with number [2].</span><br><span class="line"></span><br><span class="line">   src/platforms/web/mnr.js:8:5</span><br><span class="line">   8| add(&quot;Hello&quot;, 11)</span><br><span class="line">          ^^^^^^^ [1]</span><br><span class="line"></span><br><span class="line">References:</span><br><span class="line">   src/platforms/web/mnr.js:4:17</span><br><span class="line">   4| function add(x: number, y: number): number &#123;</span><br><span class="line">                      ^^^^^^ [2]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Found 1 error</span><br></pre></td></tr></table></figure>
<p>到这里，Flow 已经算是安装成功了，接下来的事是要增加各种注解以加强类型限定或者参数检测。之后的内容将简要介绍 flow 的类型检查方式。</p>
<h4 id="Flow-的类型检查方式"><a href="#Flow-的类型检查方式" class="headerlink" title="Flow 的类型检查方式"></a>Flow 的类型检查方式</h4><p>现在我们就说说 Flow 常用的2种类型检查方式：<br><strong>类型推断</strong>：通过变量的执行上下文来推断出变量类型，然后根据这些推断来检查类型。<br><strong>类型注释</strong>：事先注释好我们期望的类型，Flow 会基于这些注释来检查。</p>
<p><strong>第一种方式：类型推断</strong></p>
<p>此方式不需要编写任何代码即可进行类型检查，最小化开发者的工作量，它也不会强制我们改变开发习惯，因为它会自动推断出变量的类型，这就是所谓的类型推断，Flow 最重要的特性之一。</p>
<p>通过一个简单例子说明一下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*@flow*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">split</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> str.split(<span class="string">' '</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">split(<span class="number">11</span>)</span><br></pre></td></tr></table></figure></p>
<p>Flow 检查上述代码后会报错，因为函数 split 期待的参数是字符串，而我们输入的是数字。</p>
<p><strong>第二种方式：类型注释</strong></p>
<p>如上所述，类型推断是 Flow 最有用的特性之一，不需要编写任何代码就能进行类型检查。但在某些特定的场景下，使用类型注释可以提供更好更明确的检查依据。</p>
<p>看看以下代码：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*@flow*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">x, y</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> x + y</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">add(<span class="string">'Hello'</span>, <span class="number">11</span>)</span><br></pre></td></tr></table></figure></p>
<p>Flow 根据类型推断检查上述代码时检查不出任何错误，因为从语法层面考虑， + 既可以用在字符串上，也可以用在数字上，我们并没有明确指出 add() 的参数必须为数字。在这种情况下，我们可以借助类型注释来指明期望的类型。类型注释是以冒号 : 开头，可以在函数参数，返回值，变量声明中使用。如果我们在上段代码中使用类型注释，就会变成如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*@flow*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">x: number, y: number</span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> x + y</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">add(<span class="string">'Hello'</span>, <span class="number">11</span>)</span><br></pre></td></tr></table></figure></p>
<p>现在 Flow 就能检查出错误，因为函数参数的期待类型为数字，而我们提供了字符串。上面的例子是针对函数的类型注释。接下来我们来看看 Flow 能支持的一些常见的类型注释:</p>
<p><strong>第一种：</strong>数组<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*@flow*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arr: <span class="built_in">Array</span>&lt;number&gt; = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">arr.push(<span class="string">'Hello'</span>)</span><br></pre></td></tr></table></figure></p>
<p>数组类型注释的格式是 Array<t>，T 表示数组中每项的数据类型。在上述代码中，arr 是每项均为数字的数组。如果我们给这个数组添加了一个字符串，Flow 能检查出错误。</t></p>
<p><strong>第二种：</strong>类和对象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*@flow*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bar</span> </span>&#123;</span><br><span class="line">  x: string;           <span class="comment">// x 是字符串</span></span><br><span class="line">  y: string | number;  <span class="comment">// y 可以是字符串或者数字</span></span><br><span class="line">  z: boolean;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(x: string, y: string | number) &#123;</span><br><span class="line">    <span class="keyword">this</span>.x = x</span><br><span class="line">    <span class="keyword">this</span>.y = y</span><br><span class="line">    <span class="keyword">this</span>.z = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bar: Bar = <span class="keyword">new</span> Bar(<span class="string">'hello'</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj: &#123; <span class="attr">a</span>: string, <span class="attr">b</span>: number, <span class="attr">c</span>: <span class="built_in">Array</span>&lt;string&gt;, <span class="attr">d</span>: Bar &#125; = &#123;</span><br><span class="line">  a: <span class="string">'hello'</span>,</span><br><span class="line">  b: <span class="number">11</span>,</span><br><span class="line">  c: [<span class="string">'hello'</span>, <span class="string">'world'</span>],</span><br><span class="line">  d: <span class="keyword">new</span> Bar(<span class="string">'hello'</span>, <span class="number">3</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>类的类型注释格式如上，可以对类自身的属性做类型检查，也可以对构造函数的参数做类型检查。这里需要注意的是：属性 y 的类型中间用 | 做间隔，表示 y 的类型即可以是字符串也可以是数字。</p>
<p>对象的注释类型类似于类，需要指定对象属性的类型。</p>
<p><strong>第三种：</strong>Null/undefined</p>
<p>Flow 会检查所有的 JavaScript 基础类型—— Boolean、String、Number、null、undefined（在Flow中用void代替）。除此之外还提供了一些操作符号，例如 text : ?string，它表示参数存在“没有值”的情况，除了传递 string 类型之外，还可以是 null 或 undefined。需要特别注意的是，这里的没有值和 JavaScript 的表达式的“非”是两个概念，Flow 的“没有值”只有 null、void（undefined），而 JavaScript 表达式的“非”包含：null、undefined、0、false。</p>
<p>如果想任意类型 T 可以为 null 或者 undefined，只需写成如下 ?T 的格式即可：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*@flow*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> foo: ?string = <span class="literal">null</span></span><br></pre></td></tr></table></figure>
<p>此时，foo 可以为字符串，也可以为 null。</p>
<h4 id="Flow-在-React-源码中的应用"><a href="#Flow-在-React-源码中的应用" class="headerlink" title="Flow 在 React 源码中的应用"></a>Flow 在 React 源码中的应用</h4><p>Flow 是 Facebook 开源的静态代码检查工具，它的作用就是在运行代码之前对 React 组件以及 Jsx 语法进行静态代码的检查以发现一些可能存在的问题。在 React v16 Fiber中的部分 TypeScript 代码只是类型声明文件和测试代码，也就是为了方便利用 TypeScript 写应用的开发者使用 React，给了接口定义和测试样例而已。</p>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>React 重构告诉我们，项目重构要么依赖规范，要么就得自己有绝对控制权，同时还要考量开发成本、项目收益以及整个团队的技术水平，并不是一味的什么火就用什么。这一节主要对 Flow 的认识，有助于我们后续阅读 React 的源码，这种静态类型检查的方式非常有利于大型项目源码的开发和维护。</p>
<h3 id="Rollup-另一个前端模块化的打包工具"><a href="#Rollup-另一个前端模块化的打包工具" class="headerlink" title="Rollup - 另一个前端模块化的打包工具"></a>Rollup - 另一个前端模块化的打包工具</h3><p>Rollup 是前端模块化的一个打包工具，可以将小块代码编译成大块复杂的代码，例如 library 或应用程序。简单地说，<strong>它可以从一个入口文件开始，将所有使用的模块根据命令或者根据 Rollup 配置文件打包成一个目标文件，并且 Rollup 会自动过滤掉那些没有被使用过的函数或变量，从而使代码最小化，如果想使用直接导入这一个目标文件即可，因此 Rollup 极其适合构建一个工具库。</strong></p>
<p>这里提到 Rollup 的两个特别重要的特性，<strong>第一个就是它使用了 ES2015 的模板标准，这意味着我们可以直接使用 import 和 export 而不需要引入 babel。另一个重要特性叫做 tree-shaking，这个特性可以帮助我们将无用代码（即没有使用的代码）从最终的目标文件中过滤掉。</strong>举个简单的例子，我们在 foo.js 文件定义了 f1 和 f2 两个方法，然后在入口文件 index.js 只引入了 foo.js 文件中的 f1 方法，那么在最后打包 index.js 文件时，Rollup 就不会将 f2 方法打包到最终文件中（这个特性是基于 ES6 模块的静态分析的，也就是说，只有 export 而没有 import 的变量是不会被打包到最终代码中的）。</p>
<h4 id="为什么用前端模块化的打包工具-Rollup"><a href="#为什么用前端模块化的打包工具-Rollup" class="headerlink" title="为什么用前端模块化的打包工具 Rollup"></a>为什么用前端模块化的打包工具 Rollup</h4><p>之前的构建系统是基于 Gulp/Grunt+Browserify 手搓的一套工具，后来在扩展方面受限于工具，例如：</p>
<p>Node 环境下性能不好：频繁的<code>process.env.NODE_ENV</code>访问拖慢了<code>SSR 性能</code>，但又没办法从类库角度解决，因为<code>Uglify</code>依靠这个去除无用代码，所以<code>React SSR</code>性能最佳实践一般都有一条“<code>重新打包 React，在构建时去掉 process.env.NODE_ENV</code>”.</p>
<p>丢弃了过于复杂（overly-complicated）的自定义构建工具，改用更合适的 Rollup：</p>
<blockquote>
<p>It solves one problem well: how to combine multiple modules into a flat file with minimal junk code in between.</p>
</blockquote>
<p>无论 Haste -&gt; ES Module 还是 Gulp/Grunt+Browserify -&gt; Rollup 的切换都是从非标准的定制化方案切换到标准的开放的方案，应该在“手搓”方面吸取教训，为什么业界规范的东西在我们的场景不适用，非要自己造吗？</p>
<h4 id="如何用前端模块化的打包工具-Rollup"><a href="#如何用前端模块化的打包工具-Rollup" class="headerlink" title="如何用前端模块化的打包工具 Rollup"></a>如何用前端模块化的打包工具 Rollup</h4><p>关于如何使用前端模块化的打包工具 Rollup，这里就不做过多介绍了，可参考我之前写的一篇文章：<a href="/2018/08/04/rollup-tutorial.html">Rollup使用指南</a>，更详细的使用文档可参考：<a href="https://www.rollupjs.com/guide/zh" target="_blank" rel="noopener">官网</a>。</p>
<h4 id="Webpack-和-Rollup-有什么不同"><a href="#Webpack-和-Rollup-有什么不同" class="headerlink" title="Webpack 和 Rollup 有什么不同"></a>Webpack 和 Rollup 有什么不同</h4><p>2017年4月初，Facebook 将一个巨大的 pull 请求合并到了 React 主分支(master)中，将其现有的构建流程替换为基于 Rollup，这一举动促使一些人产生很大的疑惑“React 为什么选择 Rollup 而抛弃 webpack”，难道webpack要跌下神坛了？</p>
<p>Webpack 是目前使用最为火热的打包工具，没有之一，每月有数百万的下载量，为成千上万的网站和应用提供支持。相比之下，Rollup 并不起眼。但 React 并不孤单 – Vue，Ember，Preact，D3，Three.js，Moment 以及其他许多知名的库也使用 Rollup 。世界到底怎么了？为什么我们不能只有一个大众认可的 JavaScript 模块化打包工具？</p>
<p>Webpack 始于2012年，由 Tobias Koppers 发起，用于解决当时现有工具未解决的的一个难题：<strong>构建复杂的单页应用程序(SPA)。</strong>特别是 webpack 的两个特性改变了一切：</p>
<p><strong>第一个特性：</strong>代码拆分(Code Splitting)</p>
<p>代码拆分也就是说我们可以将应用程序分解成可管理的代码块，可以按需加载，这意味着用户可以快速获取网站内容，而不必等到整个应用程序下载和解析完成。</p>
<p><strong>第二个特性：</strong>各式各样的加载器（loader）</p>
<p>不管是图像，css，还是 html ，在 Webpack 看来一切都可作为模块，然后通过不同的加载器 loader 来加载它们。</p>
<p>ES6 发布之后，其中引入的模块机制使得静态分析成为了可能，于是 Rollup 发布了：其中 Rollup 有两个特别重要的特性，第一个就是它利用 ES2015 巧妙的模块设计，尽可能高效的构建出能够直接被其他 Javascript 库的。另一个重要特性叫做 tree-shaking，这个特性可以帮助我们将无用代码（即没有使用的代码）从最终的目标文件中过滤掉。</p>
<p>紧接着 Webpack2 发布，仿照 Rollup 增加了 tree-shaking。 在之后， Webpack3 发布，仿照 Rollup 又增加了 Scope Hoisting。在在之后， Parcel 发布了一个快速、零配置的打包工具。于是，Webpack4 仿照 Parcel 发布了。</p>
<p>说了这么多，工作中我们到底该用哪个工具？</p>
<p>对于应用使用 webpack，对于类库使用 Rollup。如果我们需要代码拆分(Code Splitting)，或者我们有很多静态资源需要处理，再或者我们构建的项目需要引入很多 CommonJS 模块的依赖，那么 webpack 是个很不错的选择。如果您的代码库是基于 ES2015 模块的，而且希望我们写的代码能够被其他人直接使用，我们需要的打包工具可能是 Rollup。</p>
<h4 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h4><p>无论 Haste -&gt; ES Module 还是 Gulp/Grunt+Browserify -&gt; Rollup 的切换都是从非标准的定制化方案切换到标准的开放的方案，可以看出 React 团队也在积极拥抱标准方案并非一味造轮子。其实 Vue.js 1.0.10 就已经使用 Rollup 了，而 React v16.0 改用 Rollup 肯定也有借鉴之意，因此，好技术都是在借鉴的大背景下诞生的（Vue 就是一个典型的例子）。在这里通过对 Rollup 的认识，有助于我们了解 React 的构建以及源码目录结构。</p>
<h2 id="项目介绍"><a href="#项目介绍" class="headerlink" title="项目介绍"></a>项目介绍</h2><p>上一章我们简单介绍了下flow、Rollup等前置知识，有兴趣的可以有针对性的学习它们。这一章我们真正的开始分析 React 源码，激动不激动？该章主要包括三小节：项目目录、源码构建、源码入口。</p>
<h3 id="项目目录"><a href="#项目目录" class="headerlink" title="项目目录"></a>项目目录</h3><h4 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h4><p>我们主要剖析的 React 源码目录在 packages 下，在这里我们看看详细目录结构，混个眼熟：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">├── build --------------------------------------- 构建后的输出目录</span><br><span class="line">├── fixtures ------------------------------------ React 开发的测试用例</span><br><span class="line">├── packages ------------------------------------ 源码目录，我们主要剖析目录</span><br><span class="line">│   ├── create-subscription --------------------- 在组件里订阅额外数据的工具</span><br><span class="line">│   ├── events ---------------------------------- 事件处理 </span><br><span class="line">│   ├── interaction-tracking -------------------- 跟踪交互事件</span><br><span class="line">│   ├── react ----------------------------------- 核心代码</span><br><span class="line">│   ├── react-art ------------------------------- 矢量图形库</span><br><span class="line">│   ├── react-dom ------------------------------- DOM 渲染相关</span><br><span class="line">│   ├── react-is -------------------------------- React 元素类型相关</span><br><span class="line">│   ├── react-native-renderer ------------------- react-native 渲染相关 </span><br><span class="line">│   ├── react-noop-renderer --------------------- Fiber 测试相关 </span><br><span class="line">│   ├── react-reconciler ------------------------ React 调制器</span><br><span class="line">│   ├── react-scheduler ------------------------- 规划 React 初始化，更新等等</span><br><span class="line">│   ├── react-test-renderer --------------------- 实验性的 React 渲染器</span><br><span class="line">│   ├── shared ---------------------------------- 通用代码</span><br><span class="line">│   ├── simple-cache-provider ------------------- 为 React 应用提供缓存</span><br><span class="line">│   ├── server ---------------------------------- 服务端渲染</span><br><span class="line">│   ├── sfc ------------------------------------- .vue 文件解析</span><br><span class="line">│   ├── shared ---------------------------------- 整个项目通用代码</span><br><span class="line">├── scripts ------------------------------------- 公共的lint，build，test和release等相关的文件</span><br><span class="line">│   ├── eslint ---------------------------------- 语法规则和代码风格</span><br><span class="line">│   ├── flow ------------------------------------ Flow 类型声明</span><br><span class="line">│   ├── git ------------------------------------- git钩子的目录</span><br><span class="line">│   ├── jest ------------------------------------ JavaScript 测试目录</span><br><span class="line">│   ├── release --------------------------------- 自动发布新版本脚本</span><br><span class="line">│   ├── rollup ---------------------------------- rollup 构建目录</span><br><span class="line">├── .babelrc ------------------------------------ babel 配置文件</span><br><span class="line">├── .editorconfig ------------------------------- 编辑器语法规范配置</span><br><span class="line">├── .eslintignore ------------------------------- eslint 忽略配置 </span><br><span class="line">├── .eslintrc ----------------------------------- eslint 配置文件</span><br><span class="line">├── .gitattributes ------------------------------ 给 attributes 路径名的简单文本文件</span><br><span class="line">├── .gitignore ---------------------------------- git 忽略配置</span><br><span class="line">├── .mailmap ------------------------------------ 邮件列表档案 </span><br><span class="line">├── .nvmrc -------------------------------------- nvm 配置文件</span><br><span class="line">├── .prettierrc.js ------------------------------ prettierrc 配置文件</span><br><span class="line">├── .watchmanconfig ----------------------------- watchman 配置文件</span><br><span class="line">├── appveyor.yml -------------------------------- GitHub 托管项目的自动化集成</span><br><span class="line">├── AUTHORS ------------------------------------- 开发者列表档案</span><br><span class="line">├── CHANGELOG.md -------------------------------- 更新日志</span><br><span class="line">├── CODE_OF_CONDUCT.md -------------------------- Code <span class="keyword">of</span> Conduct</span><br><span class="line">├── CONTRIBUTING.md ----------------------------- Contributing to React</span><br><span class="line">├── dangerfile.js ------------------------------- 提高 Code Review 体验</span><br><span class="line">├── netlify.toml -------------------------------- 持续集成静态网站</span><br><span class="line">├── package-lock.json --------------------------- npm 加锁文件</span><br><span class="line">├── package.json -------------------------------- 项目管理文件</span><br><span class="line">├── README.md ----------------------------------- 项目文档</span><br><span class="line">├── yarn.lock ----------------------------------- yarn 加锁文件</span><br></pre></td></tr></table></figure>
<p>一眼望去，上面的目录结构是不是感觉很是奇怪？<br><strong>根目录下没有 src 之类的源码目录，也没有 test 这类的存放单元测试的目录，只有一个 packages 目录。这个 repository 其实是一个用 Lerna 管理的 monorepo。实际上，我们往npm上发布的几个package都来自于同一个codebase，包括react、react-dom、react-is……</strong></p>
<h4 id="monorepo"><a href="#monorepo" class="headerlink" title="monorepo"></a>monorepo</h4><p>通常，当我们的项目不断的迭代更新的时候，我们会根据业务或者是功能又或者是方便复用某些代码模块，把一个大的 codebase 拆成一些独立的 package 或 module，再将这些功能独立的 package 分别放入单独的 repository 中进行维护，此方式可以简单地称为<code>multiple repositories</code>。而 monorepo 则是一种相反的做法，它提倡将所有的相关 package 都放入一个 repository 来管理。</p>
<p><strong>monorepo VS multirepo（集中管理 vs 多元化）</strong><br>首先这两者都是管理组织代码的方式，顾名思义 monorepo 就是把所有的相关项目都放在一个仓库中（比如 React, Angular, Babel, Google…），multirepo 则是按模块分为多个仓库。</p>
<p><strong>multirepo：</strong>这种管理方式可以让每个子团队拥有自己的 repo，我们可以用自己擅长的工具、workflow 等等。多元化能促使各个团队尽可能的提升自己的效率。但代价也在于会增加很多沟通成本，如果我们项目用到的库中发现了一个 bug，就必须到目标库里修复它、打包、发版本，然后再回到我们的库继续工作。在不同的仓库间，我们不仅需要处理不同的代码、工具，甚至是不同的工作流程。甚至我们只能去问维护这个仓库的人，能不能为我们做出改变，然后等着他们去解决。</p>
<p><strong>monorepo：</strong>这种管理方式可以让不同的团队走自己的路，并不见得能提高生产力。虽然有些团队可能会找到自己最佳的工作方式，但我们的收益也会被其他团队不那么好的工作方式所抵消。相反，严格统一的管理更能提升效率，团队中的任何人都可以（并且应该也被鼓励）修改任何东西（因为修改造成的结果马上就能展现出来，）。虽然把所有的鸡蛋都放进了一个篮子里，但我们也可以更小心的照顾这个篮子。</p>
<p>如果我们团队选择 monorepo，那主要的挑战自然是随着项目的发展，其会变得非常庞大（因为没有根据模块或功能拆分成不同 repo）。因此会需要很多的工具来应对这样的挑战。虽然我们可能认为这是一个很糟糕的做法，但是现在这样做的开源项目和公司并不算少。</p>
<p><strong>谁在使用 monorepo</strong><br>Babel 是一个 Javascript 编译器，它可以将浏览器环境尚未支持的 Javascript 变为向下兼容的版本。因此，我们可以毫无顾虑地使用较新的 Javascript 语法和特性来提升编程的体验和效率。</p>
<p>其中 Babel 官方维护了众多独立的 plugin、polyfill、preset，但并未按照传统，将这些独立的模块分别放入不同的 repo。而是遵循了 monorepo 的方式，将它们放入一个相同的 repo 中。因为 Babel 认为，有效的组织一个多模块，多 repo 的项目，就像是尝试教一个刚出生的婴儿骑自行车一样。</p>
<blockquote>
<p>Juggling a multimodule project over multiple repos is like trying to teach a newborn baby how to ride a bike.</p>
</blockquote>
<p>所以，Babel 采用了 lerna 来管理自己的 monorepo。</p>
<p>无独有偶，Cycle.js（一个函数式和响应式 Javascript 框架）的作者 André Staltz 也摒弃了一个 package 一个 repo 的做法，将 Cycle.js 的众多 package 迁移到了一个 monorepo 中。他也认为，管理多个 repo 并不是件有意思的事情。多个  repo 意味着有多个地方需要处理 issue，保持多个 repo 的 issue 标签统一，管理很多 PR 和 git 钩子等等。</p>
<blockquote>
<p>Managing multiple repos isn’t that fun. Multiple repos means multiple places to manage issues, manage issue labels (and making them consistent across repos), manage PRs, git hooks for conventions, etc.</p>
</blockquote>
<p>André Staltz 并没有使用 lerna 之类的工具来实现自己的 monorepo，他自己通过 Bash sh 实现了类似于 Lerna 管理的 monorepo。</p>
<p>除了 Babel 和 Cycle.js 以外，React、Angular、Meteor、Ember，还包括国内饿了么的 mint-ui 等等开源项目，以及一些公司如 Google、Facebook、BBC 等也都采用了 monorepo。它到底有什么优点，这么多公司，这么多库纷纷加入。</p>
<p><strong>优点</strong><br><strong>一：</strong>单个的 lint，build，test 和 release 流程；<br><strong>二：</strong>统一的地方处理issue；<br><strong>三：</strong>不用到处去找自己项目的repo；<br><strong>四：</strong>方便管理版本和dependencies；<br><strong>五：</strong>跨项目的操作和修改变得容易；<br><strong>六：</strong>方便生成总的changelog。</p>
<p><strong>缺点</strong><br><strong>一：</strong>repo 的体积变得很大；<br><strong>二：</strong>安全问题，如何管理权限。</p>
<p>关于 monorepo 我们暂且就说这么多，有时间我会单独写一篇 monorepo 文章。</p>
<h4 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h4><p>从 React 的目录设计可以看出，React 团队在项目管理比较倾向 monorepo 方式，看来这种严格统一的管理方式真的提升效率。无论 monorepo 方式，还是 multirepo 方式都是为了团队效率，因此建议还是根据团队的情况选定一种方式，尽可能的扬长避短。</p>
<h3 id="源码构建"><a href="#源码构建" class="headerlink" title="源码构建"></a>源码构建</h3><p>React v16.0 之前源码是基于<code>Gulp/Grunt+Browserify</code>构建的，而 React v16.0 是基于<code>Rollup</code>构建的，它的构建相关配置都在<code>scripts/rollup</code>目录下。</p>
<h4 id="构建命令"><a href="#构建命令" class="headerlink" title="构建命令"></a>构建命令</h4><p>通常基于 NPM 托管的项目都会有一个 package.json 文件，实际上它是项目的描述文件，它的内容是一个标准的 JSON 对象。我们通常会配置 script 字段作为 NPM 的构建命令，React 源码构建配置如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    // ...</span><br><span class="line">    "scripts": &#123;</span><br><span class="line">        "build": "npm run version-check &amp;&amp; node ./scripts/rollup/build.js",</span><br><span class="line">        // ...</span><br><span class="line">        "version-check": "node ./scripts/tasks/version-check.js"</span><br><span class="line">    &#125;</span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里<code>build命令</code>，实际上先执行<code>version-check</code>命令，然后执行<code>node ./scripts/rollup/build.js</code>进行打包，其中<code>version-check</code>命令实际上是执行<code>node ./scripts/tasks/version-check.js</code>，用于检查即将构建的<code>bundle版本</code>是否完全匹配，接下来我们就来看看它实际上是如何构建的。</p>
<h4 id="构建过程"><a href="#构建过程" class="headerlink" title="构建过程"></a>构建过程</h4><p>我们首先打开<code>build</code>命令对应的第一个 JS 文件，在<code>scripts/tasks/version-check.js</code>中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> reactVersion = <span class="built_in">require</span>(<span class="string">'../../package.json'</span>).version;</span><br><span class="line"><span class="keyword">const</span> versions = &#123;</span><br><span class="line">  <span class="string">'packages/react/package.json'</span>: <span class="built_in">require</span>(<span class="string">'../../packages/react/package.json'</span>)</span><br><span class="line">    .version,</span><br><span class="line">  <span class="string">'packages/react-dom/package.json'</span>: <span class="built_in">require</span>(<span class="string">'../../packages/react-dom/package.json'</span>)</span><br><span class="line">    .version,</span><br><span class="line">  <span class="string">'packages/react-test-renderer/package.json'</span>: <span class="built_in">require</span>(<span class="string">'../../packages/react-test-renderer/package.json'</span>)</span><br><span class="line">    .version,</span><br><span class="line">  <span class="string">'packages/shared/ReactVersion.js'</span>: <span class="built_in">require</span>(<span class="string">'../../packages/shared/ReactVersion'</span>),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> allVersionsMatch = <span class="literal">true</span>;</span><br><span class="line"><span class="built_in">Object</span>.keys(versions).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> version = versions[name];</span><br><span class="line">  <span class="keyword">if</span> (version !== reactVersion) &#123;</span><br><span class="line">    allVersionsMatch = <span class="literal">false</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(</span><br><span class="line">      <span class="string">'%s version does not match package.json. Expected %s, saw %s.'</span>,</span><br><span class="line">      name,</span><br><span class="line">      reactVersion,</span><br><span class="line">      version</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!allVersionsMatch) &#123;</span><br><span class="line">  process.exit(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码逻辑非常简单，先获取<code>即将发布的以及源码核心bundle</code>的管理文件，再比对<code>即将发布的和源码核心bundle</code>的版本，如果不相同，给出对应的提示并结束构建，这样就保证了构建出来的 bundle 版本统一。</p>
<p>接下来我们打开<code>build</code>命令对应的第二个 JS 文件，在<code>scripts/rollup/build.js</code>中：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">buildEverything</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">await</span> asyncRimRaf(<span class="string">'build'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Run them serially for better console output</span></span><br><span class="line">  <span class="comment">// and to avoid any potential race conditions.</span></span><br><span class="line">  <span class="comment">// eslint-disable-next-line no-for-of-loops/no-for-of-loops</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> bundle <span class="keyword">of</span> Bundles.bundles) &#123;</span><br><span class="line">    <span class="keyword">await</span> createBundle(bundle, UMD_DEV);</span><br><span class="line">    <span class="keyword">await</span> createBundle(bundle, UMD_PROD);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">buildEverything();</span><br></pre></td></tr></table></figure></p>
<p>这里通过调用<code>buildEverything</code>函数开启构建过程，<code>asyncRimRaf</code>用于删除上一次打包生成的包文件，然后循环包配置文件的配置构建出不同用途的 React 包，稍后我们再来看构建函数<code>createBundle</code>，我们先来看看包配置文件，在<code>scripts/rollup/bundles.js</code>中：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bundles = [</span><br><span class="line">  <span class="comment">/******* Isomorphic *******/</span></span><br><span class="line">  &#123;</span><br><span class="line">    label: <span class="string">'core'</span>,</span><br><span class="line">    bundleTypes: [</span><br><span class="line">      UMD_DEV,</span><br><span class="line">      UMD_PROD,</span><br><span class="line">      NODE_DEV,</span><br><span class="line">      NODE_PROD,</span><br><span class="line">      FB_WWW_DEV,</span><br><span class="line">      FB_WWW_PROD,</span><br><span class="line">    ],</span><br><span class="line">    moduleType: ISOMORPHIC,</span><br><span class="line">    entry: <span class="string">'react'</span>,</span><br><span class="line">    global: <span class="string">'React'</span>,</span><br><span class="line">    externals: [],</span><br><span class="line">  &#125;,</span><br><span class="line">    <span class="comment">/******* React DOM *******/</span></span><br><span class="line">  &#123;</span><br><span class="line">    label: <span class="string">'dom-client'</span>,</span><br><span class="line">    bundleTypes: [</span><br><span class="line">      UMD_DEV,</span><br><span class="line">      UMD_PROD,</span><br><span class="line">      NODE_DEV,</span><br><span class="line">      NODE_PROD,</span><br><span class="line">      NODE_PROFILING,</span><br><span class="line">      FB_WWW_DEV,</span><br><span class="line">      FB_WWW_PROD,</span><br><span class="line">      FB_WWW_PROFILING,</span><br><span class="line">    ],</span><br><span class="line">    moduleType: RENDERER,</span><br><span class="line">    entry: <span class="string">'react-dom'</span>,</span><br><span class="line">    global: <span class="string">'ReactDOM'</span>,</span><br><span class="line">    externals: [<span class="string">'react'</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  bundles,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>这里简单列举了一些 React 包构建的配置，其他已省略，可以看出实际上这是一个用于 Rollup 构建配置的对象数组，通过循环该对象数组构建出不同用途的 React 包。接下来我们再看一下构建函数<code>createBundle</code>，在<code>scripts/rollup/build.js</code>中：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">createBundle</span>(<span class="params">bundle, bundleType</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (shouldSkipBundle(bundle, bundleType)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> filename = getFilename(bundle.entry, bundle.global, bundleType);</span><br><span class="line">  <span class="keyword">const</span> logKey =</span><br><span class="line">    chalk.white.bold(filename) + chalk.dim(<span class="string">` (<span class="subst">$&#123;bundleType.toLowerCase()&#125;</span>)`</span>);</span><br><span class="line">  <span class="keyword">const</span> format = getFormat(bundleType);</span><br><span class="line">  <span class="keyword">const</span> packageName = Packaging.getPackageName(bundle.entry);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> resolvedEntry = <span class="built_in">require</span>.resolve(bundle.entry);</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    bundleType === FB_WWW_DEV ||</span><br><span class="line">    bundleType === FB_WWW_PROD ||</span><br><span class="line">    bundleType === FB_WWW_PROFILING</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">const</span> resolvedFBEntry = resolvedEntry.replace(<span class="string">'.js'</span>, <span class="string">'.fb.js'</span>);</span><br><span class="line">    <span class="keyword">if</span> (fs.existsSync(resolvedFBEntry)) &#123;</span><br><span class="line">      resolvedEntry = resolvedFBEntry;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> shouldBundleDependencies =</span><br><span class="line">    bundleType === UMD_DEV || bundleType === UMD_PROD;</span><br><span class="line">  <span class="keyword">const</span> peerGlobals = Modules.getPeerGlobals(bundle.externals, bundleType);</span><br><span class="line">  <span class="keyword">let</span> externals = <span class="built_in">Object</span>.keys(peerGlobals);</span><br><span class="line">  <span class="keyword">if</span> (!shouldBundleDependencies) &#123;</span><br><span class="line">    <span class="keyword">const</span> deps = Modules.getDependencies(bundleType, bundle.entry);</span><br><span class="line">    externals = externals.concat(deps);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> importSideEffects = Modules.getImportSideEffects();</span><br><span class="line">  <span class="keyword">const</span> pureExternalModules = <span class="built_in">Object</span>.keys(importSideEffects).filter(</span><br><span class="line">    <span class="built_in">module</span> =&gt; !importSideEffects[<span class="built_in">module</span>]</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> rollupConfig = &#123;</span><br><span class="line">    input: resolvedEntry,</span><br><span class="line">    treeshake: &#123;</span><br><span class="line">      pureExternalModules,</span><br><span class="line">    &#125;,</span><br><span class="line">    external(id) &#123;</span><br><span class="line">      <span class="keyword">const</span> containsThisModule = <span class="function"><span class="params">pkg</span> =&gt;</span> id === pkg || id.startsWith(pkg + <span class="string">'/'</span>);</span><br><span class="line">      <span class="keyword">const</span> isProvidedByDependency = externals.some(containsThisModule);</span><br><span class="line">      <span class="keyword">if</span> (!shouldBundleDependencies &amp;&amp; isProvidedByDependency) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> !!peerGlobals[id];</span><br><span class="line">    &#125;,</span><br><span class="line">    onwarn: handleRollupWarning,</span><br><span class="line">    plugins: getPlugins(</span><br><span class="line">      bundle.entry,</span><br><span class="line">      externals,</span><br><span class="line">      bundle.babel,</span><br><span class="line">      filename,</span><br><span class="line">      packageName,</span><br><span class="line">      bundleType,</span><br><span class="line">      bundle.global,</span><br><span class="line">      bundle.moduleType,</span><br><span class="line">      bundle.modulesToStub</span><br><span class="line">    ),</span><br><span class="line">    <span class="comment">// We can't use getters in www.</span></span><br><span class="line">    legacy:</span><br><span class="line">      bundleType === FB_WWW_DEV ||</span><br><span class="line">      bundleType === FB_WWW_PROD ||</span><br><span class="line">      bundleType === FB_WWW_PROFILING,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> [mainOutputPath, ...otherOutputPaths] = Packaging.getBundleOutputPaths(</span><br><span class="line">    bundleType,</span><br><span class="line">    filename,</span><br><span class="line">    packageName</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> rollupOutputOptions = getRollupOutputOptions(</span><br><span class="line">    mainOutputPath,</span><br><span class="line">    format,</span><br><span class="line">    peerGlobals,</span><br><span class="line">    bundle.global,</span><br><span class="line">    bundleType</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;chalk.bgYellow.black(<span class="string">' BUILDING '</span>)&#125;</span> <span class="subst">$&#123;logKey&#125;</span>`</span>);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> rollup(rollupConfig);</span><br><span class="line">    <span class="keyword">await</span> result.write(rollupOutputOptions);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;chalk.bgRed.black(<span class="string">' OH NOES! '</span>)&#125;</span> <span class="subst">$&#123;logKey&#125;</span>\n`</span>);</span><br><span class="line">    handleRollupError(error);</span><br><span class="line">    <span class="keyword">throw</span> error;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; otherOutputPaths.length; i++) &#123;</span><br><span class="line">    <span class="keyword">await</span> asyncCopyTo(mainOutputPath, otherOutputPaths[i]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;chalk.bgGreen.black(<span class="string">' COMPLETE '</span>)&#125;</span> <span class="subst">$&#123;logKey&#125;</span>\n`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上述关键的代码是<code>const result = await rollup(rollupConfig);</code>，可以看出这是通过 rollup 打包的，对于单个配置，它是遵循 Rollup 的构建规则的。其中 input 属性表示构建的入口 JS 文件地址，output.file 属性表示构建后的输出的  JS 文件地址，format 属性表示构建的格式，cjs 表示构建出来的文件遵循<a href="http://wiki.commonjs.org/wiki/Modules/1.1" target="_blank" rel="noopener">CommonJS 规范</a>，es 表示构建出来的文件遵循<a href="http://exploringjs.com/es6/ch_modules.html" target="_blank" rel="noopener">ES Module 规范</a>，umd 表示构建出来的文件遵循<a href="https://github.com/umdjs/umd" target="_blank" rel="noopener">UMD 规范</a>。</p>
<p>下面我们以配置文件的第一个<code>react</code>配置为例：</p>
<p>构建的入口 JS 文件地址：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> resolvedEntry = <span class="built_in">require</span>.resolve(bundle.entry);</span><br></pre></td></tr></table></figure>
<p>沿着<code>bundle.entry</code>我们发现它的值为<code>react</code>（在<code>scripts/rollup/bundles.js</code>中），<code>require.resolve</code>用于查询文件的完整绝对路径，也就说<code>react</code>对应的真实入口路径是<code>/**/**/react/packages/react/index.js</code>，由此不难看出所有源码都在<code>packages</code>中：</p>
<p>构建后的输出的 JS 文件地址：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [mainOutputPath, ...otherOutputPaths] = Packaging.getBundleOutputPaths(</span><br><span class="line">    bundleType,</span><br><span class="line">    filename,</span><br><span class="line">    packageName</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p>接下来我们看看<code>Packaging.getBundleOutputPaths</code>，在<code>scripts/rollup/packaging.js</code>中：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getBundleOutputPaths</span>(<span class="params">bundleType, filename, packageName</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (bundleType) &#123;</span><br><span class="line">    <span class="keyword">case</span> NODE_DEV:</span><br><span class="line">    <span class="keyword">case</span> NODE_PROD:</span><br><span class="line">    <span class="keyword">case</span> NODE_PROFILING:</span><br><span class="line">      <span class="keyword">return</span> [<span class="string">`build/node_modules/<span class="subst">$&#123;packageName&#125;</span>/cjs/<span class="subst">$&#123;filename&#125;</span>`</span>];</span><br><span class="line">    <span class="keyword">case</span> UMD_DEV:</span><br><span class="line">    <span class="keyword">case</span> UMD_PROD:</span><br><span class="line">      <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">`build/node_modules/<span class="subst">$&#123;packageName&#125;</span>/umd/<span class="subst">$&#123;filename&#125;</span>`</span>,</span><br><span class="line">        <span class="string">`build/dist/<span class="subst">$&#123;filename&#125;</span>`</span>,</span><br><span class="line">      ];</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Unknown bundle type.'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从上面不难看出所有打包后的输出文件都在<code>build</code>，这就是为什么打包前先删除<code>build</code>文件了。</p>
<h4 id="小结-3"><a href="#小结-3" class="headerlink" title="小结"></a>小结</h4><p>通过这一节的分析，我们可以了解到 React 的打包过程，也知道了不同作用和功能的 React 对应的入口以及最终编译生成的 JS 文件。</p>
<h3 id="源码入口"><a href="#源码入口" class="headerlink" title="源码入口"></a>源码入口</h3><h4 id="React-对象"><a href="#React-对象" class="headerlink" title="React 对象"></a>React 对象</h4><p>实际项目中，可以看到首先需要使用如下代码：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br></pre></td></tr></table></figure></p>
<p>这句代码做的就是引入了React核心源码模块。而我们在源码构建一节讲到 React 的核心入口文件是<code>packages/react/index.js</code>:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> React = <span class="built_in">require</span>(<span class="string">'./src/React'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> decide on the top-level export form.</span></span><br><span class="line"><span class="comment">// This is hacky but makes it work with both Rollup and Jest.</span></span><br><span class="line"><span class="built_in">module</span>.exports = React.default || React;</span><br></pre></td></tr></table></figure></p>
<p>上述代码中执行<code>import React from &#39;react&#39;</code>时，其实引入的就是这里提供的对象。</p>
<p>这里需要说明一点：这里为什么会导出 React.default || React？（以下提到的插件都可以在源码中找到）</p>
<ol>
<li><strong>React.default 用于 Jest 测试</strong><br>babel解析器将 es6 的 export、import等模块关键字转换成 commonjs 的规范，babel 转换 es6 的模块输出逻辑非常简单，即将所有输出都赋值给 exports。其中<code>packages/react/src/React.js</code>使用<code>export default</code>导出 React 对象，这里 babel 会将其转化<code>exports.default = React</code>，因此导入的结果其实是一个含 default 属性的对象，因此需要使用 React.default 来获取实际的 React 对象。</li>
<li><strong>React 用于 Rollup</strong><br>rollup-plugin-node-resolve 插件可以解决 ES6 模块的查找导入，如果npm中的包以CommonJS模块的形式出现的，我们可以使用rollup-plugin-commonjs 将CommonJS模块转换为ES6来为Rollup获得兼容（即令(ES6)import === (CommonJS)require），导入的结果其实是不含 default 属性的对象，因此直接使用 React 来获取实际的 React 对象。</li>
</ol>
<p>在这个入口 JS 的上方我们可以找到 React 的来源：<code>const React = require(&#39;./src/React&#39;);</code>，我们来看一下这块儿的实现，它定义在<code>packages/react/src/React.js</code> 中，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ReactVersion <span class="keyword">from</span> <span class="string">'shared/ReactVersion'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  REACT_ASYNC_MODE_TYPE,</span><br><span class="line">  REACT_FRAGMENT_TYPE,</span><br><span class="line">  REACT_PROFILER_TYPE,</span><br><span class="line">  REACT_STRICT_MODE_TYPE,</span><br><span class="line">  REACT_PLACEHOLDER_TYPE,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'shared/ReactSymbols'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;enableSuspense&#125; <span class="keyword">from</span> <span class="string">'shared/ReactFeatureFlags'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;Component, PureComponent&#125; <span class="keyword">from</span> <span class="string">'./ReactBaseClasses'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;createRef&#125; <span class="keyword">from</span> <span class="string">'./ReactCreateRef'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;forEach, map, count, toArray, only&#125; <span class="keyword">from</span> <span class="string">'./ReactChildren'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  createElement,</span><br><span class="line">  createFactory,</span><br><span class="line">  cloneElement,</span><br><span class="line">  isValidElement,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'./ReactElement'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;createContext&#125; <span class="keyword">from</span> <span class="string">'./ReactContext'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;lazy&#125; <span class="keyword">from</span> <span class="string">'./ReactLazy'</span>;</span><br><span class="line"><span class="keyword">import</span> forwardRef <span class="keyword">from</span> <span class="string">'./forwardRef'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  createElementWithValidation,</span><br><span class="line">  createFactoryWithValidation,</span><br><span class="line">  cloneElementWithValidation,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'./ReactElementValidator'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactSharedInternals <span class="keyword">from</span> <span class="string">'./ReactSharedInternals'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> React = &#123;</span><br><span class="line">  Children: &#123;</span><br><span class="line">    map,</span><br><span class="line">    forEach,</span><br><span class="line">    count,</span><br><span class="line">    toArray,</span><br><span class="line">    only,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  createRef,</span><br><span class="line">  Component,</span><br><span class="line">  PureComponent,</span><br><span class="line"></span><br><span class="line">  createContext,</span><br><span class="line">  forwardRef,</span><br><span class="line"></span><br><span class="line">  Fragment: REACT_FRAGMENT_TYPE,</span><br><span class="line">  StrictMode: REACT_STRICT_MODE_TYPE,</span><br><span class="line">  unstable_AsyncMode: REACT_ASYNC_MODE_TYPE,</span><br><span class="line">  unstable_Profiler: REACT_PROFILER_TYPE,</span><br><span class="line"></span><br><span class="line">  createElement: __DEV__ ? createElementWithValidation : createElement,</span><br><span class="line">  cloneElement: __DEV__ ? cloneElementWithValidation : cloneElement,</span><br><span class="line">  createFactory: __DEV__ ? createFactoryWithValidation : createFactory,</span><br><span class="line">  isValidElement: isValidElement,</span><br><span class="line"></span><br><span class="line">  version: ReactVersion,</span><br><span class="line"></span><br><span class="line">  __SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED: ReactSharedInternals,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (enableSuspense) &#123;</span><br><span class="line">  React.Placeholder = REACT_PLACEHOLDER_TYPE;</span><br><span class="line">  React.lazy = lazy;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> React;</span><br></pre></td></tr></table></figure>
<p>上述就是我们 React 的庐山真面目，实际上它的内容是一个标准的 JSON 对象，这里 React 对象里面包含什么一目了然，比如我们常用的Component、PureComponent等，由此可以看出React核心内容只包括定义组件相关的内容和API。</p>
<h4 id="渲染"><a href="#渲染" class="headerlink" title="渲染"></a>渲染</h4><p>React 的定位是一个构建用户界面的JavaScript类库，它使用JavaScript语言开发UI组件，可以使用多种方式渲染这些组件，输出用户界面，很大程度上达到了跨平台的能力：</p>
<blockquote>
<p>We don’t make assumptions about the rest of your technology stack, so you can develop new features in React without rewriting existing code.</p>
</blockquote>
<p>现在的 React 在以下几个方面都发挥着很不错的效果：</p>
<ol>
<li>React Web应用用户界面开发；</li>
<li>React Native App用户界面开发；</li>
<li>Node.js 服务端渲染；</li>
</ol>
<p>在这些不同场景，渲染的主体很明显是不一样的，有诸如web应用的DOM渲染，React Native的原生View渲染，服务端字符串渲染等，要做到兼容适应多种不同渲染环境，很显然，React不能局限固定渲染UI的方式。</p>
<p>上一节我们讲到React核心内容只涉及如何定义组件，并不涉及具体的组件渲染（即输出用户界面），这需要引入额外渲染模块，下面以渲染React定义的组件为例：</p>
<p><strong>React DOM渲染模块：</strong>React DOM渲染模块：将React组件渲染为DOM，然后可以被浏览器处理呈现给用户，这就是通常在web应用中引入的react-dom模块：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App'</span>;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>, document.getElementById('root'));</span></span><br></pre></td></tr></table></figure></p>
<p>上述代码中，App是使用React核心模块定义的组件，然后使用react-dom渲染模块提供的render方法将其渲染为DOM输出至页面。</p>
<p><strong>React Native 渲染：</strong>：将React组件渲染为移动端原生View，在React Native应用中引入react-native模块，它提供相应渲染方法可以渲染React组件：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AppRegistry &#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./src/app.js'</span>;</span><br><span class="line"></span><br><span class="line">AppRegistry.registerComponent(<span class="string">'fuc'</span>, () =&gt; App);</span><br></pre></td></tr></table></figure></p>
<p>上述代码中，App是React根组件，使用react-native渲染器的AppRegistry.registerComponent方法将其渲染为原生View。</p>
<p><strong>React测试渲染：</strong>将React组件渲染为JSON树，用来完成Jest的快照测试，内容在react-test-renderer模块：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ReactTestRenderer <span class="keyword">from</span> <span class="string">'react-test-renderer'</span>; </span><br><span class="line"><span class="keyword">const</span> renderer = ReactTestRenderer.create(</span><br><span class="line">  &lt;Link page=<span class="string">"https://www.facebook.com/"</span>&gt;Facebook&lt;<span class="regexp">/Link&gt;</span></span><br><span class="line"><span class="regexp">); </span></span><br><span class="line"><span class="regexp">console.log(renderer.toJSON()); </span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ &#123; type: 'a',</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/   props: &#123; href: 'https:/</span><span class="regexp">/www.facebook.com/</span><span class="string">' &#125;,</span></span><br><span class="line"><span class="string">//   children: [ '</span>Facebook<span class="string">' ] &#125;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="小结-4"><a href="#小结-4" class="headerlink" title="小结"></a>小结</h4><p>那么至此，我们应该对 React 是什么有一个直观的认识，它本质上是含有诸多属性的JavaScript对象，它核心内容只涉及如何定义组件，具体的组件渲染（即输出用户界面），需要引入额外的渲染模块，渲染组件方式由环境决定，定义组件，组件状态管理，生命周期方法管理，组件更新等应该跨平台一致处理，不受渲染环境影响，这部分内容统一由调和器（Reconciler）处理，不同渲染器都会使用该模块。调和器主要作用就是在组件状态变更时，调用组件树各组件的render方法，渲染，卸载组件。至于 React 能做什么，它是怎么做的，我们会在后面的章节一一剖析它们。</p>
<h2 id="主要概念"><a href="#主要概念" class="headerlink" title="主要概念"></a>主要概念</h2><h3 id="首次渲染"><a href="#首次渲染" class="headerlink" title="首次渲染"></a>首次渲染</h3><h4 id="渲染入口"><a href="#渲染入口" class="headerlink" title="渲染入口"></a>渲染入口</h4><p>在 Web 项目中，如果我们要将应用渲染至页面，通常会用如下代码：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App'</span>; <span class="comment">// 应用根组件</span></span><br><span class="line"></span><br><span class="line">ReactDOM.render(&lt;App /&gt;, <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>)); <span class="comment">// 应用挂载容器DOM</span></span><br></pre></td></tr></table></figure>
<p>这里<code>react-dom</code>是浏览器端渲染React应用的模块，通过<code>ReactDOM.render(component, mountNode)</code>可以对<code>自定义组件/原生DOM/字符串</code>进行挂载。在React16中，虽然还是通过JSX编译得到一个虚拟DOM对象，但对这些虚拟DOM对象的再加工则是发生了翻天覆地的变化。我们需要追根溯底，看它是怎么一步步转换的。我们首先找到<code>ReactDOM.render</code>，源码在<code>packages/react-dom/src/client/ReactDOM.js</code>中，有三个类似的方法：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ReactDOM: <span class="built_in">Object</span> = &#123;</span><br><span class="line">  <span class="comment">// 新API，未来代替render</span></span><br><span class="line">  hydrate(element: React$Node, container: DOMContainer, callback: ?<span class="built_in">Function</span>) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> throw or warn if we couldn't hydrate?</span></span><br><span class="line">    <span class="keyword">return</span> legacyRenderSubtreeIntoContainer(</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      element,</span><br><span class="line">      container,</span><br><span class="line">      <span class="literal">true</span>,</span><br><span class="line">      callback,</span><br><span class="line">    );</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// React15的重要API，逐渐退出舞台</span></span><br><span class="line">  render(</span><br><span class="line">    element: React$Element&lt;<span class="built_in">any</span>&gt;,  <span class="comment">// react组件对象，通常是项目根组件</span></span><br><span class="line">    container: DOMContainer, <span class="comment">// id为root的那个dom</span></span><br><span class="line">    callback: ?<span class="built_in">Function</span>, <span class="comment">// 回调函数</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> legacyRenderSubtreeIntoContainer(</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      element,</span><br><span class="line">      container,</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">      callback,</span><br><span class="line">    );</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 将组件挂载到传入的 DOM 节点上（不稳定api）</span></span><br><span class="line">  unstable_renderSubtreeIntoContainer(</span><br><span class="line">    parentComponent: React$Component&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;,</span><br><span class="line">    element: React$Element&lt;<span class="built_in">any</span>&gt;,</span><br><span class="line">    containerNode: DOMContainer,</span><br><span class="line">    callback: ?<span class="built_in">Function</span>,</span><br><span class="line">  ) &#123;</span><br><span class="line">    invariant(</span><br><span class="line">      parentComponent != <span class="literal">null</span> &amp;&amp; ReactInstanceMap.has(parentComponent),</span><br><span class="line">      <span class="string">'parentComponent must be a valid React Component'</span>,</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> legacyRenderSubtreeIntoContainer(</span><br><span class="line">      parentComponent,</span><br><span class="line">      element,</span><br><span class="line">      containerNode,</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">      callback,</span><br><span class="line">    );</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里<code>ReactDOM.render/hydrate/unstable_renderSubtreeIntoContainer/unmountComponentAtNode</code>都是<code>legacyRenderSubtreeIntoContainer</code>方法的加壳方法。因此<code>ReactDOM.render</code>实际调用了<code>legacyRenderSubtreeIntoContainer</code>，这是一个内部API。</p>
<h4 id="渲染虚拟dom树"><a href="#渲染虚拟dom树" class="headerlink" title="渲染虚拟dom树"></a>渲染虚拟dom树</h4><p><code>legacyRenderSubtreeIntoContainer</code>从字面可以看出它大致意思就是把虚拟的dom树渲染到真实的dom容器中，我们找到<code>legacyRenderSubtreeIntoContainer</code>方法，源码在<code>packages/react-dom/src/client/ReactDOM.js</code>中：<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 渲染组件的子组件树至父容器</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">legacyRenderSubtreeIntoContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parentComponent: ?React$Component&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;, <span class="comment">// 父组件 这里为 null</span></span></span></span><br><span class="line"><span class="function"><span class="params">  children: ReactNodeList, <span class="comment">// element 虚拟dom树</span></span></span></span><br><span class="line"><span class="function"><span class="params">  container: DOMContainer, <span class="comment">// html中的dom根对象</span></span></span></span><br><span class="line"><span class="function"><span class="params">  forceHydrate: <span class="built_in">boolean</span>, <span class="comment">// 服务器端渲染标识 这里为false</span></span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?<span class="built_in">Function</span>, <span class="comment">// 回调函数 这里没有</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 对 container 进行校验</span></span><br><span class="line">  invariant(</span><br><span class="line">    isValidContainer(container),</span><br><span class="line">    <span class="string">'Target container is not a DOM element.'</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="comment">// 开发模式render时进行检查并提供许多有用的警告和错误提示信息</span></span><br><span class="line">    topLevelUpdateWarnings(container);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取 root 对象</span></span><br><span class="line">  <span class="keyword">let</span> root: Root = (container._reactRootContainer: <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">if</span> (!root) &#123; <span class="comment">// 初次渲染时初始化</span></span><br><span class="line">    <span class="comment">// 创建一个 FiberRoot对象 并将它缓存到DOM容器的_reactRootContainer属性</span></span><br><span class="line">    root = container._reactRootContainer = legacyCreateRootFromDOMContainer(</span><br><span class="line">      container, <span class="comment">// ReactDOM.render(&lt;div/&gt;, container)的第二个参数，也就是一个元素节点</span></span><br><span class="line">      forceHydrate, <span class="comment">// 服务器端渲染标识 这里为false</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> originalCallback = callback;</span><br><span class="line">      callback = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> instance = DOMRenderer.getPublicRootInstance(root._internalRoot);</span><br><span class="line">        originalCallback.call(instance);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化容器相关</span></span><br><span class="line">    <span class="comment">// Initial mount should not be batched.</span></span><br><span class="line">    DOMRenderer.unbatchedUpdates(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (parentComponent != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 向真实dom中挂载虚拟dom</span></span><br><span class="line">        root.legacy_renderSubtreeIntoContainer(</span><br><span class="line">          parentComponent, <span class="comment">// 父组件</span></span><br><span class="line">          children, <span class="comment">// 虚拟dom树</span></span><br><span class="line">          callback, <span class="comment">// 回调函数</span></span><br><span class="line">        );</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        root.render(</span><br><span class="line">          children, <span class="comment">// 虚拟dom树</span></span><br><span class="line">          callback <span class="comment">// 回调函数</span></span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> originalCallback = callback;</span><br><span class="line">      callback = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> instance = DOMRenderer.getPublicRootInstance(root._internalRoot);</span><br><span class="line">        originalCallback.call(instance);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (parentComponent != <span class="literal">null</span>) &#123;</span><br><span class="line">      root.legacy_renderSubtreeIntoContainer(</span><br><span class="line">        parentComponent, <span class="comment">// 父组件</span></span><br><span class="line">        children, <span class="comment">// 虚拟dom树</span></span><br><span class="line">        callback, <span class="comment">// 回调函数</span></span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      root.render(</span><br><span class="line">        children, <span class="comment">// 虚拟dom树</span></span><br><span class="line">        callback <span class="comment">// 回调函数</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 返回根容器fiber树的根fiber实例</span></span><br><span class="line">  <span class="keyword">return</span> DOMRenderer.getPublicRootInstance(root._internalRoot);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 源码在 packages/react-reconciler/src/ReactFiberReconciler.js 中</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getPublicRootInstance</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  container: OpaqueRoot,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">React$Component</span>&lt;<span class="title">any</span>, <span class="title">any</span>&gt; | <span class="title">PublicInstance</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 获取fiber实例</span></span><br><span class="line">  <span class="keyword">const</span> containerFiber = container.current;</span><br><span class="line">  <span class="keyword">if</span> (!containerFiber.child) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">switch</span> (containerFiber.child.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> HostComponent:</span><br><span class="line">      <span class="keyword">return</span> getPublicInstance(containerFiber.child.stateNode);</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> containerFiber.child.stateNode;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由此可见，<code>legacyRenderSubtreeIntoContainer</code>主要执行了以下几个操作：<br><strong>root：</strong>由<code>legacyCreateRootFromDOMContainer</code>生成，该函数会生成一个<code>FiberRoot</code>对象挂载到真实的dom根节点上，有了这个对象，执行该对象上的一些方法可以将虚拟dom变成dom树挂载到根节点上。<br><strong>DOMRenderer.unbatchedUpdates：</strong><code>DOMRenderer.unbatchedUpdates</code>的回调执行<code>root.legacy_renderSubtreeIntoContainer</code>或<code>root.render</code>。<br><strong>root.legacy_renderSubtreeIntoContainer 和 root.render：</strong>如果有<code>parentComponent</code>，就执行<code>root.render</code>否则执行<code>root.legacy_renderSubtreeIntoContainer</code>。</p>
<h5 id="root"><a href="#root" class="headerlink" title="root"></a>root</h5><p>我们知道<code>root</code>是由<code>legacyCreateRootFromDOMContainer</code>生成的，我们找到<code>legacyCreateRootFromDOMContainer</code>函数，源码在<code>packages/react-dom/src/client/ReactDOM.js</code>中:<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">legacyCreateRootFromDOMContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  container: DOMContainer, <span class="comment">// ReactDOM.render(&lt;div/&gt;, container)的第二个参数，也就是一个元素节点</span></span></span></span><br><span class="line"><span class="function"><span class="params">  forceHydrate: <span class="built_in">boolean</span>,  <span class="comment">// 服务器端渲染标识 这里为false</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Root</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> shouldHydrate =</span><br><span class="line">    forceHydrate || shouldHydrateDueToLegacyHeuristic(container);</span><br><span class="line">  <span class="comment">// 是否需要服务器端渲染</span></span><br><span class="line">  <span class="keyword">if</span> (!shouldHydrate) &#123;</span><br><span class="line">    <span class="keyword">let</span> warned = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> rootSibling;</span><br><span class="line">    <span class="keyword">while</span> ((rootSibling = container.lastChild)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 将dom根节点清空</span></span><br><span class="line">      container.removeChild(rootSibling);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Legacy roots are not async by default.</span></span><br><span class="line">  <span class="keyword">const</span> isAsync = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ReactRoot(</span><br><span class="line">    container, <span class="comment">// ReactDOM.render(&lt;div/&gt;, container)的第二个参数，也就是一个元素节点</span></span><br><span class="line">    isAsync, <span class="comment">// 是否异步模式，默认false</span></span><br><span class="line">    shouldHydrate <span class="comment">// 服务器端渲染标识 这里为false</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们发现该函数实际上返回的是由构造函数<code>ReactRoot</code>创建的对象。其中如果在非ssr的情况下，将dom根节点清空。我们找到构造函数<code>ReactRoot</code>，源码在<code>packages\react-dom\src\client\ReactDOM.js</code>中：<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构造函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ReactRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  container: Container, <span class="comment">// ReactDOM.render(&lt;div/&gt;, container)的第二个参数，也就是一个元素节点</span></span></span></span><br><span class="line"><span class="function"><span class="params">  isAsync: <span class="built_in">boolean</span>, <span class="comment">// 是否异步模式，默认false</span></span></span></span><br><span class="line"><span class="function"><span class="params">  hydrate: <span class="built_in">boolean</span> <span class="comment">// 服务器端渲染标识 这里为false</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// FiberRoot 对象</span></span><br><span class="line">  <span class="keyword">const</span> root = DOMRenderer.createContainer(</span><br><span class="line">    container, <span class="comment">// ReactDOM.render(&lt;div/&gt;, container)的第二个参数，也就是一个元素节点</span></span><br><span class="line">    isAsync, <span class="comment">// 是否异步模式，默认false</span></span><br><span class="line">    hydrate <span class="comment">// 服务器端渲染标识 这里为false</span></span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">this</span>._internalRoot = root;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下几个是原型方法</span></span><br><span class="line"><span class="comment">// 渲染</span></span><br><span class="line">ReactRoot.prototype.render = <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  children: ReactNodeList, <span class="comment">// 虚拟dom树</span></span></span></span><br><span class="line">  callback: ?() =&gt; mixed, // 回调函数</span><br><span class="line">): Work &#123;</span><br><span class="line">  <span class="keyword">const</span> root = <span class="keyword">this</span>._internalRoot;</span><br><span class="line">  <span class="keyword">const</span> work = <span class="keyword">new</span> ReactWork();</span><br><span class="line">  callback = callback === <span class="literal">undefined</span> ? <span class="literal">null</span> : callback;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    warnOnInvalidCallback(callback, <span class="string">'render'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">    work.then(callback);</span><br><span class="line">  &#125;</span><br><span class="line">  DOMRenderer.updateContainer(</span><br><span class="line">    children, <span class="comment">// 虚拟dom树</span></span><br><span class="line">    root, <span class="comment">// FiberRoot 对象</span></span><br><span class="line">    <span class="literal">null</span>, <span class="comment">// 父组件 这里为 null</span></span><br><span class="line">    work._onCommit</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> work;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 销毁组件</span></span><br><span class="line">ReactRoot.prototype.unmount = function(callback: ?() =&gt; mixed): Work &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br><span class="line">ReactRoot.prototype.legacy_renderSubtreeIntoContainer = <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parentComponent: ?React$Component&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  children: ReactNodeList,</span></span></span><br><span class="line">  callback: ?() =&gt; mixed,</span><br><span class="line">): Work &#123;</span><br><span class="line">  <span class="keyword">const</span> root = <span class="keyword">this</span>._internalRoot;</span><br><span class="line">  <span class="keyword">const</span> work = <span class="keyword">new</span> ReactWork();</span><br><span class="line">  callback = callback === <span class="literal">undefined</span> ? <span class="literal">null</span> : callback;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    warnOnInvalidCallback(callback, <span class="string">'render'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">    work.then(callback);</span><br><span class="line">  &#125;</span><br><span class="line">  DOMRenderer.updateContainer(</span><br><span class="line">    children, <span class="comment">// 虚拟dom树</span></span><br><span class="line">    root, <span class="comment">// FiberRoot 对象</span></span><br><span class="line">    parentComponent, <span class="comment">// 父组件</span></span><br><span class="line">    work._onCommit</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> work;</span><br><span class="line">&#125;;</span><br><span class="line">ReactRoot.prototype.createBatch = <span class="function"><span class="keyword">function</span>(<span class="params"></span>): <span class="title">Batch</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>可以看出构造函数<code>ReactRoot</code>有render、unmount、legacy_renderSubtreeIntoContainer等原型方法外，同时还声明了一个和fiber相关的<code>_internalRoot</code>属性。其中<code>render</code>和<code>legacy_renderSubtreeIntoContainer</code>原型方法都会去执行<code>DOMRenderer.updateContainer</code>方法更新容器内容，唯一差别就是第三个参数一个传<code>null</code>，一个传<code>parentComponent</code>。<code>_internalRoot</code>是由<code>DOMRenderer.createContainer</code>生成的。我们找到<code>DOMRenderer.createContainer</code>，源码在<code>packages\react-reconciler\src\ReactFiberReconciler.js</code>中：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  containerInfo: Container, <span class="regexp">//</span> ReactDOM.render(&lt;div<span class="regexp">/&gt;, container)的第二个参数，也就是一个元素节点</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">  isAsync: boolean, /</span><span class="regexp">/ 是否异步模式，默认false</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">  hydrate: boolean, /</span><span class="regexp">/ 服务器端渲染标识 这里为false</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">): OpaqueRoot &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">  return createFiberRoot(</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    containerInfo, /</span><span class="regexp">/ ReactDOM.render(&lt;div/</span>&gt;, container</span>)的第二个参数，也就是一个元素节点</span></span><br><span class="line"><span class="function">    <span class="title">isAsync</span>, // 是否异步模式，默认<span class="title">false</span></span></span><br><span class="line"><span class="function">    <span class="title">hydrate</span> // 服务器端渲染标识 这里为<span class="title">false</span></span></span><br><span class="line"><span class="function">  );</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>接下来我们看看<code>createFiberRoot</code>是怎么将一个真实DOM变成一个Fiber对象，我们找到<code>createFiberRoot</code>，源码在 packages\react-reconciler\src\ReactFiberReconciler.js 中：<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createFiberRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  containerInfo: <span class="built_in">any</span>, <span class="comment">// ReactDOM.render(&lt;div/&gt;, container)的第二个参数，也就是一个元素节点</span></span></span></span><br><span class="line"><span class="function"><span class="params">  isAsync: <span class="built_in">boolean</span>, <span class="comment">// 是否异步模式，默认false</span></span></span></span><br><span class="line"><span class="function"><span class="params">  hydrate: <span class="built_in">boolean</span>, <span class="comment">// 服务器端渲染标识 这里为false</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">FiberRoot</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 创建初始根组件对应的fiber实例</span></span><br><span class="line">  <span class="keyword">const</span> uninitializedFiber = createHostRootFiber(isAsync);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> root;</span><br><span class="line">  <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">    root = (&#123;</span><br><span class="line">      current: uninitializedFiber,</span><br><span class="line">      containerInfo: containerInfo,</span><br><span class="line">      pendingChildren: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">      earliestPendingTime: NoWork,</span><br><span class="line">      latestPendingTime: NoWork,</span><br><span class="line">      earliestSuspendedTime: NoWork,</span><br><span class="line">      latestSuspendedTime: NoWork,</span><br><span class="line">      latestPingedTime: NoWork,</span><br><span class="line"></span><br><span class="line">      didError: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      pendingCommitExpirationTime: NoWork,</span><br><span class="line">      finishedWork: <span class="literal">null</span>,</span><br><span class="line">      timeoutHandle: noTimeout,</span><br><span class="line">      context: <span class="literal">null</span>,</span><br><span class="line">      pendingContext: <span class="literal">null</span>,</span><br><span class="line">      hydrate,</span><br><span class="line">      nextExpirationTimeToWorkOn: NoWork,</span><br><span class="line">      expirationTime: NoWork,</span><br><span class="line">      firstBatch: <span class="literal">null</span>,</span><br><span class="line">      nextScheduledRoot: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">      interactionThreadID: unstable_getThreadID(),</span><br><span class="line">      memoizedInteractions: <span class="keyword">new</span> Set(),</span><br><span class="line">      pendingInteractionMap: <span class="keyword">new</span> Map(),</span><br><span class="line">    &#125;: FiberRoot);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    root = (&#123;</span><br><span class="line">      current: uninitializedFiber,</span><br><span class="line">      containerInfo: containerInfo,</span><br><span class="line">      pendingChildren: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">      earliestPendingTime: NoWork,</span><br><span class="line">      latestPendingTime: NoWork,</span><br><span class="line">      earliestSuspendedTime: NoWork,</span><br><span class="line">      latestSuspendedTime: NoWork,</span><br><span class="line">      latestPingedTime: NoWork,</span><br><span class="line"></span><br><span class="line">      didError: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      pendingCommitExpirationTime: NoWork,</span><br><span class="line">      finishedWork: <span class="literal">null</span>,</span><br><span class="line">      timeoutHandle: noTimeout,</span><br><span class="line">      context: <span class="literal">null</span>,</span><br><span class="line">      pendingContext: <span class="literal">null</span>,</span><br><span class="line">      hydrate,</span><br><span class="line">      nextExpirationTimeToWorkOn: NoWork,</span><br><span class="line">      expirationTime: NoWork,</span><br><span class="line">      firstBatch: <span class="literal">null</span>,</span><br><span class="line">      nextScheduledRoot: <span class="literal">null</span>,</span><br><span class="line">    &#125;: BaseFiberRootProperties);</span><br><span class="line">  &#125;</span><br><span class="line">  uninitializedFiber.stateNode = root;</span><br><span class="line">  <span class="keyword">return</span> ((root: <span class="built_in">any</span>): FiberRoot);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 源码在 packages\react-reconciler\src\ReactFiber.js 中</span></span><br><span class="line"><span class="comment">// 返回一个初始根组件对应的fiber实例</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createHostRootFiber</span>(<span class="params">isAsync: <span class="built_in">boolean</span></span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> mode = isAsync ? AsyncMode | StrictMode : NoContext;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; isDevToolsPresent) &#123;</span><br><span class="line">    <span class="comment">// Always collect profile timings when DevTools are present.</span></span><br><span class="line">    <span class="comment">// This enables DevTools to start capturing timing at any point–</span></span><br><span class="line">    <span class="comment">// Without some nodes in the tree having empty base times.</span></span><br><span class="line">    mode |= ProfileMode;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建 Fiber 实例</span></span><br><span class="line">  <span class="keyword">return</span> createFiber(</span><br><span class="line">    HostRoot, <span class="comment">// 组件树根组件，可以嵌套</span></span><br><span class="line">    <span class="literal">null</span>, </span><br><span class="line">    <span class="literal">null</span>, </span><br><span class="line">    mode</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 源码在 packages\react-reconciler\src\ReactFiber.js 中</span></span><br><span class="line"><span class="comment">// 创建 Fiber 实例</span></span><br><span class="line"><span class="keyword">const</span> createFiber = <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  tag: WorkTag, <span class="comment">// 标记 fiber 类型</span></span></span></span><br><span class="line"><span class="function"><span class="params">  pendingProps: mixed, <span class="comment">// 当前处理过程中的组件props对象</span></span></span></span><br><span class="line"><span class="function"><span class="params">  key: <span class="literal">null</span> | <span class="built_in">string</span>, <span class="comment">// 调和阶段，标识fiber，以检测是否可重用该fiber实例</span></span></span></span><br><span class="line"><span class="function"><span class="params">  mode: TypeOfMode,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="comment">// $FlowFixMe: the shapes are exact here but Flow doesn't like constructors</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> FiberNode(tag, pendingProps, key, mode);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 源码在 packages\react-reconciler\src\ReactFiber.js 中</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">FiberNode</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  tag: WorkTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  pendingProps: mixed,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: <span class="literal">null</span> | <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  mode: TypeOfMode,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Instance</span></span><br><span class="line">  <span class="keyword">this</span>.tag = tag;</span><br><span class="line">  <span class="keyword">this</span>.key = key;</span><br><span class="line">  <span class="keyword">this</span>.type = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.stateNode = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Fiber</span></span><br><span class="line">  <span class="keyword">this</span>.return = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.child = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.sibling = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.ref = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.pendingProps = pendingProps;</span><br><span class="line">  <span class="keyword">this</span>.memoizedProps = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.updateQueue = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.memoizedState = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.firstContextDependency = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.mode = mode;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Effects</span></span><br><span class="line">  <span class="keyword">this</span>.effectTag = NoEffect;</span><br><span class="line">  <span class="keyword">this</span>.nextEffect = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.firstEffect = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.lastEffect = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.expirationTime = NoWork;</span><br><span class="line">  <span class="keyword">this</span>.childExpirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.alternate = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">    <span class="keyword">this</span>.actualDuration = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.actualStartTime = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">this</span>.selfBaseDuration = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.treeBaseDuration = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="keyword">this</span>._debugID = debugCounter++;</span><br><span class="line">    <span class="keyword">this</span>._debugSource = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>._debugOwner = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>._debugIsCurrentlyTiming = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (!hasBadMapPolyfill &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">Object</span>.preventExtensions === <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="built_in">Object</span>.preventExtensions(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由此可知，<code>react-dom</code>渲染模块调用<code>createContainer</code>创建容器、根fiber实例、FiberRoot对象等。所有<code>Fiber</code>对象都是<code>FiberNode</code>的实例，它有许多种类型，通过tag来标识，其中内部有很多方法来生成Fiber对象：</p>
<ul>
<li>createFiberFromElement：type为类，无状态函数，元素标签名</li>
<li>createFiberFromFragment：type为React.Fragment</li>
<li>createFiberFromText：在JSX中表现为字符串，数字</li>
<li>createFiberFromPortal：用于 createPortal</li>
<li>createFiberRoot：用于ReactDOM.render的根节点</li>
</ul>
<p>这里<code>createFiberRoot</code>就是创建了一个普通对象，里面<code>current</code>属性引用<code>fiber</code>对象，<code>containerInfo</code>属性引用<code>ReactDOM.render(&lt;div/&gt;, container)</code>的第二个参数，也就是一个元素节点，然后<code>fiber</code>对象的<code>stateNode</code>引用普通对象<code>root</code>。在React15中，<code>stateNode</code>应该是一个组件实例或真实DOM，最后返回普通对象<code>stateNode</code>。现在我们回顾下调用<code>reactDOM.render</code>传入的<code>container</code>，在执行过程中附加了哪些有用的东西：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">container = &#123; <span class="comment">// 就是我们传入的那个真实dom</span></span><br><span class="line">  _reactRootContainer: &#123; <span class="comment">// legacyCreateRootFromDOMContainer</span></span><br><span class="line">    _internalRoot: &#123; <span class="comment">// DOMRenderer.createContainer</span></span><br><span class="line">      current:&#123;&#125;  <span class="comment">// new FiberNode</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="unbatchedUpdates"><a href="#unbatchedUpdates" class="headerlink" title="unbatchedUpdates"></a>unbatchedUpdates</h5><p>我们找到<code>DOMRenderer.unbatchedUpdates</code>，源码在<code>packages\react-reconciler\src\ReactFiberScheduler.js</code>中：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 正在批量更新标识</span></span><br><span class="line"><span class="keyword">let</span> isBatchingUpdates: boolean = <span class="literal">false</span>;</span><br><span class="line"><span class="comment">// 未批量更新标识</span></span><br><span class="line"><span class="keyword">let</span> isUnbatchingUpdates: boolean = <span class="literal">false</span>;</span><br><span class="line"><span class="comment">// 非批量更新操作</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unbatchedUpdates</span>&lt;<span class="title">A</span>, <span class="title">R</span>&gt;(<span class="params">fn: (a: A</span>) =&gt; <span class="title">R</span>, <span class="title">a</span>: <span class="title">A</span>): <span class="title">R</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 如果正在批量更新</span></span><br><span class="line">  <span class="keyword">if</span> (isBatchingUpdates &amp;&amp; !isUnbatchingUpdates) &#123;</span><br><span class="line">    <span class="comment">// 未批量更新设为true</span></span><br><span class="line">    isUnbatchingUpdates = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 运行入参函数且返回执行结果</span></span><br><span class="line">      <span class="keyword">return</span> fn(a);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// 仍旧将未批量更新设为false</span></span><br><span class="line">      isUnbatchingUpdates = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 不管是否在批量更新流程中，都执行入参函数</span></span><br><span class="line">  <span class="keyword">return</span> fn(a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由此可知<code>unbatchedUpdates</code>无论如何都会执行入参函数，其中<code>isBatchingUpdates</code>和<code>isUnbatchingUpdates</code>初始值都是false。<code>DOMRenderer.unbatchedUpdates</code>的回调执行<code>root.legacy_renderSubtreeIntoContainer</code>或<code>root.render</code>。</p>
<h4 id="更新容器内容"><a href="#更新容器内容" class="headerlink" title="更新容器内容"></a>更新容器内容</h4><p>从<code>legacyRenderSubtreeIntoContainer</code>函数里可以看出，无论怎样判断，最终都会到<code>root.legacy_renderSubtreeIntoContainer</code>和<code>root.render</code>两个方法，而这两个方法的核心就是<code>DOMRenderer.updateContainer</code>，无非就是传不传父组件这点区别。我们找到<code>DOMRenderer.updateContainer</code>，源码在<code>packages\react-reconciler\src\ReactFiberReconciler.js</code>中：<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">updateContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  element: ReactNodeList, <span class="comment">// ReactDOM.render函数的第一个参数，泛指各种虚拟DOM</span></span></span></span><br><span class="line"><span class="function"><span class="params">  container: OpaqueRoot, <span class="comment">// ReactDOM.render函数的第二个参数，也就是一个元素节点</span></span></span></span><br><span class="line"><span class="function"><span class="params">  parentComponent: ?React$Component&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;, <span class="comment">// parentComponent为之前的根组件，现在它为null</span></span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?<span class="built_in">Function</span>, <span class="comment">// 回调函数</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">ExpirationTime</span> </span>&#123;</span><br><span class="line">  <span class="comment">// createFiberRoot中创建的fiber对象</span></span><br><span class="line">  <span class="keyword">const</span> current = container.current;</span><br><span class="line">  <span class="keyword">const</span> currentTime = requestCurrentTime();</span><br><span class="line">  <span class="comment">// 获取任务到期时间</span></span><br><span class="line">  <span class="keyword">const</span> expirationTime = computeExpirationForFiber(currentTime, current);</span><br><span class="line">  <span class="keyword">return</span> updateContainerAtExpirationTime(</span><br><span class="line">    element, <span class="comment">// ReactDOM.render函数的第一个参数，泛指各种虚拟DOM</span></span><br><span class="line">    container, <span class="comment">// ReactDOM.render函数的第二个参数，也就是一个元素节点</span></span><br><span class="line">    parentComponent, <span class="comment">// 父组件</span></span><br><span class="line">    expirationTime, <span class="comment">// 任务到期时间</span></span><br><span class="line">    callback, <span class="comment">// 回调函数</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 源码在 packages\react-reconciler\src\ReactFiberScheduler.js 中</span></span><br><span class="line"><span class="comment">// 计算fiber的到期时间</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">computeExpirationForFiber</span>(<span class="params">currentTime: ExpirationTime, fiber: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> expirationTime;</span><br><span class="line">  <span class="keyword">if</span> (expirationContext !== NoWork) &#123;</span><br><span class="line">    <span class="comment">// 显示设置过期上下文</span></span><br><span class="line">    expirationTime = expirationContext;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isWorking) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isCommitting) &#123;</span><br><span class="line">      <span class="comment">// 在提交阶段的更新任务</span></span><br><span class="line">      <span class="comment">// 需要明确设置同步优先级（Sync Priority）</span></span><br><span class="line">      expirationTime = Sync;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 在渲染阶段发生的更新任务</span></span><br><span class="line">      <span class="comment">// 需要设置为下一次渲染时间的到期时间优先级</span></span><br><span class="line">      expirationTime = nextRenderExpirationTime;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 不在任务执行阶段，需要计算新的过期时间</span></span><br><span class="line">    <span class="keyword">if</span> (fiber.mode &amp; AsyncMode) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isBatchingInteractiveUpdates) &#123;</span><br><span class="line">        <span class="comment">// This is an interactive update</span></span><br><span class="line">        expirationTime = computeInteractiveExpiration(currentTime);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 异步更新</span></span><br><span class="line">        expirationTime = computeAsyncExpiration(currentTime);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 如果我们正处于渲染树的中间, 请不要在已经呈现的相同过期时间内更新。</span></span><br><span class="line">      <span class="keyword">if</span> (nextRoot !== <span class="literal">null</span> &amp;&amp; expirationTime === nextRenderExpirationTime) &#123;</span><br><span class="line">        expirationTime += <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 同步更新</span></span><br><span class="line">      expirationTime = Sync;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isBatchingInteractiveUpdates) &#123;</span><br><span class="line">    <span class="comment">// This is an interactive update. Keep track of the lowest pending</span></span><br><span class="line">    <span class="comment">// interactive expiration time. This allows us to synchronously flush</span></span><br><span class="line">    <span class="comment">// all interactive updates when needed.</span></span><br><span class="line">    <span class="keyword">if</span> (expirationTime &gt; lowestPriorityPendingInteractiveExpirationTime) &#123;</span><br><span class="line">      lowestPriorityPendingInteractiveExpirationTime = expirationTime;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> expirationTime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据渲染优先级更新dom</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">updateContainerAtExpirationTime</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  element: ReactNodeList, <span class="comment">// ReactDOM.render函数的第一个参数，泛指各种虚拟DOM</span></span></span></span><br><span class="line"><span class="function"><span class="params">  container: OpaqueRoot, <span class="comment">// ReactDOM.render函数的第二个参数，也就是一个元素节点</span></span></span></span><br><span class="line"><span class="function"><span class="params">  parentComponent: ?React$Component&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;,   <span class="comment">// parentComponent为之前的根组件，现在它为null</span></span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime, <span class="comment">// 期望的任务到期时间</span></span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?<span class="built_in">Function</span>, <span class="comment">// 回调函数</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> If this is a nested container, this won't be the root.</span></span><br><span class="line">  <span class="comment">// 引用fiber对象</span></span><br><span class="line">  <span class="keyword">const</span> current = container.current;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获得上下文对象</span></span><br><span class="line">  <span class="keyword">const</span> context = getContextForSubtree(parentComponent);</span><br><span class="line">  <span class="keyword">if</span> (container.context === <span class="literal">null</span>) &#123;</span><br><span class="line">    container.context = context;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    container.pendingContext = context;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 下一步：schedule:安排, Root: 根, Update:更新</span></span><br><span class="line">  <span class="keyword">return</span> scheduleRootUpdate(</span><br><span class="line">    current, <span class="comment">// fiber对象</span></span><br><span class="line">    element, <span class="comment">// ReactDOM.render函数的第一个参数，泛指各种虚拟DOM</span></span><br><span class="line">    expirationTime, <span class="comment">// 期望的任务到期时间</span></span><br><span class="line">    callback <span class="comment">// 回调函数</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 源码在 packages\react-reconciler\src\ReactFiberReconciler.js 中</span></span><br><span class="line"><span class="comment">// 获得上下文对象</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getContextForSubtree</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parentComponent: ?React$Component&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Object</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!parentComponent) &#123;</span><br><span class="line">    <span class="keyword">return</span> emptyContextObject;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> fiber = ReactInstanceMap.get(parentComponent);</span><br><span class="line">  <span class="keyword">const</span> parentContext = findCurrentUnmaskedContext(fiber);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fiber.tag === ClassComponent) &#123;</span><br><span class="line">    <span class="keyword">const</span> Component = fiber.type;</span><br><span class="line">    <span class="keyword">if</span> (isLegacyContextProvider(Component)) &#123;</span><br><span class="line">      <span class="keyword">return</span> processChildContext(fiber, Component, parentContext);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fiber.tag === ClassComponentLazy) &#123;</span><br><span class="line">    <span class="keyword">const</span> Component = getResultFromResolvedThenable(fiber.type);</span><br><span class="line">    <span class="keyword">if</span> (isLegacyContextProvider(Component)) &#123;</span><br><span class="line">      <span class="keyword">return</span> processChildContext(fiber, Component, parentContext);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> parentContext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>updateContainer</code>的源码很简单，通过<code>computeExpirationForFiber</code>获得计算优先级，然后丢给<code>updateContainerAtExpirationTime</code>，这里<code>updateContainerAtExpirationTime</code>其实相当于什么都没做，通过<code>getContextForSubtree</code>（这里<code>getContextForSubtree</code>因为一开始<code>parentComponent</code>是不存在的，于是返回一个空对象。注意，这个空对象可以重复使用，不用每次返回一个新的空对象，这是一个很好的优化）获得上下文对象，然后分配给<code>container.context</code>或<code>container.pendingContext</code>，最后一起丢给<code>scheduleRootUpdate</code>。</p>
<h4 id="开始更新"><a href="#开始更新" class="headerlink" title="开始更新"></a>开始更新</h4><p>我们找到<code>scheduleRootUpdate</code>，源码在<code>packages/react-reconciler/src/ReactFiberReconciler.js</code>中：<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 进行根节点更新</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">scheduleRootUpdate</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber, <span class="comment">// 引用fiber对象</span></span></span></span><br><span class="line"><span class="function"><span class="params">  element: ReactNodeList, <span class="comment">// 虚拟dom树</span></span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime, <span class="comment">// 任务到期时间</span></span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?<span class="built_in">Function</span>, <span class="comment">// 回调函数</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 返回一个包含以上属性的update对象</span></span><br><span class="line">  <span class="keyword">const</span> update = createUpdate(expirationTime);</span><br><span class="line">  <span class="comment">// Caution: React DevTools currently depends on this property</span></span><br><span class="line">  <span class="comment">// being called "element".</span></span><br><span class="line">  <span class="comment">// 将虚拟dom树放入payload </span></span><br><span class="line">  update.payload = &#123;element&#125;;</span><br><span class="line"></span><br><span class="line">  callback = callback === <span class="literal">undefined</span> ? <span class="literal">null</span> : callback;</span><br><span class="line">  <span class="keyword">if</span> (callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">    warningWithoutStack(</span><br><span class="line">      <span class="keyword">typeof</span> callback === <span class="string">'function'</span>,</span><br><span class="line">      <span class="string">'render(...): Expected the last optional `callback` argument to be a '</span> +</span><br><span class="line">        <span class="string">'function. Instead received: %s.'</span>,</span><br><span class="line">      callback,</span><br><span class="line">    );</span><br><span class="line">    update.callback = callback;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 开始队列更新</span></span><br><span class="line">  enqueueUpdate(current, update); </span><br><span class="line">  <span class="comment">// 调用调度器API：scheduleWork(...)来调度fiber任务</span></span><br><span class="line">  scheduleWork(</span><br><span class="line">    current, <span class="comment">// fiber实例</span></span><br><span class="line">    expirationTime <span class="comment">// 任务到期时间</span></span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> expirationTime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个包含以上属性的update对象</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createUpdate</span>(<span class="params">expirationTime: ExpirationTime</span>): <span class="title">Update</span>&lt;*&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    expirationTime: expirationTime,</span><br><span class="line"></span><br><span class="line">    tag: UpdateState,</span><br><span class="line">    payload: <span class="literal">null</span>,</span><br><span class="line">    callback: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    next: <span class="literal">null</span>,</span><br><span class="line">    nextEffect: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>scheduleRootUpdate</code>是将用户的传参封装成一个<code>update</code>对象, 其中<code>update</code>对象有<code>payload</code>对象，它就是相当于React15中 的setState的第一个state传参，但现在<code>payload</code>中把<code>children</code>也放进去了。然后添加更新任务至fiber：<code>enqueueUpdate(...)</code>，现在我们找到<code>enqueueUpdate</code>，源码在<code>packages/react-reconciler/src/ReactUpdateQueue.js</code>中：<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">enqueueUpdate</span>&lt;<span class="title">State</span>&gt;(<span class="params">fiber: Fiber, update: Update&lt;State&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// alternate 主要用来保存更新过程中各版本更新队列，方便崩溃或冲突时回退</span></span><br><span class="line">  <span class="keyword">const</span> alternate = fiber.alternate;</span><br><span class="line">  <span class="comment">// 创建两个独立的更新队列</span></span><br><span class="line">  <span class="keyword">let</span> queue1;</span><br><span class="line">  <span class="keyword">let</span> queue2;</span><br><span class="line">  <span class="keyword">if</span> (alternate === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 只存在一个 fiber</span></span><br><span class="line">    queue1 = fiber.updateQueue;</span><br><span class="line">    queue2 = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (queue1 === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果不存在，则创建一个更新队列</span></span><br><span class="line">      queue1 = fiber.updateQueue = createUpdateQueue(fiber.memoizedState);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 两个所有者</span></span><br><span class="line">    queue1 = fiber.updateQueue;</span><br><span class="line">    queue2 = alternate.updateQueue;</span><br><span class="line">    <span class="keyword">if</span> (queue1 === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (queue2 === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果两个都不存在，则创建两个新的</span></span><br><span class="line">        queue1 = fiber.updateQueue = createUpdateQueue(fiber.memoizedState);</span><br><span class="line">        queue2 = alternate.updateQueue = createUpdateQueue(</span><br><span class="line">          alternate.memoizedState,</span><br><span class="line">        );</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// queue1 不存在，queue2 存在，queue1 根据 queue2 创建</span></span><br><span class="line">        queue1 = fiber.updateQueue = cloneUpdateQueue(queue2);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (queue2 === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// queue2 不存在，queue1 存在，queue2 根据 queue1 创建</span></span><br><span class="line">        queue2 = alternate.updateQueue = cloneUpdateQueue(queue1);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 全都有</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (queue2 === <span class="literal">null</span> || queue1 === queue2) &#123;</span><br><span class="line">    <span class="comment">// 只存在一个更新队列</span></span><br><span class="line">    appendUpdateToQueue(queue1, update);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果任意更新队列为空，则需要将更新添加至两个更新队列</span></span><br><span class="line">    <span class="keyword">if</span> (queue1.lastUpdate === <span class="literal">null</span> || queue2.lastUpdate === <span class="literal">null</span>) &#123;</span><br><span class="line">      appendUpdateToQueue(queue1, update);</span><br><span class="line">      appendUpdateToQueue(queue2, update);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 如果2个更新队列均非空，则添加更新至第一个队列，并更新另一个队列的尾部更新项</span></span><br><span class="line">      appendUpdateToQueue(queue1, update);</span><br><span class="line">      queue2.lastUpdate = update;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      (fiber.tag === ClassComponent || fiber.tag === ClassComponentLazy) &amp;&amp;</span><br><span class="line">      (currentlyProcessingQueue === queue1 ||</span><br><span class="line">        (queue2 !== <span class="literal">null</span> &amp;&amp; currentlyProcessingQueue === queue2)) &amp;&amp;</span><br><span class="line">      !didWarnUpdateInsideUpdate</span><br><span class="line">    ) &#123;</span><br><span class="line">      warningWithoutStack(</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        <span class="string">'An update (setState, replaceState, or forceUpdate) was scheduled '</span> +</span><br><span class="line">          <span class="string">'from inside an update function. Update functions should be pure, '</span> +</span><br><span class="line">          <span class="string">'with zero side-effects. Consider using componentDidUpdate or a '</span> +</span><br><span class="line">          <span class="string">'callback.'</span>,</span><br><span class="line">      );</span><br><span class="line">      didWarnUpdateInsideUpdate = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个更新队列</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createUpdateQueue</span>&lt;<span class="title">State</span>&gt;(<span class="params">baseState: State</span>): <span class="title">UpdateQueue</span>&lt;<span class="title">State</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> queue: UpdateQueue&lt;State&gt; = &#123;</span><br><span class="line">    baseState,</span><br><span class="line">    firstUpdate: <span class="literal">null</span>,</span><br><span class="line">    lastUpdate: <span class="literal">null</span>,</span><br><span class="line">    firstCapturedUpdate: <span class="literal">null</span>,</span><br><span class="line">    lastCapturedUpdate: <span class="literal">null</span>,</span><br><span class="line">    firstEffect: <span class="literal">null</span>,</span><br><span class="line">    lastEffect: <span class="literal">null</span>,</span><br><span class="line">    firstCapturedEffect: <span class="literal">null</span>,</span><br><span class="line">    lastCapturedEffect: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// clone 一个更新队列</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cloneUpdateQueue</span>&lt;<span class="title">State</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  currentQueue: UpdateQueue&lt;State&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">UpdateQueue</span>&lt;<span class="title">State</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> queue: UpdateQueue&lt;State&gt; = &#123;</span><br><span class="line">    baseState: currentQueue.baseState,</span><br><span class="line">    firstUpdate: currentQueue.firstUpdate,</span><br><span class="line">    lastUpdate: currentQueue.lastUpdate,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> With resuming, if we bail out and resuse the child tree, we should</span></span><br><span class="line">    <span class="comment">// keep these effects.</span></span><br><span class="line">    firstCapturedUpdate: <span class="literal">null</span>,</span><br><span class="line">    lastCapturedUpdate: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    firstEffect: <span class="literal">null</span>,</span><br><span class="line">    lastEffect: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    firstCapturedEffect: <span class="literal">null</span>,</span><br><span class="line">    lastCapturedEffect: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新队列</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">appendUpdateToQueue</span>&lt;<span class="title">State</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  queue: UpdateQueue&lt;State&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  update: Update&lt;State&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Append the update to the end of the list.</span></span><br><span class="line">  <span class="keyword">if</span> (queue.lastUpdate === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Queue is empty</span></span><br><span class="line">    queue.firstUpdate = queue.lastUpdate = update;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    queue.lastUpdate.next = update;</span><br><span class="line">    queue.lastUpdate = update;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里<code>enqueueUpdate</code>是一个链表，然后根据<code>fiber</code>的状态创建一个或两个列队对象，再接下来调用调度器API：<code>scheduleWork(...)</code>来调度fiber任务，现在我们看一下如何处理更新的。</p>
<h4 id="处理更新"><a href="#处理更新" class="headerlink" title="处理更新"></a>处理更新</h4><p>我们找到<code>scheduleWork</code>，源码在<code>packages/react-reconciler/src/ReactFiberScheduler.js</code>中：<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">scheduleWork</span>(<span class="params">fiber: Fiber, expirationTime: ExpirationTime</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 记录调度器的执行状态</span></span><br><span class="line">  recordScheduleUpdate();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="keyword">if</span> (fiber.tag === ClassComponent || fiber.tag === ClassComponentLazy) &#123;</span><br><span class="line">      <span class="keyword">const</span> instance = fiber.stateNode;</span><br><span class="line">      warnAboutInvalidUpdates(instance);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> root = scheduleWorkToRoot(fiber, expirationTime);</span><br><span class="line">  <span class="keyword">if</span> (root === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      __DEV__ &amp;&amp;</span><br><span class="line">      (fiber.tag === ClassComponent || fiber.tag === ClassComponentLazy)</span><br><span class="line">    ) &#123;</span><br><span class="line">      warnAboutUpdateOnUnmounted(fiber);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">    <span class="keyword">const</span> interactions = __interactionsRef.current;</span><br><span class="line">    <span class="keyword">if</span> (interactions.size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> pendingInteractionMap = root.pendingInteractionMap;</span><br><span class="line">      <span class="keyword">const</span> pendingInteractions = pendingInteractionMap.get(expirationTime);</span><br><span class="line">      <span class="keyword">if</span> (pendingInteractions != <span class="literal">null</span>) &#123;</span><br><span class="line">        interactions.forEach(<span class="function"><span class="params">interaction</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (!pendingInteractions.has(interaction)) &#123;</span><br><span class="line">            <span class="comment">// Update the pending async work count for previously unscheduled interaction.</span></span><br><span class="line">            interaction.__count++;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          pendingInteractions.add(interaction);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pendingInteractionMap.set(expirationTime, <span class="keyword">new</span> Set(interactions));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update the pending async work count for the current interactions.</span></span><br><span class="line">        interactions.forEach(<span class="function"><span class="params">interaction</span> =&gt;</span> &#123;</span><br><span class="line">          interaction.__count++;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> subscriber = __subscriberRef.current;</span><br><span class="line">      <span class="keyword">if</span> (subscriber !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> threadID = computeThreadID(</span><br><span class="line">          expirationTime,</span><br><span class="line">          root.interactionThreadID,</span><br><span class="line">        );</span><br><span class="line">        subscriber.onWorkScheduled(interactions, threadID);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    !isWorking &amp;&amp;</span><br><span class="line">    nextRenderExpirationTime !== NoWork &amp;&amp;</span><br><span class="line">    expirationTime &lt; nextRenderExpirationTime</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// This is an interruption. (Used for performance tracking.)</span></span><br><span class="line">    interruptedBy = fiber;</span><br><span class="line">    resetStack();</span><br><span class="line">  &#125;</span><br><span class="line">  markPendingPriorityLevel(root, expirationTime);</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="comment">// If we're in the render phase, we don't need to schedule this root</span></span><br><span class="line">    <span class="comment">// for an update, because we'll do it before we exit...</span></span><br><span class="line">    !isWorking ||</span><br><span class="line">    isCommitting ||</span><br><span class="line">    <span class="comment">// ...unless this is a different root than the one we're rendering.</span></span><br><span class="line">    nextRoot !== root</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">const</span> rootExpirationTime = root.expirationTime;</span><br><span class="line">    requestWork(root, rootExpirationTime);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (nestedUpdateCount &gt; NESTED_UPDATE_LIMIT) &#123;</span><br><span class="line">    <span class="comment">// Reset this back to zero so subsequent updates don't throw.</span></span><br><span class="line">    nestedUpdateCount = <span class="number">0</span>;</span><br><span class="line">    invariant(</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">      <span class="string">'Maximum update depth exceeded. This can happen when a '</span> +</span><br><span class="line">        <span class="string">'component repeatedly calls setState inside '</span> +</span><br><span class="line">        <span class="string">'componentWillUpdate or componentDidUpdate. React limits '</span> +</span><br><span class="line">        <span class="string">'the number of nested updates to prevent infinite loops.'</span>,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">scheduleWorkToRoot</span>(<span class="params">fiber: Fiber, expirationTime</span>): <span class="title">FiberRoot</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 更新 fiber实例的过期时间</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    fiber.expirationTime === NoWork ||</span><br><span class="line">    fiber.expirationTime &gt; expirationTime</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// 若fiber实例到期时间大于期望的任务到期时间，则更新fiber到期时间</span></span><br><span class="line">    fiber.expirationTime = expirationTime;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> alternate = fiber.alternate;</span><br><span class="line">  <span class="comment">// 同时更新alternate fiber的到期时间</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    alternate !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    (alternate.expirationTime === NoWork ||</span><br><span class="line">      alternate.expirationTime &gt; expirationTime)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// 若alternate fiber到期时间大于期望的任务到期时间，则更新fiber到期时间</span></span><br><span class="line">    alternate.expirationTime = expirationTime;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> node = fiber.return;</span><br><span class="line">  <span class="comment">// fiber.return 为空，说明到达组件树顶部</span></span><br><span class="line">  <span class="keyword">if</span> (node === <span class="literal">null</span> &amp;&amp; fiber.tag === HostRoot) &#123;</span><br><span class="line">    <span class="comment">// 确保是组件树根组件并获取FiberRoot实例</span></span><br><span class="line">    <span class="keyword">return</span> fiber.stateNode;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (node !== <span class="literal">null</span>) &#123;</span><br><span class="line">    alternate = node.alternate;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      node.childExpirationTime === NoWork ||</span><br><span class="line">      node.childExpirationTime &gt; expirationTime</span><br><span class="line">    ) &#123;</span><br><span class="line">      node.childExpirationTime = expirationTime;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        alternate !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        (alternate.childExpirationTime === NoWork ||</span><br><span class="line">          alternate.childExpirationTime &gt; expirationTime)</span><br><span class="line">      ) &#123;</span><br><span class="line">        alternate.childExpirationTime = expirationTime;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      alternate !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">      (alternate.childExpirationTime === NoWork ||</span><br><span class="line">        alternate.childExpirationTime &gt; expirationTime)</span><br><span class="line">    ) &#123;</span><br><span class="line">      alternate.childExpirationTime = expirationTime;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (node.return === <span class="literal">null</span> &amp;&amp; node.tag === HostRoot) &#123;</span><br><span class="line">      <span class="keyword">return</span> node.stateNode;</span><br><span class="line">    &#125;</span><br><span class="line">    node = node.return;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里<code>scheduleWork</code>主要进行虚拟DOM（fiber树）的更新。<code>scheduleWork</code>的最开头有一个<code>recordScheduleUpdate</code>方法，我们找到<code>recordScheduleUpdate</code>，源码在<code>packages\react-reconciler\src\ReactDebugFiberPerf.js</code>中：<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">recordScheduleUpdate</span>(<span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (enableUserTimingAPI) &#123; <span class="comment">// 全局变量，默认为true</span></span><br><span class="line">    <span class="keyword">if</span> (isCommitting) &#123; <span class="comment">// 全局变量，默认为false, 没有进入分支</span></span><br><span class="line">      hasScheduledUpdateInCurrentCommit = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 全局变量，默认为null，没有没有进入分支</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      currentPhase !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">      currentPhase !== <span class="string">'componentWillMount'</span> &amp;&amp;</span><br><span class="line">      currentPhase !== <span class="string">'componentWillReceiveProps'</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      hasScheduledUpdateInCurrentPhase = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>recordScheduleUpdate</code>主要用来记录调度器的执行状态，如注释所示，它现在相当于什么都没有做。</p>
<h5 id="requestWork"><a href="#requestWork" class="headerlink" title="requestWork"></a>requestWork</h5><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">requestWork</span>(<span class="params">root: FiberRoot, expirationTime: ExpirationTime</span>) </span>&#123;</span><br><span class="line">  addRootToSchedule(root, expirationTime);</span><br><span class="line">  <span class="keyword">if</span> (isRendering) &#123;</span><br><span class="line">    <span class="comment">// Prevent reentrancy. Remaining work will be scheduled at the end of</span></span><br><span class="line">    <span class="comment">// the currently rendering batch.</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isBatchingUpdates) &#123;</span><br><span class="line">    <span class="comment">// Flush work at the end of the batch.</span></span><br><span class="line">    <span class="keyword">if</span> (isUnbatchingUpdates) &#123;</span><br><span class="line">      <span class="comment">// ...unless we're inside unbatchedUpdates, in which case we should</span></span><br><span class="line">      <span class="comment">// flush it now.</span></span><br><span class="line">      nextFlushedRoot = root;</span><br><span class="line">      nextFlushedExpirationTime = Sync;</span><br><span class="line">      performWorkOnRoot(root, Sync, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Get rid of Sync and use current time?</span></span><br><span class="line">  <span class="keyword">if</span> (expirationTime === Sync) &#123;</span><br><span class="line">    performSyncWork();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    scheduleCallbackWithExpirationTime(root, expirationTime);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="performWork"><a href="#performWork" class="headerlink" title="performWork"></a>performWork</h5><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performWork</span>(<span class="params">minExpirationTime: ExpirationTime, dl: Deadline | <span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">  deadline = dl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Keep working on roots until there's no more work, or until we reach</span></span><br><span class="line">  <span class="comment">// the deadline.</span></span><br><span class="line">  findHighestPriorityRoot();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (deadline !== <span class="literal">null</span>) &#123;</span><br><span class="line">    recomputeCurrentRendererTime();</span><br><span class="line">    currentSchedulerTime = currentRendererTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableUserTimingAPI) &#123;</span><br><span class="line">      <span class="keyword">const</span> didExpire = nextFlushedExpirationTime &lt; currentRendererTime;</span><br><span class="line">      <span class="keyword">const</span> timeout = expirationTimeToMs(nextFlushedExpirationTime);</span><br><span class="line">      stopRequestCallbackTimer(didExpire, timeout);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (</span><br><span class="line">      nextFlushedRoot !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">      nextFlushedExpirationTime !== NoWork &amp;&amp;</span><br><span class="line">      (minExpirationTime === NoWork ||</span><br><span class="line">        minExpirationTime &gt;= nextFlushedExpirationTime) &amp;&amp;</span><br><span class="line">      (!deadlineDidExpire || currentRendererTime &gt;= nextFlushedExpirationTime)</span><br><span class="line">    ) &#123;</span><br><span class="line">      performWorkOnRoot(</span><br><span class="line">        nextFlushedRoot,</span><br><span class="line">        nextFlushedExpirationTime,</span><br><span class="line">        currentRendererTime &gt;= nextFlushedExpirationTime,</span><br><span class="line">      );</span><br><span class="line">      findHighestPriorityRoot();</span><br><span class="line">      recomputeCurrentRendererTime();</span><br><span class="line">      currentSchedulerTime = currentRendererTime;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (</span><br><span class="line">      nextFlushedRoot !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">      nextFlushedExpirationTime !== NoWork &amp;&amp;</span><br><span class="line">      (minExpirationTime === NoWork ||</span><br><span class="line">        minExpirationTime &gt;= nextFlushedExpirationTime)</span><br><span class="line">    ) &#123;</span><br><span class="line">      performWorkOnRoot(nextFlushedRoot, nextFlushedExpirationTime, <span class="literal">true</span>);</span><br><span class="line">      findHighestPriorityRoot();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We're done flushing work. Either we ran out of time in this callback,</span></span><br><span class="line">  <span class="comment">// or there's no more work left with sufficient priority.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// If we're inside a callback, set this to false since we just completed it.</span></span><br><span class="line">  <span class="keyword">if</span> (deadline !== <span class="literal">null</span>) &#123;</span><br><span class="line">    callbackExpirationTime = NoWork;</span><br><span class="line">    callbackID = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// If there's work left over, schedule a new callback.</span></span><br><span class="line">  <span class="keyword">if</span> (nextFlushedExpirationTime !== NoWork) &#123;</span><br><span class="line">    scheduleCallbackWithExpirationTime(</span><br><span class="line">      ((nextFlushedRoot: <span class="built_in">any</span>): FiberRoot),</span><br><span class="line">      nextFlushedExpirationTime,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Clean-up.</span></span><br><span class="line">  deadline = <span class="literal">null</span>;</span><br><span class="line">  deadlineDidExpire = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  finishRendering();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="performWorkOnRoot"><a href="#performWorkOnRoot" class="headerlink" title="performWorkOnRoot"></a>performWorkOnRoot</h5><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performWorkOnRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params">  isExpired: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  invariant(</span><br><span class="line">    !isRendering,</span><br><span class="line">    <span class="string">'performWorkOnRoot was called recursively. This error is likely caused '</span> +</span><br><span class="line">      <span class="string">'by a bug in React. Please file an issue.'</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  isRendering = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if this is async work or sync/expired work.</span></span><br><span class="line">  <span class="keyword">if</span> (deadline === <span class="literal">null</span> || isExpired) &#123;</span><br><span class="line">    <span class="comment">// Flush work without yielding.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Non-yieldy work does not necessarily imply expired work. A renderer</span></span><br><span class="line">    <span class="comment">// may want to perform some work without yielding, but also without</span></span><br><span class="line">    <span class="comment">// requiring the root to complete (by triggering placeholders).</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> finishedWork = root.finishedWork;</span><br><span class="line">    <span class="keyword">if</span> (finishedWork !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// This root is already complete. We can commit it.</span></span><br><span class="line">      completeRoot(root, finishedWork, expirationTime);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      root.finishedWork = <span class="literal">null</span>;</span><br><span class="line">      <span class="comment">// If this root previously suspended, clear its existing timeout, since</span></span><br><span class="line">      <span class="comment">// we're about to try rendering again.</span></span><br><span class="line">      <span class="keyword">const</span> timeoutHandle = root.timeoutHandle;</span><br><span class="line">      <span class="keyword">if</span> (enableSuspense &amp;&amp; timeoutHandle !== noTimeout) &#123;</span><br><span class="line">        root.timeoutHandle = noTimeout;</span><br><span class="line">        <span class="comment">// $FlowFixMe Complains noTimeout is not a TimeoutID, despite the check above</span></span><br><span class="line">        cancelTimeout(timeoutHandle);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> isYieldy = <span class="literal">false</span>;</span><br><span class="line">      renderRoot(root, isYieldy, isExpired);</span><br><span class="line">      finishedWork = root.finishedWork;</span><br><span class="line">      <span class="keyword">if</span> (finishedWork !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// We've completed the root. Commit it.</span></span><br><span class="line">        completeRoot(root, finishedWork, expirationTime);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Flush async work.</span></span><br><span class="line">    <span class="keyword">let</span> finishedWork = root.finishedWork;</span><br><span class="line">    <span class="keyword">if</span> (finishedWork !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// This root is already complete. We can commit it.</span></span><br><span class="line">      completeRoot(root, finishedWork, expirationTime);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      root.finishedWork = <span class="literal">null</span>;</span><br><span class="line">      <span class="comment">// If this root previously suspended, clear its existing timeout, since</span></span><br><span class="line">      <span class="comment">// we're about to try rendering again.</span></span><br><span class="line">      <span class="keyword">const</span> timeoutHandle = root.timeoutHandle;</span><br><span class="line">      <span class="keyword">if</span> (enableSuspense &amp;&amp; timeoutHandle !== noTimeout) &#123;</span><br><span class="line">        root.timeoutHandle = noTimeout;</span><br><span class="line">        <span class="comment">// $FlowFixMe Complains noTimeout is not a TimeoutID, despite the check above</span></span><br><span class="line">        cancelTimeout(timeoutHandle);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> isYieldy = <span class="literal">true</span>;</span><br><span class="line">      renderRoot(root, isYieldy, isExpired);</span><br><span class="line">      finishedWork = root.finishedWork;</span><br><span class="line">      <span class="keyword">if</span> (finishedWork !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// We've completed the root. Check the deadline one more time</span></span><br><span class="line">        <span class="comment">// before committing.</span></span><br><span class="line">        <span class="keyword">if</span> (!shouldYield()) &#123;</span><br><span class="line">          <span class="comment">// Still time left. Commit the root.</span></span><br><span class="line">          completeRoot(root, finishedWork, expirationTime);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// There's no time left. Mark this root as complete. We'll come</span></span><br><span class="line">          <span class="comment">// back and commit it later.</span></span><br><span class="line">          root.finishedWork = finishedWork;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  isRendering = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="renderRoot"><a href="#renderRoot" class="headerlink" title="renderRoot"></a>renderRoot</h5><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  isYieldy: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  isExpired: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  invariant(</span><br><span class="line">    !isWorking,</span><br><span class="line">    <span class="string">'renderRoot was called recursively. This error is likely caused '</span> +</span><br><span class="line">      <span class="string">'by a bug in React. Please file an issue.'</span>,</span><br><span class="line">  );</span><br><span class="line">  isWorking = <span class="literal">true</span>;</span><br><span class="line">  ReactCurrentOwner.currentDispatcher = Dispatcher;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> expirationTime = root.nextExpirationTimeToWorkOn;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if we're starting from a fresh stack, or if we're resuming from</span></span><br><span class="line">  <span class="comment">// previously yielded work.</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    expirationTime !== nextRenderExpirationTime ||</span><br><span class="line">    root !== nextRoot ||</span><br><span class="line">    nextUnitOfWork === <span class="literal">null</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// Reset the stack and start working from the root.</span></span><br><span class="line">    resetStack();</span><br><span class="line">    nextRoot = root;</span><br><span class="line">    nextRenderExpirationTime = expirationTime;</span><br><span class="line">    nextUnitOfWork = createWorkInProgress(</span><br><span class="line">      nextRoot.current,</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      nextRenderExpirationTime,</span><br><span class="line">    );</span><br><span class="line">    root.pendingCommitExpirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">      <span class="comment">// Reset this flag once we start rendering a new root or at a new priority.</span></span><br><span class="line">      <span class="comment">// This might indicate that suspended work has completed.</span></span><br><span class="line">      <span class="comment">// If not, the flag will be reset.</span></span><br><span class="line">      nextRenderIncludesTimedOutPlaceholder = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Determine which interactions this batch of work currently includes,</span></span><br><span class="line">      <span class="comment">// So that we can accurately attribute time spent working on it,</span></span><br><span class="line">      <span class="comment">// And so that cascading work triggered during the render phase will be associated with it.</span></span><br><span class="line">      <span class="keyword">const</span> interactions: Set&lt;Interaction&gt; = <span class="keyword">new</span> Set();</span><br><span class="line">      root.pendingInteractionMap.forEach(</span><br><span class="line">        (scheduledInteractions, scheduledExpirationTime) =&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> (scheduledExpirationTime &lt;= expirationTime) &#123;</span><br><span class="line">            scheduledInteractions.forEach(<span class="function"><span class="params">interaction</span> =&gt;</span></span><br><span class="line">              interactions.add(interaction),</span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Store the current set of interactions on the FiberRoot for a few reasons:</span></span><br><span class="line">      <span class="comment">// We can re-use it in hot functions like renderRoot() without having to recalculate it.</span></span><br><span class="line">      <span class="comment">// We will also use it in commitWork() to pass to any Profiler onRender() hooks.</span></span><br><span class="line">      <span class="comment">// This also provides DevTools with a way to access it when the onCommitRoot() hook is called.</span></span><br><span class="line">      root.memoizedInteractions = interactions;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (interactions.size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> subscriber = __subscriberRef.current;</span><br><span class="line">        <span class="keyword">if</span> (subscriber !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> threadID = computeThreadID(</span><br><span class="line">            expirationTime,</span><br><span class="line">            root.interactionThreadID,</span><br><span class="line">          );</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            subscriber.onWorkStarted(interactions, threadID);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="comment">// Work thrown by an interaction tracing subscriber should be rethrown,</span></span><br><span class="line">            <span class="comment">// But only once it's safe (to avoid leaveing the scheduler in an invalid state).</span></span><br><span class="line">            <span class="comment">// Store the error for now and we'll re-throw in finishRendering().</span></span><br><span class="line">            <span class="keyword">if</span> (!hasUnhandledError) &#123;</span><br><span class="line">              hasUnhandledError = <span class="literal">true</span>;</span><br><span class="line">              unhandledError = error;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> prevInteractions: Set&lt;Interaction&gt; = (<span class="literal">null</span>: <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">    <span class="comment">// We're about to start new traced work.</span></span><br><span class="line">    <span class="comment">// Restore pending interactions so cascading work triggered during the render phase will be accounted for.</span></span><br><span class="line">    prevInteractions = __interactionsRef.current;</span><br><span class="line">    __interactionsRef.current = root.memoizedInteractions;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> didFatal = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  startWorkLoopTimer(nextUnitOfWork);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      workLoop(isYieldy);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (thrownValue) &#123;</span><br><span class="line">      <span class="keyword">if</span> (nextUnitOfWork === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// This is a fatal error.</span></span><br><span class="line">        didFatal = <span class="literal">true</span>;</span><br><span class="line">        onUncaughtError(thrownValue);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          <span class="comment">// Reset global debug state</span></span><br><span class="line">          <span class="comment">// We assume this is defined in DEV</span></span><br><span class="line">          (resetCurrentlyProcessingQueue: <span class="built_in">any</span>)();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> failedUnitOfWork: Fiber = nextUnitOfWork;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__ &amp;&amp; replayFailedUnitOfWorkWithInvokeGuardedCallback) &#123;</span><br><span class="line">          replayUnitOfWork(failedUnitOfWork, thrownValue, isYieldy);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> we already know this isn't true in some cases.</span></span><br><span class="line">        <span class="comment">// At least this shows a nicer error message until we figure out the cause.</span></span><br><span class="line">        <span class="comment">// https://github.com/facebook/react/issues/12449#issuecomment-386727431</span></span><br><span class="line">        invariant(</span><br><span class="line">          nextUnitOfWork !== <span class="literal">null</span>,</span><br><span class="line">          <span class="string">'Failed to replay rendering after an error. This '</span> +</span><br><span class="line">            <span class="string">'is likely caused by a bug in React. Please file an issue '</span> +</span><br><span class="line">            <span class="string">'with a reproducing case to help us find it.'</span>,</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> sourceFiber: Fiber = nextUnitOfWork;</span><br><span class="line">        <span class="keyword">let</span> returnFiber = sourceFiber.return;</span><br><span class="line">        <span class="keyword">if</span> (returnFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// This is the root. The root could capture its own errors. However,</span></span><br><span class="line">          <span class="comment">// we don't know if it errors before or after we pushed the host</span></span><br><span class="line">          <span class="comment">// context. This information is needed to avoid a stack mismatch.</span></span><br><span class="line">          <span class="comment">// Because we're not sure, treat this as a fatal error. We could track</span></span><br><span class="line">          <span class="comment">// which phase it fails in, but doesn't seem worth it. At least</span></span><br><span class="line">          <span class="comment">// for now.</span></span><br><span class="line">          didFatal = <span class="literal">true</span>;</span><br><span class="line">          onUncaughtError(thrownValue);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          throwException(</span><br><span class="line">            root,</span><br><span class="line">            returnFiber,</span><br><span class="line">            sourceFiber,</span><br><span class="line">            thrownValue,</span><br><span class="line">            nextRenderExpirationTime,</span><br><span class="line">          );</span><br><span class="line">          nextUnitOfWork = completeUnitOfWork(sourceFiber);</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">    <span class="comment">// Traced work is done for now; restore the previous interactions.</span></span><br><span class="line">    __interactionsRef.current = prevInteractions;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We're done performing work. Time to clean up.</span></span><br><span class="line">  isWorking = <span class="literal">false</span>;</span><br><span class="line">  ReactCurrentOwner.currentDispatcher = <span class="literal">null</span>;</span><br><span class="line">  resetContextDependences();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Yield back to main thread.</span></span><br><span class="line">  <span class="keyword">if</span> (didFatal) &#123;</span><br><span class="line">    <span class="keyword">const</span> didCompleteRoot = <span class="literal">false</span>;</span><br><span class="line">    stopWorkLoopTimer(interruptedBy, didCompleteRoot);</span><br><span class="line">    interruptedBy = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// There was a fatal error.</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      resetStackAfterFatalErrorInDev();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// `nextRoot` points to the in-progress root. A non-null value indicates</span></span><br><span class="line">    <span class="comment">// that we're in the middle of an async render. Set it to null to indicate</span></span><br><span class="line">    <span class="comment">// there's no more work to be done in the current batch.</span></span><br><span class="line">    nextRoot = <span class="literal">null</span>;</span><br><span class="line">    onFatal(root);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (nextUnitOfWork !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// There's still remaining async work in this tree, but we ran out of time</span></span><br><span class="line">    <span class="comment">// in the current frame. Yield back to the renderer. Unless we're</span></span><br><span class="line">    <span class="comment">// interrupted by a higher priority update, we'll continue later from where</span></span><br><span class="line">    <span class="comment">// we left off.</span></span><br><span class="line">    <span class="keyword">const</span> didCompleteRoot = <span class="literal">false</span>;</span><br><span class="line">    stopWorkLoopTimer(interruptedBy, didCompleteRoot);</span><br><span class="line">    interruptedBy = <span class="literal">null</span>;</span><br><span class="line">    onYield(root);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We completed the whole tree.</span></span><br><span class="line">  <span class="keyword">const</span> didCompleteRoot = <span class="literal">true</span>;</span><br><span class="line">  stopWorkLoopTimer(interruptedBy, didCompleteRoot);</span><br><span class="line">  <span class="keyword">const</span> rootWorkInProgress = root.current.alternate;</span><br><span class="line">  invariant(</span><br><span class="line">    rootWorkInProgress !== <span class="literal">null</span>,</span><br><span class="line">    <span class="string">'Finished root should have a work-in-progress. This error is likely '</span> +</span><br><span class="line">      <span class="string">'caused by a bug in React. Please file an issue.'</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// `nextRoot` points to the in-progress root. A non-null value indicates</span></span><br><span class="line">  <span class="comment">// that we're in the middle of an async render. Set it to null to indicate</span></span><br><span class="line">  <span class="comment">// there's no more work to be done in the current batch.</span></span><br><span class="line">  nextRoot = <span class="literal">null</span>;</span><br><span class="line">  interruptedBy = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (nextRenderDidError) &#123;</span><br><span class="line">    <span class="comment">// There was an error</span></span><br><span class="line">    <span class="keyword">if</span> (hasLowerPriorityWork(root, expirationTime)) &#123;</span><br><span class="line">      <span class="comment">// There's lower priority work. If so, it may have the effect of fixing</span></span><br><span class="line">      <span class="comment">// the exception that was just thrown. Exit without committing. This is</span></span><br><span class="line">      <span class="comment">// similar to a suspend, but without a timeout because we're not waiting</span></span><br><span class="line">      <span class="comment">// for a promise to resolve. React will restart at the lower</span></span><br><span class="line">      <span class="comment">// priority level.</span></span><br><span class="line">      markSuspendedPriorityLevel(root, expirationTime);</span><br><span class="line">      <span class="keyword">const</span> suspendedExpirationTime = expirationTime;</span><br><span class="line">      <span class="keyword">const</span> rootExpirationTime = root.expirationTime;</span><br><span class="line">      onSuspend(</span><br><span class="line">        root,</span><br><span class="line">        rootWorkInProgress,</span><br><span class="line">        suspendedExpirationTime,</span><br><span class="line">        rootExpirationTime,</span><br><span class="line">        <span class="number">-1</span>, <span class="comment">// Indicates no timeout</span></span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      <span class="comment">// There's no lower priority work, but we're rendering asynchronously.</span></span><br><span class="line">      <span class="comment">// Synchronsouly attempt to render the same level one more time. This is</span></span><br><span class="line">      <span class="comment">// similar to a suspend, but without a timeout because we're not waiting</span></span><br><span class="line">      <span class="comment">// for a promise to resolve.</span></span><br><span class="line">      !root.didError &amp;&amp;</span><br><span class="line">      !isExpired</span><br><span class="line">    ) &#123;</span><br><span class="line">      root.didError = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">const</span> suspendedExpirationTime = (root.nextExpirationTimeToWorkOn = expirationTime);</span><br><span class="line">      <span class="keyword">const</span> rootExpirationTime = (root.expirationTime = Sync);</span><br><span class="line">      onSuspend(</span><br><span class="line">        root,</span><br><span class="line">        rootWorkInProgress,</span><br><span class="line">        suspendedExpirationTime,</span><br><span class="line">        rootExpirationTime,</span><br><span class="line">        <span class="number">-1</span>, <span class="comment">// Indicates no timeout</span></span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSuspense &amp;&amp; !isExpired &amp;&amp; nextLatestAbsoluteTimeoutMs !== <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="comment">// The tree was suspended.</span></span><br><span class="line">    <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">      nextRenderIncludesTimedOutPlaceholder = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> suspendedExpirationTime = expirationTime;</span><br><span class="line">    markSuspendedPriorityLevel(root, suspendedExpirationTime);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find the earliest uncommitted expiration time in the tree, including</span></span><br><span class="line">    <span class="comment">// work that is suspended. The timeout threshold cannot be longer than</span></span><br><span class="line">    <span class="comment">// the overall expiration.</span></span><br><span class="line">    <span class="keyword">const</span> earliestExpirationTime = findEarliestOutstandingPriorityLevel(</span><br><span class="line">      root,</span><br><span class="line">      expirationTime,</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">const</span> earliestExpirationTimeMs = expirationTimeToMs(earliestExpirationTime);</span><br><span class="line">    <span class="keyword">if</span> (earliestExpirationTimeMs &lt; nextLatestAbsoluteTimeoutMs) &#123;</span><br><span class="line">      nextLatestAbsoluteTimeoutMs = earliestExpirationTimeMs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Subtract the current time from the absolute timeout to get the number</span></span><br><span class="line">    <span class="comment">// of milliseconds until the timeout. In other words, convert an absolute</span></span><br><span class="line">    <span class="comment">// timestamp to a relative time. This is the value that is passed</span></span><br><span class="line">    <span class="comment">// to `setTimeout`.</span></span><br><span class="line">    <span class="keyword">const</span> currentTimeMs = expirationTimeToMs(requestCurrentTime());</span><br><span class="line">    <span class="keyword">let</span> msUntilTimeout = nextLatestAbsoluteTimeoutMs - currentTimeMs;</span><br><span class="line">    msUntilTimeout = msUntilTimeout &lt; <span class="number">0</span> ? <span class="number">0</span> : msUntilTimeout;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Account for the Just Noticeable Difference</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> rootExpirationTime = root.expirationTime;</span><br><span class="line">    onSuspend(</span><br><span class="line">      root,</span><br><span class="line">      rootWorkInProgress,</span><br><span class="line">      suspendedExpirationTime,</span><br><span class="line">      rootExpirationTime,</span><br><span class="line">      msUntilTimeout,</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Ready to commit.</span></span><br><span class="line">  onComplete(root, rootWorkInProgress, expirationTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="completeRoot"><a href="#completeRoot" class="headerlink" title="completeRoot"></a>completeRoot</h5><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">completeRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  finishedWork: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Check if there's a batch that matches this expiration time.</span></span><br><span class="line">  <span class="keyword">const</span> firstBatch = root.firstBatch;</span><br><span class="line">  <span class="keyword">if</span> (firstBatch !== <span class="literal">null</span> &amp;&amp; firstBatch._expirationTime &lt;= expirationTime) &#123;</span><br><span class="line">    <span class="keyword">if</span> (completedBatches === <span class="literal">null</span>) &#123;</span><br><span class="line">      completedBatches = [firstBatch];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      completedBatches.push(firstBatch);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (firstBatch._defer) &#123;</span><br><span class="line">      <span class="comment">// This root is blocked from committing by a batch. Unschedule it until</span></span><br><span class="line">      <span class="comment">// we receive another update.</span></span><br><span class="line">      root.finishedWork = finishedWork;</span><br><span class="line">      root.expirationTime = NoWork;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Commit the root.</span></span><br><span class="line">  root.finishedWork = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if this is a nested update (a sync update scheduled during the</span></span><br><span class="line">  <span class="comment">// commit phase).</span></span><br><span class="line">  <span class="keyword">if</span> (root === lastCommittedRootDuringThisBatch) &#123;</span><br><span class="line">    <span class="comment">// If the next root is the same as the previous root, this is a nested</span></span><br><span class="line">    <span class="comment">// update. To prevent an infinite loop, increment the nested update count.</span></span><br><span class="line">    nestedUpdateCount++;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Reset whenever we switch roots.</span></span><br><span class="line">    lastCommittedRootDuringThisBatch = root;</span><br><span class="line">    nestedUpdateCount = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  commitRoot(root, finishedWork);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="提交更新"><a href="#提交更新" class="headerlink" title="提交更新"></a>提交更新</h4><p>处理完更新后需要确认提交更新至渲染模块，然后渲染模块才能将更新渲染至DOM。<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitRoot</span>(<span class="params">root: FiberRoot, finishedWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  isWorking = <span class="literal">true</span>;</span><br><span class="line">  isCommitting = <span class="literal">true</span>;</span><br><span class="line">  startCommitTimer();</span><br><span class="line"></span><br><span class="line">  invariant(</span><br><span class="line">    root.current !== finishedWork,</span><br><span class="line">    <span class="string">'Cannot commit the same tree as before. This is probably a bug '</span> +</span><br><span class="line">      <span class="string">'related to the return field. This error is likely caused by a bug '</span> +</span><br><span class="line">      <span class="string">'in React. Please file an issue.'</span>,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> committedExpirationTime = root.pendingCommitExpirationTime;</span><br><span class="line">  invariant(</span><br><span class="line">    committedExpirationTime !== NoWork,</span><br><span class="line">    <span class="string">'Cannot commit an incomplete root. This error is likely caused by a '</span> +</span><br><span class="line">      <span class="string">'bug in React. Please file an issue.'</span>,</span><br><span class="line">  );</span><br><span class="line">  root.pendingCommitExpirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Update the pending priority levels to account for the work that we are</span></span><br><span class="line">  <span class="comment">// about to commit. This needs to happen before calling the lifecycles, since</span></span><br><span class="line">  <span class="comment">// they may schedule additional updates.</span></span><br><span class="line">  <span class="keyword">const</span> updateExpirationTimeBeforeCommit = finishedWork.expirationTime;</span><br><span class="line">  <span class="keyword">const</span> childExpirationTimeBeforeCommit = finishedWork.childExpirationTime;</span><br><span class="line">  <span class="keyword">const</span> earliestRemainingTimeBeforeCommit =</span><br><span class="line">    updateExpirationTimeBeforeCommit === NoWork ||</span><br><span class="line">    (childExpirationTimeBeforeCommit !== NoWork &amp;&amp;</span><br><span class="line">      childExpirationTimeBeforeCommit &lt; updateExpirationTimeBeforeCommit)</span><br><span class="line">      ? childExpirationTimeBeforeCommit</span><br><span class="line">      : updateExpirationTimeBeforeCommit;</span><br><span class="line">  markCommittedPriorityLevels(root, earliestRemainingTimeBeforeCommit);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> prevInteractions: Set&lt;Interaction&gt; = (<span class="literal">null</span>: <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">    <span class="comment">// Restore any pending interactions at this point,</span></span><br><span class="line">    <span class="comment">// So that cascading work triggered during the render phase will be accounted for.</span></span><br><span class="line">    prevInteractions = __interactionsRef.current;</span><br><span class="line">    __interactionsRef.current = root.memoizedInteractions;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Reset this to null before calling lifecycles</span></span><br><span class="line">  ReactCurrentOwner.current = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> firstEffect;</span><br><span class="line">  <span class="keyword">if</span> (finishedWork.effectTag &gt; PerformedWork) &#123;</span><br><span class="line">    <span class="comment">// A fiber's effect list consists only of its children, not itself. So if</span></span><br><span class="line">    <span class="comment">// the root has an effect, we need to add it to the end of the list. The</span></span><br><span class="line">    <span class="comment">// resulting list is the set that would belong to the root's parent, if</span></span><br><span class="line">    <span class="comment">// it had one; that is, all the effects in the tree including the root.</span></span><br><span class="line">    <span class="keyword">if</span> (finishedWork.lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">      finishedWork.lastEffect.nextEffect = finishedWork;</span><br><span class="line">      firstEffect = finishedWork.firstEffect;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      firstEffect = finishedWork;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// There is no effect on the root.</span></span><br><span class="line">    firstEffect = finishedWork.firstEffect;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  prepareForCommit(root.containerInfo);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Invoke instances of getSnapshotBeforeUpdate before mutation.</span></span><br><span class="line">  nextEffect = firstEffect;</span><br><span class="line">  startCommitSnapshotEffectsTimer();</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> didError = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> error;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      invokeGuardedCallback(<span class="literal">null</span>, commitBeforeMutationLifecycles, <span class="literal">null</span>);</span><br><span class="line">      <span class="keyword">if</span> (hasCaughtError()) &#123;</span><br><span class="line">        didError = <span class="literal">true</span>;</span><br><span class="line">        error = clearCaughtError();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        commitBeforeMutationLifecycles();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        didError = <span class="literal">true</span>;</span><br><span class="line">        error = e;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (didError) &#123;</span><br><span class="line">      invariant(</span><br><span class="line">        nextEffect !== <span class="literal">null</span>,</span><br><span class="line">        <span class="string">'Should have next effect. This error is likely caused by a bug '</span> +</span><br><span class="line">          <span class="string">'in React. Please file an issue.'</span>,</span><br><span class="line">      );</span><br><span class="line">      captureCommitPhaseError(nextEffect, error);</span><br><span class="line">      <span class="comment">// Clean-up</span></span><br><span class="line">      <span class="keyword">if</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        nextEffect = nextEffect.nextEffect;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  stopCommitSnapshotEffectsTimer();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">    <span class="comment">// Mark the current commit time to be shared by all Profilers in this batch.</span></span><br><span class="line">    <span class="comment">// This enables them to be grouped later.</span></span><br><span class="line">    recordCommitTime();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Commit all the side-effects within a tree. We'll do this in two passes.</span></span><br><span class="line">  <span class="comment">// The first pass performs all the host insertions, updates, deletions and</span></span><br><span class="line">  <span class="comment">// ref unmounts.</span></span><br><span class="line">  nextEffect = firstEffect;</span><br><span class="line">  startCommitHostEffectsTimer();</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> didError = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> error;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      invokeGuardedCallback(<span class="literal">null</span>, commitAllHostEffects, <span class="literal">null</span>);</span><br><span class="line">      <span class="keyword">if</span> (hasCaughtError()) &#123;</span><br><span class="line">        didError = <span class="literal">true</span>;</span><br><span class="line">        error = clearCaughtError();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        commitAllHostEffects();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        didError = <span class="literal">true</span>;</span><br><span class="line">        error = e;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (didError) &#123;</span><br><span class="line">      invariant(</span><br><span class="line">        nextEffect !== <span class="literal">null</span>,</span><br><span class="line">        <span class="string">'Should have next effect. This error is likely caused by a bug '</span> +</span><br><span class="line">          <span class="string">'in React. Please file an issue.'</span>,</span><br><span class="line">      );</span><br><span class="line">      captureCommitPhaseError(nextEffect, error);</span><br><span class="line">      <span class="comment">// Clean-up</span></span><br><span class="line">      <span class="keyword">if</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        nextEffect = nextEffect.nextEffect;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  stopCommitHostEffectsTimer();</span><br><span class="line"></span><br><span class="line">  resetAfterCommit(root.containerInfo);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The work-in-progress tree is now the current tree. This must come after</span></span><br><span class="line">  <span class="comment">// the first pass of the commit phase, so that the previous tree is still</span></span><br><span class="line">  <span class="comment">// current during componentWillUnmount, but before the second pass, so that</span></span><br><span class="line">  <span class="comment">// the finished work is current during componentDidMount/Update.</span></span><br><span class="line">  root.current = finishedWork;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// In the second pass we'll perform all life-cycles and ref callbacks.</span></span><br><span class="line">  <span class="comment">// Life-cycles happen as a separate pass so that all placements, updates,</span></span><br><span class="line">  <span class="comment">// and deletions in the entire tree have already been invoked.</span></span><br><span class="line">  <span class="comment">// This pass also triggers any renderer-specific initial effects.</span></span><br><span class="line">  nextEffect = firstEffect;</span><br><span class="line">  startCommitLifeCyclesTimer();</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> didError = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> error;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      invokeGuardedCallback(</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        commitAllLifeCycles,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        root,</span><br><span class="line">        committedExpirationTime,</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">if</span> (hasCaughtError()) &#123;</span><br><span class="line">        didError = <span class="literal">true</span>;</span><br><span class="line">        error = clearCaughtError();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        commitAllLifeCycles(root, committedExpirationTime);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        didError = <span class="literal">true</span>;</span><br><span class="line">        error = e;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (didError) &#123;</span><br><span class="line">      invariant(</span><br><span class="line">        nextEffect !== <span class="literal">null</span>,</span><br><span class="line">        <span class="string">'Should have next effect. This error is likely caused by a bug '</span> +</span><br><span class="line">          <span class="string">'in React. Please file an issue.'</span>,</span><br><span class="line">      );</span><br><span class="line">      captureCommitPhaseError(nextEffect, error);</span><br><span class="line">      <span class="keyword">if</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        nextEffect = nextEffect.nextEffect;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  isCommitting = <span class="literal">false</span>;</span><br><span class="line">  isWorking = <span class="literal">false</span>;</span><br><span class="line">  stopCommitLifeCyclesTimer();</span><br><span class="line">  stopCommitTimer();</span><br><span class="line">  onCommitRoot(finishedWork.stateNode);</span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; ReactFiberInstrumentation.debugTool) &#123;</span><br><span class="line">    ReactFiberInstrumentation.debugTool.onCommitWork(finishedWork);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> updateExpirationTimeAfterCommit = finishedWork.expirationTime;</span><br><span class="line">  <span class="keyword">const</span> childExpirationTimeAfterCommit = finishedWork.childExpirationTime;</span><br><span class="line">  <span class="keyword">const</span> earliestRemainingTimeAfterCommit =</span><br><span class="line">    updateExpirationTimeAfterCommit === NoWork ||</span><br><span class="line">    (childExpirationTimeAfterCommit !== NoWork &amp;&amp;</span><br><span class="line">      childExpirationTimeAfterCommit &lt; updateExpirationTimeAfterCommit)</span><br><span class="line">      ? childExpirationTimeAfterCommit</span><br><span class="line">      : updateExpirationTimeAfterCommit;</span><br><span class="line">  <span class="keyword">if</span> (earliestRemainingTimeAfterCommit === NoWork) &#123;</span><br><span class="line">    <span class="comment">// If there's no remaining work, we can clear the set of already failed</span></span><br><span class="line">    <span class="comment">// error boundaries.</span></span><br><span class="line">    legacyErrorBoundariesThatAlreadyFailed = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  onCommit(root, earliestRemainingTimeAfterCommit);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">    __interactionsRef.current = prevInteractions;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> subscriber;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      subscriber = __subscriberRef.current;</span><br><span class="line">      <span class="keyword">if</span> (subscriber !== <span class="literal">null</span> &amp;&amp; root.memoizedInteractions.size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> threadID = computeThreadID(</span><br><span class="line">          committedExpirationTime,</span><br><span class="line">          root.interactionThreadID,</span><br><span class="line">        );</span><br><span class="line">        subscriber.onWorkStopped(root.memoizedInteractions, threadID);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="comment">// It's not safe for commitRoot() to throw.</span></span><br><span class="line">      <span class="comment">// Store the error for now and we'll re-throw in finishRendering().</span></span><br><span class="line">      <span class="keyword">if</span> (!hasUnhandledError) &#123;</span><br><span class="line">        hasUnhandledError = <span class="literal">true</span>;</span><br><span class="line">        unhandledError = error;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!nextRenderIncludesTimedOutPlaceholder) &#123;</span><br><span class="line">        <span class="comment">// Clear completed interactions from the pending Map.</span></span><br><span class="line">        <span class="comment">// Unless the render was suspended or cascading work was scheduled,</span></span><br><span class="line">        <span class="comment">// In which case– leave pending interactions until the subsequent render.</span></span><br><span class="line">        <span class="keyword">const</span> pendingInteractionMap = root.pendingInteractionMap;</span><br><span class="line">        pendingInteractionMap.forEach(</span><br><span class="line">          (scheduledInteractions, scheduledExpirationTime) =&gt; &#123;</span><br><span class="line">            <span class="comment">// Only decrement the pending interaction count if we're done.</span></span><br><span class="line">            <span class="comment">// If there's still work at the current priority,</span></span><br><span class="line">            <span class="comment">// That indicates that we are waiting for suspense data.</span></span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">              earliestRemainingTimeAfterCommit === NoWork ||</span><br><span class="line">              scheduledExpirationTime &lt; earliestRemainingTimeAfterCommit</span><br><span class="line">            ) &#123;</span><br><span class="line">              pendingInteractionMap.delete(scheduledExpirationTime);</span><br><span class="line"></span><br><span class="line">              scheduledInteractions.forEach(<span class="function"><span class="params">interaction</span> =&gt;</span> &#123;</span><br><span class="line">                interaction.__count--;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (subscriber !== <span class="literal">null</span> &amp;&amp; interaction.__count === <span class="number">0</span>) &#123;</span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                    subscriber.onInteractionScheduledWorkCompleted(interaction);</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    <span class="comment">// It's not safe for commitRoot() to throw.</span></span><br><span class="line">                    <span class="comment">// Store the error for now and we'll re-throw in finishRendering().</span></span><br><span class="line">                    <span class="keyword">if</span> (!hasUnhandledError) &#123;</span><br><span class="line">                      hasUnhandledError = <span class="literal">true</span>;</span><br><span class="line">                      unhandledError = error;</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 循环执行提交更新</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitAllHostEffects</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      ReactCurrentFiber.setCurrentFiber(nextEffect);</span><br><span class="line">    &#125;</span><br><span class="line">    recordEffect();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> effectTag = nextEffect.effectTag;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (effectTag &amp; ContentReset) &#123;</span><br><span class="line">      commitResetTextContent(nextEffect);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (effectTag &amp; Ref) &#123;</span><br><span class="line">      <span class="keyword">const</span> current = nextEffect.alternate;</span><br><span class="line">      <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">        commitDetachRef(current);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The following switch statement is only concerned about placement,</span></span><br><span class="line">    <span class="comment">// updates, and deletions. To avoid needing to add a case for every</span></span><br><span class="line">    <span class="comment">// possible bitmap value, we remove the secondary effects from the</span></span><br><span class="line">    <span class="comment">// effect tag and switch on that value.</span></span><br><span class="line">    <span class="keyword">let</span> primaryEffectTag = effectTag &amp; (Placement | Update | Deletion);</span><br><span class="line">    <span class="keyword">switch</span> (primaryEffectTag) &#123;</span><br><span class="line">      <span class="keyword">case</span> Placement: &#123;</span><br><span class="line">        commitPlacement(nextEffect);</span><br><span class="line">        <span class="comment">// Clear the "placement" from effect tag so that we know that this is inserted, before</span></span><br><span class="line">        <span class="comment">// any life-cycles like componentDidMount gets called.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> findDOMNode doesn't rely on this any more but isMounted</span></span><br><span class="line">        <span class="comment">// does and isMounted is deprecated anyway so we should be able</span></span><br><span class="line">        <span class="comment">// to kill this.</span></span><br><span class="line">        nextEffect.effectTag &amp;= ~Placement;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> PlacementAndUpdate: &#123;</span><br><span class="line">        <span class="comment">// Placement</span></span><br><span class="line">        commitPlacement(nextEffect);</span><br><span class="line">        <span class="comment">// Clear the "placement" from effect tag so that we know that this is inserted, before</span></span><br><span class="line">        <span class="comment">// any life-cycles like componentDidMount gets called.</span></span><br><span class="line">        nextEffect.effectTag &amp;= ~Placement;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update</span></span><br><span class="line">        <span class="keyword">const</span> current = nextEffect.alternate;</span><br><span class="line">        commitWork(current, nextEffect);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> Update: &#123;</span><br><span class="line">        <span class="keyword">const</span> current = nextEffect.alternate;</span><br><span class="line">        commitWork(current, nextEffect);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> Deletion: &#123;</span><br><span class="line">        commitDeletion(nextEffect);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    nextEffect = nextEffect.nextEffect;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    ReactCurrentFiber.resetCurrentFiber();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>提交更新是最后确认更新组件的阶段，现在我们看一下提交更新的主要逻辑：<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitWork</span>(<span class="params">current: Fiber | <span class="literal">null</span>, finishedWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!supportsMutation) &#123;</span><br><span class="line">    commitContainer(finishedWork);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> ClassComponent:</span><br><span class="line">    <span class="keyword">case</span> ClassComponentLazy: &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> instance: Instance = finishedWork.stateNode;</span><br><span class="line">      <span class="keyword">if</span> (instance != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Commit the work prepared earlier.</span></span><br><span class="line">        <span class="keyword">const</span> newProps = finishedWork.memoizedProps;</span><br><span class="line">        <span class="comment">// For hydration we reuse the update path but we treat the oldProps</span></span><br><span class="line">        <span class="comment">// as the newProps. The updatePayload will contain the real change in</span></span><br><span class="line">        <span class="comment">// this case.</span></span><br><span class="line">        <span class="keyword">const</span> oldProps = current !== <span class="literal">null</span> ? current.memoizedProps : newProps;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">type</span> = finishedWork.type;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Type the updateQueue to be specific to host components.</span></span><br><span class="line">        <span class="keyword">const</span> updatePayload: <span class="literal">null</span> | UpdatePayload = (finishedWork.updateQueue: <span class="built_in">any</span>);</span><br><span class="line">        finishedWork.updateQueue = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (updatePayload !== <span class="literal">null</span>) &#123;</span><br><span class="line">          commitUpdate(</span><br><span class="line">            instance,</span><br><span class="line">            updatePayload,</span><br><span class="line">            <span class="keyword">type</span>,</span><br><span class="line">            oldProps,</span><br><span class="line">            newProps,</span><br><span class="line">            finishedWork,</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostText: &#123;</span><br><span class="line">      invariant(</span><br><span class="line">        finishedWork.stateNode !== <span class="literal">null</span>,</span><br><span class="line">        <span class="string">'This should have a text node initialized. This error is likely '</span> +</span><br><span class="line">          <span class="string">'caused by a bug in React. Please file an issue.'</span>,</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">const</span> textInstance: TextInstance = finishedWork.stateNode;</span><br><span class="line">      <span class="keyword">const</span> newText: <span class="built_in">string</span> = finishedWork.memoizedProps;</span><br><span class="line">      <span class="comment">// For hydration we reuse the update path but we treat the oldProps</span></span><br><span class="line">      <span class="comment">// as the newProps. The updatePayload will contain the real change in</span></span><br><span class="line">      <span class="comment">// this case.</span></span><br><span class="line">      <span class="keyword">const</span> oldText: <span class="built_in">string</span> =</span><br><span class="line">        current !== <span class="literal">null</span> ? current.memoizedProps : newText;</span><br><span class="line">      commitTextUpdate(textInstance, oldText, newText);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostRoot: &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> Profiler: &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> PlaceholderComponent: &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">default</span>: &#123;</span><br><span class="line">      invariant(</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        <span class="string">'This unit of work tag should not have side-effects. This error is '</span> +</span><br><span class="line">          <span class="string">'likely caused by a bug in React. Please file an issue.'</span>,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="小结-5"><a href="#小结-5" class="headerlink" title="小结"></a>小结</h4><p>至此首次渲染的执行流程为：<br><code>ReactDOM.render</code>（渲染入口） =&gt; <code>legacyRenderSubtreeIntoContainer</code>（把虚拟的dom树渲染到真实的dom容器中） =&gt; <code>DOMRenderer.updateContainer</code>（更新容器内容） =&gt; <code>scheduleRootUpdate</code>（开始更新） =&gt; <code>scheduleWork</code>（处理更新） =&gt; <code>commitWork</code>（提交更新）</p>
<h2 id="高级指南"><a href="#高级指南" class="headerlink" title="高级指南"></a>高级指南</h2><h3 id="插槽-Portals"><a href="#插槽-Portals" class="headerlink" title="插槽(Portals)"></a>插槽(Portals)</h3><p>Portals 提供了一种很好的方法，将子节点渲染到父组件 DOM 层次结构之外的 DOM 节点。</p>
<h2 id="React-Fiber"><a href="#React-Fiber" class="headerlink" title="React Fiber"></a>React Fiber</h2><blockquote>
<p>React Fiber 并不是所谓的纤程（微线程、协程），而是一种基于浏览器的单线程调度算法。</p>
</blockquote>
<p>我们都知道浏览器渲染引擎是单线程的，在 React15.x 及之前版本，从 setState 开始到渲染完成整个过程是不受控制且连续不中断完成的，由于该过程将会占用整个线程，则其他任务都会被阻塞，如样式计算、界面布局以及许多情况下的绘制等。如果需要渲染的是一个很大、层级很深的组件，这可能就会使用户感觉明显卡顿，比如更新一个组件需要1毫秒，如果有200个组件要更新，那就需要200毫秒，在这200毫秒的更新过程中，浏览器唯一的主线程在专心运行更新操作，无暇去做其他任何事情。想象一下，在这200毫秒内，用户往一个input元素中输入点什么，敲击键盘也不会立即获得响应，虽然渲染输入按键结果是浏览器主线程的工作，但是浏览器主线程被React占用，抽不出空，最后的结果就是用户敲了按键看不到反应，等React更新过程结束之后，咔咔咔那些按键一下子出现在input元素里了，这个版本的调和器可以称为<strong>栈调和器（Stack Reconciler）</strong>。Stack Reconcilier 的主要缺陷就是<strong>不能暂停渲染任务，也不能切分任务，更无法有效平衡组件更新渲染与动画相关任务间的执行顺序（即不能划分任务优先级），这样就很有可能导致重要任务卡顿，动画掉帧等问题。</strong></p>
<p>为了解决这个问题，React 团队经过两年多的努力，提出了一个更先进的调和器，它允许渲染过程分段完成，而不必一次性完成，在渲染期间可返回到主线程控制执行其他任务。这是通过计算部分组件树的变更，并暂停渲染更新，询问主线程是否有更高需求的绘制或者更新任务需要执行，这些高需求的任务完成后再重新渲染。这一切的实现是在代码层引入了一个新的数据结构：<strong>Fiber对象</strong>，每一个组件实例对应有一个fiber实例，此fiber实例负责管理组件实例的更新，渲染任务及与其他fiber实例的通信，这个先进的调和器叫做<strong>纤维调和器（Fiber Reconciler）</strong>，它提供的新功能主要有：<br><strong>一：</strong>把可中断的任务拆分成小任务；<br><strong>二：</strong>可重用各分阶段任务，对正在做的工作调整优先次序；<br><strong>三：</strong>可以在父子组件任务间前进后退切换任务，以支持React执行过程中的布局刷新；<br><strong>四：</strong>支持 render 方法返回多个元素；<br><strong>五：</strong>对异常边界处理提供了更好的支持；</p>
<h3 id="调度任务（scheduleWork）"><a href="#调度任务（scheduleWork）" class="headerlink" title="调度任务（scheduleWork）"></a>调度任务（scheduleWork）</h3><p>前面提到 Fiber 可以异步实现不同优先级任务的协调执行，目前在 JavaScript 中也提供了这种方式，在新版主流浏览器有两个可用API：requestIdleCallback 和 requestAnimationFrame：<br><strong>requestIdleCallback：</strong>在线程空闲时调度执行低优先级函数。<br><strong>requestAnimationFrame：</strong>在下一个动画帧调度执行高优先级函数。</p>
<p>一般网页线程执行任务时会以帧的形式划分，大部分网页控制在30-60帧是不会影响用户体验的；在两个执行帧之间，主线程通常会有一小段空闲时间，requestIdleCallback可以在这个空闲期（Idle Period）调用空闲期回调（Idle Callback），执行一些任务。<br><img src="/images/react-source-analysis/img2.png" alt="img2.png"></p>
<p>而 Fiber 所做的就是需要分解渲染任务，根据优先级使用API调度，异步执行指定任务。低优先级任务由 requestIdleCallback 处理；高优先级任务，如动画相关的由 requestAnimationFrame 处理；requestIdleCallback 可以在多个空闲期调用空闲期回调，执行任务；requestIdleCallback 方法提供 deadline，即任务执行限制时间，以切分任务，避免长时间执行，阻塞UI渲染而导致掉帧；</p>
<p>现在我们来看一下 React 调度任务实现的源码：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// <span class="doctag">TODO:</span> 目前，只有一个优先级别，Deferred。未来将增加额外的优先级</span></span><br><span class="line"><span class="keyword">var</span> DEFERRED_TIMEOUT = <span class="number">5000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 回调被储存为一个双向循环链表</span></span><br><span class="line"><span class="keyword">var</span> firstCallbackNode = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否在执行工作</span></span><br><span class="line"><span class="keyword">var</span> isPerformingWork = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> isHostCallbackScheduled = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> hasNativePerformanceNow =</span><br><span class="line">  <span class="keyword">typeof</span> performance === <span class="string">'object'</span> &amp;&amp; <span class="keyword">typeof</span> performance.now === <span class="string">'function'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> timeRemaining;</span><br><span class="line"><span class="keyword">if</span> (hasNativePerformanceNow) &#123;</span><br><span class="line">  timeRemaining = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// We assume that if we have a performance timer that the rAF callback</span></span><br><span class="line">    <span class="comment">// gets a performance timer value. Not sure if this is always true.</span></span><br><span class="line">    <span class="keyword">var</span> remaining = getFrameDeadline() - performance.now();</span><br><span class="line">    <span class="comment">// 计算得到当前帧运行剩余时间</span></span><br><span class="line">    <span class="keyword">return</span> remaining &gt; <span class="number">0</span> ? remaining : <span class="number">0</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  timeRemaining = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Fallback to Date.now()</span></span><br><span class="line">    <span class="keyword">var</span> remaining = getFrameDeadline() - <span class="built_in">Date</span>.now();</span><br><span class="line">    <span class="comment">// 计算得到当前帧运行剩余时间</span></span><br><span class="line">    <span class="keyword">return</span> remaining &gt; <span class="number">0</span> ? remaining : <span class="number">0</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> deadlineObject = &#123;</span><br><span class="line">  timeRemaining,</span><br><span class="line">  didTimeout: <span class="literal">false</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ensureHostCallbackIsScheduled</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 正在执行工作</span></span><br><span class="line">  <span class="keyword">if</span> (isPerformingWork) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 使用列表中最先超时的回调</span></span><br><span class="line">  <span class="keyword">var</span> timesOutAt = firstCallbackNode.timesOutAt;</span><br><span class="line">  <span class="keyword">if</span> (!isHostCallbackScheduled) &#123;</span><br><span class="line">    isHostCallbackScheduled = <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 取消回调</span></span><br><span class="line">    cancelCallback();</span><br><span class="line">  &#125;</span><br><span class="line">  requestCallback(flushWork, timesOutAt);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 刷新第一次回调</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushFirstCallback</span>(<span class="params">node</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> flushedNode = firstCallbackNode;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 在调用回调之前从列表中移除该节点。这样，即使回调抛出, 列表也处于一致状态。</span></span><br><span class="line">  <span class="keyword">var</span> next = firstCallbackNode.next;</span><br><span class="line">  <span class="keyword">if</span> (firstCallbackNode === next) &#123;</span><br><span class="line">    <span class="comment">// 这是列表中的最后一个回调。</span></span><br><span class="line">    firstCallbackNode = <span class="literal">null</span>;</span><br><span class="line">    next = <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> previous = firstCallbackNode.previous;</span><br><span class="line">    firstCallbackNode = previous.next = next;</span><br><span class="line">    next.previous = previous;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  flushedNode.next = flushedNode.previous = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 现在调用回调是安全的。</span></span><br><span class="line">  <span class="keyword">var</span> callback = flushedNode.callback;</span><br><span class="line">  callback(deadlineObject);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushWork</span>(<span class="params">didTimeout</span>) </span>&#123;</span><br><span class="line">  isPerformingWork = <span class="literal">true</span>;</span><br><span class="line">  deadlineObject.didTimeout = didTimeout;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (didTimeout) &#123;</span><br><span class="line">      <span class="comment">// Flush all the timed out callbacks without yielding.</span></span><br><span class="line">      <span class="keyword">while</span> (firstCallbackNode !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Read the current time. Flush all the callbacks that expire at or</span></span><br><span class="line">        <span class="comment">// earlier than that time. Then read the current time again and repeat.</span></span><br><span class="line">        <span class="comment">// This optimizes for as few performance.now calls as possible.</span></span><br><span class="line">        <span class="keyword">var</span> currentTime = getCurrentTime();</span><br><span class="line">        <span class="keyword">if</span> (firstCallbackNode.timesOutAt &lt;= currentTime) &#123;</span><br><span class="line">          <span class="keyword">do</span> &#123;</span><br><span class="line">            flushFirstCallback();</span><br><span class="line">          &#125; <span class="keyword">while</span> (</span><br><span class="line">            firstCallbackNode !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">            firstCallbackNode.timesOutAt &lt;= currentTime</span><br><span class="line">          );</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Keep flushing callbacks until we run out of time in the frame.</span></span><br><span class="line">      <span class="keyword">if</span> (firstCallbackNode !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">          flushFirstCallback();</span><br><span class="line">        &#125; <span class="keyword">while</span> (</span><br><span class="line">          firstCallbackNode !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">          getFrameDeadline() - getCurrentTime() &gt; <span class="number">0</span></span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    isPerformingWork = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (firstCallbackNode !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// There's still work remaining. Request another callback.</span></span><br><span class="line">      ensureHostCallbackIsScheduled(firstCallbackNode);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      isHostCallbackScheduled = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调度任务，这是一个不稳定 api</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unstable_scheduleWork</span>(<span class="params">callback, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> currentTime = getCurrentTime();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> timesOutAt;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    options !== <span class="literal">undefined</span> &amp;&amp;</span><br><span class="line">    options !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    options.timeout !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    options.timeout !== <span class="literal">undefined</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// 根据传入的 timeout 计算超时</span></span><br><span class="line">    timesOutAt = currentTime + options.timeout;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 使用默认常量计算超时</span></span><br><span class="line">    timesOutAt = currentTime + DEFERRED_TIMEOUT;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> newNode = &#123;</span><br><span class="line">    callback,</span><br><span class="line">    timesOutAt,</span><br><span class="line">    next: <span class="literal">null</span>,</span><br><span class="line">    previous: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将新回调插入列表中, 并按其超时顺序排序</span></span><br><span class="line">  <span class="keyword">if</span> (firstCallbackNode === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 这是列表中的第一个回调</span></span><br><span class="line">    firstCallbackNode = newNode.next = newNode.previous = newNode;</span><br><span class="line">    ensureHostCallbackIsScheduled(firstCallbackNode);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> next = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> node = firstCallbackNode;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (node.timesOutAt &gt; timesOutAt) &#123;</span><br><span class="line">        <span class="comment">// 在此之前, 新的回调超时</span></span><br><span class="line">        next = node;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      node = node.next;</span><br><span class="line">    &#125; <span class="keyword">while</span> (node !== firstCallbackNode);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 找不到稍后超时的回调, 这意味着新的回调在列表中具有最新的超时。</span></span><br><span class="line">      next = firstCallbackNode;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (next === firstCallbackNode) &#123;</span><br><span class="line">      <span class="comment">// 新回调在整个列表中具有最早的超时。</span></span><br><span class="line">      firstCallbackNode = newNode;</span><br><span class="line">      ensureHostCallbackIsScheduled(firstCallbackNode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> previous = next.previous;</span><br><span class="line">    previous.next = next.previous = newNode;</span><br><span class="line">    newNode.next = next;</span><br><span class="line">    newNode.previous = previous;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> newNode;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unstable_cancelScheduledWork</span>(<span class="params">callbackNode</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> next = callbackNode.next;</span><br><span class="line">  <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Already cancelled.</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (next === callbackNode) &#123;</span><br><span class="line">    <span class="comment">// This is the only scheduled callback. Clear the list.</span></span><br><span class="line">    firstCallbackNode = <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Remove the callback from its position in the list.</span></span><br><span class="line">    <span class="keyword">if</span> (callbackNode === firstCallbackNode) &#123;</span><br><span class="line">      firstCallbackNode = next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> previous = callbackNode.previous;</span><br><span class="line">    previous.next = next;</span><br><span class="line">    next.previous = previous;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  callbackNode.next = callbackNode.previous = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The remaining code is essentially a polyfill for requestIdleCallback. It</span></span><br><span class="line"><span class="comment">// works by scheduling a requestAnimationFrame, storing the time for the start</span></span><br><span class="line"><span class="comment">// of the frame, then scheduling a postMessage which gets scheduled after paint.</span></span><br><span class="line"><span class="comment">// Within the postMessage handler do as much work as possible until time + frame</span></span><br><span class="line"><span class="comment">// rate. By separating the idle call into a separate event tick we ensure that</span></span><br><span class="line"><span class="comment">// layout, paint and other browser work is counted against the available time.</span></span><br><span class="line"><span class="comment">// The frame rate is dynamically adjusted.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// We capture a local reference to any global, in case it gets polyfilled after</span></span><br><span class="line"><span class="comment">// this module is initially evaluated. We want to be using a</span></span><br><span class="line"><span class="comment">// consistent implementation.</span></span><br><span class="line"><span class="keyword">var</span> localDate = <span class="built_in">Date</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This initialization code may run even on server environments if a component</span></span><br><span class="line"><span class="comment">// just imports ReactDOM (e.g. for findDOMNode). Some environments might not</span></span><br><span class="line"><span class="comment">// have setTimeout or clearTimeout. However, we always expect them to be defined</span></span><br><span class="line"><span class="comment">// on the client. https://github.com/facebook/react/pull/13088</span></span><br><span class="line"><span class="keyword">var</span> localSetTimeout = <span class="keyword">typeof</span> setTimeout === <span class="string">'function'</span> ? setTimeout : <span class="literal">undefined</span>;</span><br><span class="line"><span class="keyword">var</span> localClearTimeout =</span><br><span class="line">  <span class="keyword">typeof</span> clearTimeout === <span class="string">'function'</span> ? clearTimeout : <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// We don't expect either of these to necessarily be defined, but we will error</span></span><br><span class="line"><span class="comment">// later if they are missing on the client.</span></span><br><span class="line"><span class="keyword">var</span> localRequestAnimationFrame =</span><br><span class="line">  <span class="keyword">typeof</span> requestAnimationFrame === <span class="string">'function'</span></span><br><span class="line">    ? requestAnimationFrame</span><br><span class="line">    : <span class="literal">undefined</span>;</span><br><span class="line"><span class="keyword">var</span> localCancelAnimationFrame =</span><br><span class="line">  <span class="keyword">typeof</span> cancelAnimationFrame === <span class="string">'function'</span> ? cancelAnimationFrame : <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> getCurrentTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">// requestAnimationFrame does not run when the tab is in the background. If</span></span><br><span class="line"><span class="comment">// we're backgrounded we prefer for that work to happen so that the page</span></span><br><span class="line"><span class="comment">// continues to load in the background. So we also schedule a 'setTimeout' as</span></span><br><span class="line"><span class="comment">// a fallback.</span></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> Need a better heuristic for backgrounded work.</span></span><br><span class="line"><span class="keyword">var</span> ANIMATION_FRAME_TIMEOUT = <span class="number">100</span>;</span><br><span class="line"><span class="keyword">var</span> rAFID;</span><br><span class="line"><span class="keyword">var</span> rAFTimeoutID;</span><br><span class="line"><span class="keyword">var</span> requestAnimationFrameWithTimeout = <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// schedule rAF and also a setTimeout</span></span><br><span class="line">  rAFID = localRequestAnimationFrame(<span class="function"><span class="keyword">function</span>(<span class="params">timestamp</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// cancel the setTimeout</span></span><br><span class="line">    localClearTimeout(rAFTimeoutID);</span><br><span class="line">    callback(timestamp);</span><br><span class="line">  &#125;);</span><br><span class="line">  rAFTimeoutID = localSetTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// cancel the requestAnimationFrame</span></span><br><span class="line">    localCancelAnimationFrame(rAFID);</span><br><span class="line">    callback(getCurrentTime());</span><br><span class="line">  &#125;, ANIMATION_FRAME_TIMEOUT);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (hasNativePerformanceNow) &#123;</span><br><span class="line">  <span class="keyword">var</span> Performance = performance;</span><br><span class="line">  getCurrentTime = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Performance.now();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  getCurrentTime = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> localDate.now();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> requestCallback;</span><br><span class="line"><span class="keyword">var</span> cancelCallback;</span><br><span class="line"><span class="keyword">var</span> getFrameDeadline;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">window</span> === <span class="string">'undefined'</span>) &#123; <span class="comment">// 非浏览器环境</span></span><br><span class="line">  <span class="keyword">var</span> timeoutID = <span class="number">-1</span>;</span><br><span class="line">  requestCallback = <span class="function"><span class="keyword">function</span>(<span class="params">callback, absoluteTimeout</span>) </span>&#123;</span><br><span class="line">    timeoutID = setTimeout(callback, <span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  cancelCallback = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    clearTimeout(timeoutID);</span><br><span class="line">  &#125;;</span><br><span class="line">  getFrameDeadline = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">window</span>._schedMock) &#123; <span class="comment">// 动态注入, 仅用于测试目的。</span></span><br><span class="line">  <span class="keyword">var</span> impl = <span class="built_in">window</span>._schedMock;</span><br><span class="line">  requestCallback = impl[<span class="number">0</span>];</span><br><span class="line">  cancelCallback = impl[<span class="number">1</span>];</span><br><span class="line">  getFrameDeadline = impl[<span class="number">2</span>];</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">console</span> !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> localRequestAnimationFrame !== <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.error(</span><br><span class="line">        <span class="string">"This browser doesn't support requestAnimationFrame. "</span> +</span><br><span class="line">          <span class="string">'Make sure that you load a '</span> +</span><br><span class="line">          <span class="string">'polyfill in older browsers. https://fb.me/react-polyfills'</span>,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> localCancelAnimationFrame !== <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.error(</span><br><span class="line">        <span class="string">"This browser doesn't support cancelAnimationFrame. "</span> +</span><br><span class="line">          <span class="string">'Make sure that you load a '</span> +</span><br><span class="line">          <span class="string">'polyfill in older browsers. https://fb.me/react-polyfills'</span>,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> scheduledCallback = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// 是否在执行空闲期回调</span></span><br><span class="line">  <span class="keyword">var</span> isIdleScheduled = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">var</span> timeoutTime = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> isAnimationFrameScheduled = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> isPerformingIdleWork = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> frameDeadline = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用启发式跟踪法，从30fps（即30帧）开始调整得到的更适于当前环境的一帧限制时间；</span></span><br><span class="line">  <span class="keyword">var</span> previousFrameTime = <span class="number">33</span>;</span><br><span class="line">  <span class="keyword">var</span> activeFrameTime = <span class="number">33</span>;</span><br><span class="line"></span><br><span class="line">  getFrameDeadline = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> frameDeadline;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We use the postMessage trick to defer idle work until after the repaint.</span></span><br><span class="line">  <span class="keyword">var</span> messageKey =</span><br><span class="line">    <span class="string">'__reactIdleCallback$'</span> +</span><br><span class="line">    <span class="built_in">Math</span>.random()</span><br><span class="line">      .toString(<span class="number">36</span>)</span><br><span class="line">      .slice(<span class="number">2</span>);</span><br><span class="line">  <span class="comment">// 空闲期回调</span></span><br><span class="line">  <span class="keyword">var</span> idleTick = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (event.source !== <span class="built_in">window</span> || event.data !== messageKey) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 重置为false，表明可以调用空闲期回调</span></span><br><span class="line">    isIdleScheduled = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> currentTime = getCurrentTime();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> didTimeout = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (frameDeadline - currentTime &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 帧到期时间小于当前时间，说明已过期</span></span><br><span class="line">      <span class="keyword">if</span> (timeoutTime !== <span class="number">-1</span> &amp;&amp; timeoutTime &lt;= currentTime) &#123;</span><br><span class="line">        <span class="comment">// 此帧已过期，且发生任务处理函数（执行具体任务，传入的回调）的超时</span></span><br><span class="line">        <span class="comment">// 需要执行任务处理，下文将调用；</span></span><br><span class="line">        didTimeout = <span class="literal">true</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 帧已过期，但没有发生任务处理函数的超时，暂时不调用任务处理函数</span></span><br><span class="line">        <span class="keyword">if</span> (!isAnimationFrameScheduled) &#123;</span><br><span class="line">          <span class="comment">// 当前没有调度别的帧回调函数</span></span><br><span class="line">          <span class="comment">// 调度下一帧</span></span><br><span class="line">          isAnimationFrameScheduled = <span class="literal">true</span>;</span><br><span class="line">          requestAnimationFrameWithTimeout(animationTick);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Exit without invoking the callback.</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 缓存的任务处理函数</span></span><br><span class="line">    timeoutTime = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">var</span> callback = scheduledCallback;</span><br><span class="line">    scheduledCallback = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">      isPerformingIdleWork = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 执行回调</span></span><br><span class="line">        callback(didTimeout);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        isPerformingIdleWork = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// Assumes that we have addEventListener in this environment. Might need</span></span><br><span class="line">  <span class="comment">// something better for old IE.</span></span><br><span class="line">  <span class="built_in">window</span>.addEventListener(<span class="string">'message'</span>, idleTick, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 帧回调</span></span><br><span class="line">  <span class="keyword">var</span> animationTick = <span class="function"><span class="keyword">function</span>(<span class="params">rafTime</span>) </span>&#123;</span><br><span class="line">    isAnimationFrameScheduled = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">var</span> nextFrameTime = rafTime - frameDeadline + activeFrameTime;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      nextFrameTime &lt; activeFrameTime &amp;&amp;</span><br><span class="line">      previousFrameTime &lt; activeFrameTime</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">if</span> (nextFrameTime &lt; <span class="number">8</span>) &#123;</span><br><span class="line">        <span class="comment">// Defensive coding. We don't support higher frame rates than 120hz.</span></span><br><span class="line">        <span class="comment">// If we get lower than that, it is probably a bug.</span></span><br><span class="line">        nextFrameTime = <span class="number">8</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// If one frame goes long, then the next one can be short to catch up.</span></span><br><span class="line">      <span class="comment">// If two frames are short in a row, then that's an indication that we</span></span><br><span class="line">      <span class="comment">// actually have a higher frame rate than what we're currently optimizing.</span></span><br><span class="line">      <span class="comment">// We adjust our heuristic dynamically accordingly. For example, if we're</span></span><br><span class="line">      <span class="comment">// running on 120hz display or 90hz VR display.</span></span><br><span class="line">      <span class="comment">// Take the max of the two in case one of them was an anomaly due to</span></span><br><span class="line">      <span class="comment">// missed frame deadlines.</span></span><br><span class="line">      activeFrameTime =</span><br><span class="line">        nextFrameTime &lt; previousFrameTime ? previousFrameTime : nextFrameTime;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      previousFrameTime = nextFrameTime;</span><br><span class="line">    &#125;</span><br><span class="line">    frameDeadline = rafTime + activeFrameTime;</span><br><span class="line">    <span class="keyword">if</span> (!isIdleScheduled) &#123;</span><br><span class="line">      <span class="comment">// 不在执行空闲期回调，表明可以调用空闲期回调</span></span><br><span class="line">      isIdleScheduled = <span class="literal">true</span>;</span><br><span class="line">      <span class="built_in">window</span>.postMessage(messageKey, <span class="string">'*'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 自定义 模拟requestIdleCallback</span></span><br><span class="line">  requestCallback = <span class="function"><span class="keyword">function</span>(<span class="params">callback, absoluteTimeout</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 回调函数</span></span><br><span class="line">    scheduledCallback = callback;</span><br><span class="line">    timeoutTime = absoluteTimeout;</span><br><span class="line">    <span class="keyword">if</span> (isPerformingIdleWork) &#123;</span><br><span class="line">      <span class="comment">// 如果我们已经在执行空闲工作, 则必须抛出错误。</span></span><br><span class="line">      <span class="comment">// 不要等待下一帧。在新事件中继续尽快工作 ASAP。</span></span><br><span class="line">      <span class="built_in">window</span>.postMessage(messageKey, <span class="string">'*'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isAnimationFrameScheduled) &#123;</span><br><span class="line">      <span class="comment">// 如果当前没有调度帧回调函数，我们需要进行一个调度帧回调函数</span></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> rAF 仍是 setTimeout</span></span><br><span class="line">      isAnimationFrameScheduled = <span class="literal">true</span>;</span><br><span class="line">      <span class="comment">// 初始开始执行帧回调 </span></span><br><span class="line">      requestAnimationFrameWithTimeout(animationTick);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  cancelCallback = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    scheduledCallback = <span class="literal">null</span>;</span><br><span class="line">    isIdleScheduled = <span class="literal">false</span>;</span><br><span class="line">    timeoutTime = <span class="number">-1</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  unstable_scheduleWork,</span><br><span class="line">  unstable_cancelScheduledWork,</span><br><span class="line">  getCurrentTime <span class="keyword">as</span> unstable_now,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h3 id="Fiber与组件"><a href="#Fiber与组件" class="headerlink" title="Fiber与组件"></a>Fiber与组件</h3><p>我们已经知道了Fiber的功能及其主要特点，那么其如何和组件联系，并且如何实现效果的呢，以下几点可以概括：</p>
<ol>
<li>React应用中的基础单元是组件，应用以组件树形式组织，渲染组件；</li>
<li>Fiber调和器基础单元则是fiber（调和单元），应用以fiber树形式组织，应用Fiber算法；</li>
<li>组件树和fiber树结构对应，一个组件实例有一个对应的fiber实例；</li>
<li>Fiber负责整个应用层面的调和，fiber实例负责对应组件的调和；</li>
</ol>
<p><strong>注意Fiber与fiber的区别，Fiber是指调和器算法，fiber则是调和器算法组成单元，和组件与应用关系类似，每一个组件实例会有对应的fiber实例负责该组件的调和。</strong></p>
<h3 id="Fiber数据结构"><a href="#Fiber数据结构" class="headerlink" title="Fiber数据结构"></a>Fiber数据结构</h3><p>截止目前，我们对Fiber应该有了初步的了解，在具体介绍Fiber的实现与架构之前，准备先简单介绍一下Fiber的数据结构，数据结构能一定程度反映其整体工作架构。<br>其实，一个fiber就是一个JavaScript对象，以键值对形式存储了一个关联组件的信息，包括组件接收的props，维护的state，最后需要渲染出的内容等。接下来我们将介Fiber对象的主要属性。</p>
<h4 id="FiberRoot-对象"><a href="#FiberRoot-对象" class="headerlink" title="FiberRoot 对象"></a>FiberRoot 对象</h4><p>FiberRoot 对象主要用来管理组件树组件的更新进程，同时记录组件树挂载的DOM容器相关信息。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> type FiberRoot = &#123;</span><br><span class="line">  <span class="comment">// fiber节点的容器元素相关信息，通常会直接传入容器元素</span></span><br><span class="line">  containerInfo: any,</span><br><span class="line">  <span class="comment">// 仅用于持久更新</span></span><br><span class="line">  pendingChildren: any,</span><br><span class="line">  <span class="comment">// 当前fiber树中激活状态（正在处理）的fiber节点</span></span><br><span class="line">  current: Fiber,</span><br><span class="line">  <span class="comment">// 从提交中暂停的最早和最新的优先级级别</span></span><br><span class="line">  earliestSuspendedTime: ExpirationTime,</span><br><span class="line">  latestSuspendedTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// 不知道要暂停的最早和最新的优先级级别。</span></span><br><span class="line">  earliestPendingTime: ExpirationTime,</span><br><span class="line">  latestPendingTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// 由已解决的承诺 pinged 的最新优先级级别, 并可以重试</span></span><br><span class="line">  latestPingedTime: ExpirationTime,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果引发错误, 并且队列中没有其他更新, 我们尝试在处理前再一次从根中渲染错误。</span></span><br><span class="line">  didError: boolean,</span><br><span class="line"></span><br><span class="line">  pendingCommitExpirationTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// 已完成的工作正在进行的 HostRoot 已准备好提交</span></span><br><span class="line">  finishedWork: Fiber | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// setTimeout 返回的超时句柄。如果它被一个新的取代了。用于取消挂起的超时, </span></span><br><span class="line">  timeoutHandle: TimeoutHandle | NoTimeout,</span><br><span class="line">  <span class="comment">// 顶部上下文对象, 由 renderSubtreeIntoContainer 使用</span></span><br><span class="line">  context: <span class="built_in">Object</span> | <span class="literal">null</span>,</span><br><span class="line">  pendingContext: <span class="built_in">Object</span> | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// 确定我们是否应该尝试在初始加载使用 hydrate</span></span><br><span class="line">  +hydrate: boolean,</span><br><span class="line">  <span class="comment">// 此节点剩余的任务到期时间</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Lift this into the renderer</span></span><br><span class="line">  nextExpirationTimeToWorkOn: ExpirationTime,</span><br><span class="line">  expirationTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// 顶级批次的列表。此列表指示是否应推迟提交，也包含完成回调。</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Lift this into the renderer</span></span><br><span class="line">  firstBatch: Batch | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// 多组件树FirberRoot对象以单链表存储链接，指向下一个需要调度的FiberRoot</span></span><br><span class="line">  nextScheduledRoot: FiberRoot | <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><strong>创建FiberRoot实例</strong><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createFiberRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  containerInfo: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  isAsync: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrate: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">FiberRoot</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 创建初始根组件对应的fiber实例</span></span><br><span class="line">  <span class="keyword">const</span> uninitializedFiber = createHostRootFiber(isAsync);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> root;</span><br><span class="line">  <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">    root = (&#123;</span><br><span class="line">      <span class="comment">// 根组件对应的fiber实例，一直用它</span></span><br><span class="line">      current: uninitializedFiber,</span><br><span class="line">      containerInfo: containerInfo,</span><br><span class="line">      pendingChildren: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">      earliestPendingTime: NoWork,</span><br><span class="line">      latestPendingTime: NoWork,</span><br><span class="line">      earliestSuspendedTime: NoWork,</span><br><span class="line">      latestSuspendedTime: NoWork,</span><br><span class="line">      latestPingedTime: NoWork,</span><br><span class="line"></span><br><span class="line">      didError: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      pendingCommitExpirationTime: NoWork,</span><br><span class="line">      finishedWork: <span class="literal">null</span>,</span><br><span class="line">      timeoutHandle: noTimeout,</span><br><span class="line">      context: <span class="literal">null</span>,</span><br><span class="line">      pendingContext: <span class="literal">null</span>,</span><br><span class="line">      hydrate,</span><br><span class="line">      nextExpirationTimeToWorkOn: NoWork,</span><br><span class="line">      expirationTime: NoWork,</span><br><span class="line">      firstBatch: <span class="literal">null</span>,</span><br><span class="line">      nextScheduledRoot: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">      interactionThreadID: unstable_getThreadID(),</span><br><span class="line">      memoizedInteractions: <span class="keyword">new</span> <span class="built_in">Set</span>(),</span><br><span class="line">      pendingInteractionMap: <span class="keyword">new</span> <span class="built_in">Map</span>(),</span><br><span class="line">    &#125;: FiberRoot);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    root = (&#123;</span><br><span class="line">      current: uninitializedFiber,</span><br><span class="line">      containerInfo: containerInfo,</span><br><span class="line">      pendingChildren: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">      earliestPendingTime: NoWork,</span><br><span class="line">      latestPendingTime: NoWork,</span><br><span class="line">      earliestSuspendedTime: NoWork,</span><br><span class="line">      latestSuspendedTime: NoWork,</span><br><span class="line">      latestPingedTime: NoWork,</span><br><span class="line"></span><br><span class="line">      didError: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      pendingCommitExpirationTime: NoWork,</span><br><span class="line">      finishedWork: <span class="literal">null</span>,</span><br><span class="line">      timeoutHandle: noTimeout,</span><br><span class="line">      context: <span class="literal">null</span>,</span><br><span class="line">      pendingContext: <span class="literal">null</span>,</span><br><span class="line">      hydrate,</span><br><span class="line">      nextExpirationTimeToWorkOn: NoWork,</span><br><span class="line">      expirationTime: NoWork,</span><br><span class="line">      firstBatch: <span class="literal">null</span>,</span><br><span class="line">      nextScheduledRoot: <span class="literal">null</span>,</span><br><span class="line">    &#125;: BaseFiberRootProperties);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 组件树根组件fiber实例的stateNode指向FiberRoot对象</span></span><br><span class="line">  uninitializedFiber.stateNode = root;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ((root: any): FiberRoot);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建返回一个初始根组件对应的fiber实例</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createHostRootFiber</span>(<span class="params">isAsync: boolean</span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> mode = isAsync ? AsyncMode | StrictMode : NoContext;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; isDevToolsPresent) &#123;</span><br><span class="line">    <span class="comment">// Always collect profile timings when DevTools are present.</span></span><br><span class="line">    <span class="comment">// This enables DevTools to start capturing timing at any point–</span></span><br><span class="line">    <span class="comment">// Without some nodes in the tree having empty base times.</span></span><br><span class="line">    mode |= ProfileMode;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建fiber</span></span><br><span class="line">  <span class="keyword">return</span> createFiber(HostRoot, <span class="literal">null</span>, <span class="literal">null</span>, mode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Fiber对象"><a href="#Fiber对象" class="headerlink" title="Fiber对象"></a>Fiber对象</h4><p><a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiber.js" target="_blank" rel="noopener">Fiber对象</a>的定义在<code>packages/react-reconciler/src/ReactFiber.js</code>中：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一个Fiber对象作用于一个组件</span></span><br><span class="line"><span class="keyword">export</span> type Fiber = &#123;|</span><br><span class="line">  <span class="comment">// 标记fiber类型tag</span></span><br><span class="line">  tag: TypeOfWork,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 唯一标识</span></span><br><span class="line">  key: <span class="literal">null</span> | string,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fiber对应的function/class/module类型组件名.</span></span><br><span class="line">  type: any,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fiber所在组件树的根组件FiberRoot对象</span></span><br><span class="line">  stateNode: any,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理完当前fiber后返回的fiber，</span></span><br><span class="line">  <span class="comment">// 返回当前fiber所在fiber树的父级fiber实例</span></span><br><span class="line">  <span class="keyword">return</span>: Fiber | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fiber树结构相关链接</span></span><br><span class="line">  child: Fiber | <span class="literal">null</span>,</span><br><span class="line">  sibling: Fiber | <span class="literal">null</span>,</span><br><span class="line">  index: number,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The ref last used to attach this node.</span></span><br><span class="line">  <span class="comment">// I'll avoid adding an owner field for prod and model that as functions.</span></span><br><span class="line">  ref: <span class="literal">null</span> | <span class="function">(<span class="params">((handle: mixed</span>) =&gt;</span> <span class="keyword">void</span>) &amp; &#123;<span class="attr">_stringRef</span>: ?string&#125;) | RefObject,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当前处理过程中的组件props对象</span></span><br><span class="line">  pendingProps: any, <span class="comment">// This type will be more specific once we overload the tag.</span></span><br><span class="line">  <span class="comment">// 缓存的之前组件props对象</span></span><br><span class="line">  memoizedProps: any, <span class="comment">// The props used to create the output.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 组件状态更新及对应回调函数的存储队列</span></span><br><span class="line">  updateQueue: UpdateQueue&lt;any&gt; | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The state used to create the output</span></span><br><span class="line">  memoizedState: any,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// A linked-list of contexts that this fiber depends on</span></span><br><span class="line">  firstContextDependency: ContextDependency&lt;mixed&gt; | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Bitfield that describes properties about the fiber and its subtree. E.g.</span></span><br><span class="line">  <span class="comment">// the AsyncMode flag indicates whether the subtree should be async-by-</span></span><br><span class="line">  <span class="comment">// default. When a fiber is created, it inherits the mode of its</span></span><br><span class="line">  <span class="comment">// parent. Additional flags can be set at creation time, but after that the</span></span><br><span class="line">  <span class="comment">// value should remain unchanged throughout the fiber's lifetime, particularly</span></span><br><span class="line">  <span class="comment">// before its child fibers are created.</span></span><br><span class="line">  mode: TypeOfMode,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Effect</span></span><br><span class="line">  effectTag: TypeOfSideEffect,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Singly linked list fast path to the next fiber with side-effects.</span></span><br><span class="line">  nextEffect: Fiber | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The first and last fiber with side-effect within this subtree. This allows</span></span><br><span class="line">  <span class="comment">// us to reuse a slice of the linked list when we reuse the work done within</span></span><br><span class="line">  <span class="comment">// this fiber.</span></span><br><span class="line">  firstEffect: Fiber | <span class="literal">null</span>,</span><br><span class="line">  lastEffect: Fiber | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新任务的最晚执行时间</span></span><br><span class="line">  expirationTime: ExpirationTime,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This is used to quickly determine if a subtree has no pending changes.</span></span><br><span class="line">  childExpirationTime: ExpirationTime,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fiber的版本池，即记录fiber更新过程，便于恢复</span></span><br><span class="line">  alternate: Fiber | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Conceptual aliases  </span></span><br><span class="line">  <span class="comment">// workInProgress : Fiber -&gt;  alternate The alternate used for reuse happens  </span></span><br><span class="line">  <span class="comment">// to be the same as work in progress.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Time spent rendering this Fiber and its descendants for the current update.</span></span><br><span class="line">  <span class="comment">// This tells us how well the tree makes use of sCU for memoization.</span></span><br><span class="line">  <span class="comment">// It is reset to 0 each time we render and only updated when we don't bailout.</span></span><br><span class="line">  <span class="comment">// This field is only set when the enableProfilerTimer flag is enabled.</span></span><br><span class="line">  actualDuration?: number,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the Fiber is currently active in the "render" phase,</span></span><br><span class="line">  <span class="comment">// This marks the time at which the work began.</span></span><br><span class="line">  <span class="comment">// This field is only set when the enableProfilerTimer flag is enabled.</span></span><br><span class="line">  actualStartTime?: number,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Duration of the most recent render time for this Fiber.</span></span><br><span class="line">  <span class="comment">// This value is not updated when we bailout for memoization purposes.</span></span><br><span class="line">  <span class="comment">// This field is only set when the enableProfilerTimer flag is enabled.</span></span><br><span class="line">  selfBaseDuration?: number,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Sum of base times for all descedents of this Fiber.</span></span><br><span class="line">  <span class="comment">// This value bubbles up during the "complete" phase.</span></span><br><span class="line">  <span class="comment">// This field is only set when the enableProfilerTimer flag is enabled.</span></span><br><span class="line">  treeBaseDuration?: number,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Conceptual aliases</span></span><br><span class="line">  <span class="comment">// workInProgress : Fiber -&gt;  alternate The alternate used for reuse happens</span></span><br><span class="line">  <span class="comment">// to be the same as work in progress.</span></span><br><span class="line">  <span class="comment">// __DEV__ only</span></span><br><span class="line">  _debugID?: number,</span><br><span class="line">  _debugSource?: Source | <span class="literal">null</span>,</span><br><span class="line">  _debugOwner?: Fiber | <span class="literal">null</span>,</span><br><span class="line">  _debugIsCurrentlyTiming?: boolean,</span><br><span class="line">|&#125;;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>type &amp; key：同React元素的值；</li>
<li>type：描述fiber对应的React组件；<ol>
<li>对于组合组件：值为function或class组件本身；</li>
<li>对于原生组件（div等）：值为该元素类型字符串；</li>
</ol>
</li>
<li>key：调和阶段，标识fiber，以检测是否可重用该fiber实例；</li>
<li>child &amp; sibling：组件树，对应生成fiber树，类比的关系；</li>
<li>pendingProps &amp; memoizedProps：分别表示组件当前传入的及之前的props；</li>
<li>return：返回当前fiber所在fiber树的父级fiber实例，即当前组件的父组件对应的fiber；</li>
<li>alternate：fiber的版本池，即记录fiber更新过程，便于恢复重用；</li>
<li>workInProgress：正在处理的fiber，概念上叫法，实际上没有此属性；</li>
</ol>
<h5 id="alternate-fiber"><a href="#alternate-fiber" class="headerlink" title="alternate fiber"></a>alternate fiber</h5><p>可以理解为一个fiber版本池，用于交替记录组件更新（切分任务后变成多阶段更新）过程中fiber的更新，因为在组件更新的各阶段，更新前及更新过程中fiber状态并不一致，在需要恢复时（如，发生冲突），即可使用另一者直接回退至上一版本fiber。</p>
<blockquote>
<ol>
<li>使用alternate属性双向连接一个当前fiber和其work-in-progress，当前fiber实例的alternate属性指向其work-in-progress，work-in-progress的alternate属性指向当前稳定fiber；</li>
<li>当前fiber的替换版本是其work-in-progress，work-in-progress的交替版本是当前fiber；</li>
<li>当work-in-progress更新一次后，将同步至当前fiber，然后继续处理，同步直至任务完成；</li>
<li>work-in-progress指向处理过程中的fiber，而当前fiber总是维护处理完成的最新版本的fiber。</li>
</ol>
</blockquote>
<h5 id="创建Fiber实例"><a href="#创建Fiber实例" class="headerlink" title="创建Fiber实例"></a>创建Fiber实例</h5><p>创建fiber实例即返回一个带有上一小节描述的诸多属性的JavaScript对象，FiberNode即根据传入的参数构造返回一个初始化的对象：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> createFiber = <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  tag: TypeOfWork,</span></span></span><br><span class="line"><span class="function"><span class="params">  pendingProps: mixed,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: null | string,</span></span></span><br><span class="line"><span class="function"><span class="params">  mode: TypeOfMode,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="comment">// $FlowFixMe: the shapes are exact here but Flow doesn't like constructors</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> FiberNode(tag, pendingProps, key, mode);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>创建alternate fiber以处理任务的实现如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个alternate fiber处理任务</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createWorkInProgress</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  pendingProps: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> workInProgress = current.alternate;</span><br><span class="line">  <span class="keyword">if</span> (workInProgress === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// We use a double buffering pooling technique because we know that we'll</span></span><br><span class="line">    <span class="comment">// only ever need at most two versions of a tree. We pool the "other" unused</span></span><br><span class="line">    <span class="comment">// node that we're free to reuse. This is lazily created to avoid allocating</span></span><br><span class="line">    <span class="comment">// extra objects for things that are never updated. It also allow us to</span></span><br><span class="line">    <span class="comment">// reclaim the extra memory if needed.</span></span><br><span class="line">    workInProgress = createFiber(</span><br><span class="line">      current.tag,</span><br><span class="line">      pendingProps,</span><br><span class="line">      current.key,</span><br><span class="line">      current.mode,</span><br><span class="line">    );</span><br><span class="line">    workInProgress.type = current.type;</span><br><span class="line">    workInProgress.stateNode = current.stateNode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="comment">// DEV-only fields</span></span><br><span class="line">      workInProgress._debugID = current._debugID;</span><br><span class="line">      workInProgress._debugSource = current._debugSource;</span><br><span class="line">      workInProgress._debugOwner = current._debugOwner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    workInProgress.alternate = current;</span><br><span class="line">    current.alternate = workInProgress;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    workInProgress.pendingProps = pendingProps;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We already have an alternate.</span></span><br><span class="line">    <span class="comment">// Reset the effect tag.</span></span><br><span class="line">    workInProgress.effectTag = NoEffect;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The effect list is no longer valid.</span></span><br><span class="line">    workInProgress.nextEffect = <span class="literal">null</span>;</span><br><span class="line">    workInProgress.firstEffect = <span class="literal">null</span>;</span><br><span class="line">    workInProgress.lastEffect = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">      <span class="comment">// We intentionally reset, rather than copy, actualDuration &amp; actualStartTime.</span></span><br><span class="line">      <span class="comment">// This prevents time from endlessly accumulating in new commits.</span></span><br><span class="line">      <span class="comment">// This has the downside of resetting values for different priority renders,</span></span><br><span class="line">      <span class="comment">// But works for yielding (the common case) and should support resuming.</span></span><br><span class="line">      workInProgress.actualDuration = <span class="number">0</span>;</span><br><span class="line">      workInProgress.actualStartTime = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Don't touching the subtree's expiration time, which has not changed.</span></span><br><span class="line">  workInProgress.childExpirationTime = current.childExpirationTime;</span><br><span class="line">  <span class="keyword">if</span> (pendingProps !== current.pendingProps) &#123;</span><br><span class="line">    <span class="comment">// This fiber has new props.</span></span><br><span class="line">    workInProgress.expirationTime = expirationTime;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// This fiber's props have not changed.</span></span><br><span class="line">    workInProgress.expirationTime = current.expirationTime;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  workInProgress.child = current.child;</span><br><span class="line">  workInProgress.memoizedProps = current.memoizedProps;</span><br><span class="line">  workInProgress.memoizedState = current.memoizedState;</span><br><span class="line">  workInProgress.updateQueue = current.updateQueue;</span><br><span class="line">  workInProgress.firstContextDependency = current.firstContextDependency;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// These will be overridden during the parent's reconciliation</span></span><br><span class="line">  workInProgress.sibling = current.sibling;</span><br><span class="line">  workInProgress.index = current.index;</span><br><span class="line">  workInProgress.ref = current.ref;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">    workInProgress.selfBaseDuration = current.selfBaseDuration;</span><br><span class="line">    workInProgress.treeBaseDuration = current.treeBaseDuration;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> workInProgress;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Fiber类型"><a href="#Fiber类型" class="headerlink" title="Fiber类型"></a>Fiber类型</h4><p>上一小节，Fiber对象中有个tag属性，标记fiber类型，而fiber实例是和组件对应的，所以其类型基本上对应于组件类型，在<code>packages/shared/ReactWorkTags.js</code>中：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> type TypeOfWork = | <span class="number">0</span> | <span class="number">1</span> | <span class="number">2</span> | <span class="number">3</span> | <span class="number">4</span> | <span class="number">5</span> | <span class="number">6</span> | <span class="number">7</span> | <span class="number">8</span> | <span class="number">9</span> | <span class="number">10</span> | <span class="number">11</span> | <span class="number">12</span> | <span class="number">13</span> | <span class="number">14</span> | <span class="number">15</span> | <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> FunctionalComponent = <span class="number">0</span>; <span class="comment">// 函数式组件</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> FunctionalComponentLazy = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ClassComponent = <span class="number">2</span>; <span class="comment">// Class类组件</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ClassComponentLazy = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> IndeterminateComponent = <span class="number">4</span>; <span class="comment">// Before we know whether it is functional or class</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> HostRoot = <span class="number">5</span>; <span class="comment">// 组件树根组件，可以嵌套</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> HostPortal = <span class="number">6</span>; <span class="comment">// 子树。可以是一个入口点不同的渲染器。</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> HostComponent = <span class="number">7</span>; <span class="comment">// 标准组件，如地div， span等</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> HostText = <span class="number">8</span>; <span class="comment">// 文本</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Fragment = <span class="number">9</span>;  <span class="comment">// 片段</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Mode = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ContextConsumer = <span class="number">11</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ContextProvider = <span class="number">12</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ForwardRef = <span class="number">13</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ForwardRefLazy = <span class="number">14</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Profiler = <span class="number">15</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> PlaceholderComponent = <span class="number">16</span>; <span class="comment">// placeholder（占位符）</span></span><br></pre></td></tr></table></figure></p>
<p>在调度执行任务的时候会根据不同类型fiber，即fiber.tag值进行不同处理。</p>
<h4 id="FiberRoot对象"><a href="#FiberRoot对象" class="headerlink" title="FiberRoot对象"></a>FiberRoot对象</h4><p>FiberRoot对象，主要用来管理组件树组件的更新进程，同时记录组件树挂载的DOM容器相关信息，在<code>packages/react-reconciler/src/ReactFiberRoot.js</code>中：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> type FiberRoot = &#123;</span><br><span class="line">  <span class="comment">// fiber节点的容器元素相关信息，通常会直接传入容器元素</span></span><br><span class="line">  containerInfo: any,</span><br><span class="line">  <span class="comment">// Used only by persistent updates.</span></span><br><span class="line">  pendingChildren: any,</span><br><span class="line">  <span class="comment">// 当前fiber树中激活状态（正在处理）的fiber节点，</span></span><br><span class="line">  current: Fiber,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The following priority levels are used to distinguish between 1)</span></span><br><span class="line">  <span class="comment">// uncommitted work, 2) uncommitted work that is suspended, and 3) uncommitted</span></span><br><span class="line">  <span class="comment">// work that may be unsuspended. We choose not to track each individual</span></span><br><span class="line">  <span class="comment">// pending level, trading granularity for performance.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// The earliest and latest priority levels that are suspended from committing.</span></span><br><span class="line">  earliestSuspendedTime: ExpirationTime,</span><br><span class="line">  latestSuspendedTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// The earliest and latest priority levels that are not known to be suspended.</span></span><br><span class="line">  earliestPendingTime: ExpirationTime,</span><br><span class="line">  latestPendingTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// The latest priority level that was pinged by a resolved promise and can</span></span><br><span class="line">  <span class="comment">// be retried.</span></span><br><span class="line">  latestPingedTime: ExpirationTime,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If an error is thrown, and there are no more updates in the queue, we try</span></span><br><span class="line">  <span class="comment">// rendering from the root one more time, synchronously, before handling</span></span><br><span class="line">  <span class="comment">// the error.</span></span><br><span class="line">  didError: boolean,</span><br><span class="line"></span><br><span class="line">  pendingCommitExpirationTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// 准备好提交的已处理完成的work-in-progress</span></span><br><span class="line">  finishedWork: Fiber | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// Timeout handle returned by setTimeout. Used to cancel a pending timeout, if</span></span><br><span class="line">  <span class="comment">// it's superseded by a new one.</span></span><br><span class="line">  timeoutHandle: TimeoutHandle | NoTimeout,</span><br><span class="line">  <span class="comment">// Top context object, used by renderSubtreeIntoContainer</span></span><br><span class="line">  context: <span class="built_in">Object</span> | <span class="literal">null</span>,</span><br><span class="line">  pendingContext: <span class="built_in">Object</span> | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// Determines if we should attempt to hydrate on the initial mount</span></span><br><span class="line">  +hydrate: boolean,</span><br><span class="line">  <span class="comment">// Remaining expiration time on this root.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Lift this into the renderer</span></span><br><span class="line">  nextExpirationTimeToWorkOn: ExpirationTime,</span><br><span class="line">  expirationTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// List of top-level batches. This list indicates whether a commit should be</span></span><br><span class="line">  <span class="comment">// deferred. Also contains completion callbacks.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Lift this into the renderer</span></span><br><span class="line">  firstBatch: Batch | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// 多组件树FirberRoot对象以单链表存储链接，指向下一个需要调度的FiberRoot</span></span><br><span class="line">  nextScheduledRoot: FiberRoot | <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h5 id="创建FiberRoot实例"><a href="#创建FiberRoot实例" class="headerlink" title="创建FiberRoot实例"></a>创建FiberRoot实例</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  ClassComponent,</span><br><span class="line">  HostRoot,</span><br><span class="line">  Mode,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'shared/ReactTypeOfWork'</span>;</span><br><span class="line"><span class="comment">// 创建返回一个初始根组件对应的fiber实例</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createHostRootFiber</span>(<span class="params">isAsync: boolean</span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> mode = isAsync ? AsyncMode | StrictMode : NoContext;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; isDevToolsPresent) &#123;</span><br><span class="line">    <span class="comment">// Always collect profile timings when DevTools are present.</span></span><br><span class="line">    <span class="comment">// This enables DevTools to start capturing timing at any point–</span></span><br><span class="line">    <span class="comment">// Without some nodes in the tree having empty base times.</span></span><br><span class="line">    mode |= ProfileMode;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 创建fiber</span></span><br><span class="line">  <span class="keyword">return</span> createFiber(HostRoot, <span class="literal">null</span>, <span class="literal">null</span>, mode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createFiberRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  containerInfo: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  isAsync: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrate: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">FiberRoot</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 创建初始根组件对应的fiber实例</span></span><br><span class="line">  <span class="keyword">const</span> uninitializedFiber = createHostRootFiber(isAsync);</span><br><span class="line">  <span class="comment">// 组件树根组件的FiberRoot对象</span></span><br><span class="line">  <span class="keyword">const</span> root = &#123;</span><br><span class="line">    <span class="comment">// 根组件对应的fiber实例</span></span><br><span class="line">    current: uninitializedFiber,</span><br><span class="line">    containerInfo: containerInfo,</span><br><span class="line">    pendingChildren: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    earliestPendingTime: NoWork,</span><br><span class="line">    latestPendingTime: NoWork,</span><br><span class="line">    earliestSuspendedTime: NoWork,</span><br><span class="line">    latestSuspendedTime: NoWork,</span><br><span class="line">    latestPingedTime: NoWork,</span><br><span class="line"></span><br><span class="line">    didError: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    pendingCommitExpirationTime: NoWork,</span><br><span class="line">    finishedWork: <span class="literal">null</span>,</span><br><span class="line">    timeoutHandle: noTimeout,</span><br><span class="line">    context: <span class="literal">null</span>,</span><br><span class="line">    pendingContext: <span class="literal">null</span>,</span><br><span class="line">    hydrate,</span><br><span class="line">    nextExpirationTimeToWorkOn: NoWork,</span><br><span class="line">    expirationTime: NoWork,</span><br><span class="line">    firstBatch: <span class="literal">null</span>,</span><br><span class="line">    nextScheduledRoot: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 组件树根组件fiber实例的stateNode指向FiberRoot对象</span></span><br><span class="line">  uninitializedFiber.stateNode = root;</span><br><span class="line">  <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ReactChildFiber"><a href="#ReactChildFiber" class="headerlink" title="ReactChildFiber"></a>ReactChildFiber</h4><p>在生成组件树的FiberRoot对象后，会为子组件生成各自的fiber实例，这一部分由<a href="">ReactChildFiber模块</a>实现，在<code>packages/react-reconciler/src/ReactChildFiber.js</code>中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调和（处理更新）子fibers</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> reconcileChildFibers = ChildReconciler(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">// 挂载（初始化）子fibers</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mountChildFibers = ChildReconciler(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>
<p>而ChildReconciler方法所做的则是根据传入参数判断是调用初始化子组件fibers逻辑还是执行调和已有子组件fibers逻辑。</p>
<p>ChildReconciler方法，返回reconcileChildFibers方法：</p>
<ol>
<li>判断子级传递内容的数据类型，执行不同的处理，这也对应着我们写React组件时传递props.children时，其类型可以是对象或数组，字符串，是数字等；</li>
<li>然后具体根据子组件类型，调用不同的具体调和处理函数；</li>
<li>最后返回根据子组件创建或更新得到的fiber实例；</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileChildFibers</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    newChild: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This function is not recursive.</span></span><br><span class="line">    <span class="comment">// If the top level item is an array, we treat it as a set of children,</span></span><br><span class="line">    <span class="comment">// not as a fragment. Nested arrays on the other hand will be treated as</span></span><br><span class="line">    <span class="comment">// fragment nodes. Recursion happens at the normal flow.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle top level unkeyed fragments as if they were arrays.</span></span><br><span class="line">    <span class="comment">// This leads to an ambiguity between &lt;&gt;&#123;[...]&#125;&lt;/&gt; and &lt;&gt;...&lt;/&gt;.</span></span><br><span class="line">    <span class="comment">// We treat the ambiguous cases above the same.</span></span><br><span class="line">    <span class="keyword">const</span> isUnkeyedTopLevelFragment =</span><br><span class="line">      <span class="keyword">typeof</span> newChild === <span class="string">'object'</span> &amp;&amp;</span><br><span class="line">      newChild !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">      newChild.type === REACT_FRAGMENT_TYPE &amp;&amp;</span><br><span class="line">      newChild.key === <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (isUnkeyedTopLevelFragment) &#123;</span><br><span class="line">      newChild = newChild.props.children;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle object types</span></span><br><span class="line">    <span class="keyword">const</span> isObject = <span class="keyword">typeof</span> newChild === <span class="string">'object'</span> &amp;&amp; newChild !== <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isObject) &#123;</span><br><span class="line">      <span class="comment">// 子组件实例类型，以Symbol符号表示的</span></span><br><span class="line">      <span class="keyword">switch</span> (newChild.$$<span class="keyword">typeof</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> REACT_ELEMENT_TYPE:</span><br><span class="line">          <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">            reconcileSingleElement(</span><br><span class="line">              returnFiber,</span><br><span class="line">              currentFirstChild,</span><br><span class="line">              newChild,</span><br><span class="line">              expirationTime,</span><br><span class="line">            ),</span><br><span class="line">          );</span><br><span class="line">         <span class="comment">// React组件调用</span></span><br><span class="line">        <span class="keyword">case</span> REACT_PORTAL_TYPE:</span><br><span class="line">          <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">            reconcileSinglePortal(</span><br><span class="line">              returnFiber,</span><br><span class="line">              currentFirstChild,</span><br><span class="line">              newChild,</span><br><span class="line">              expirationTime,</span><br><span class="line">            ),</span><br><span class="line">          );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">'string'</span> || <span class="keyword">typeof</span> newChild === <span class="string">'number'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">        reconcileSingleTextNode(</span><br><span class="line">          returnFiber,</span><br><span class="line">          currentFirstChild,</span><br><span class="line">          <span class="string">''</span> + newChild,</span><br><span class="line">          expirationTime,</span><br><span class="line">        ),</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isArray(newChild)) &#123;</span><br><span class="line">      <span class="keyword">return</span> reconcileChildrenArray(</span><br><span class="line">        returnFiber,</span><br><span class="line">        currentFirstChild,</span><br><span class="line">        newChild,</span><br><span class="line">        expirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (getIteratorFn(newChild)) &#123;</span><br><span class="line">      <span class="keyword">return</span> reconcileChildrenIterator(</span><br><span class="line">        returnFiber,</span><br><span class="line">        currentFirstChild,</span><br><span class="line">        newChild,</span><br><span class="line">        expirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isObject) &#123;</span><br><span class="line">      throwOnInvalidObjectType(returnFiber, newChild);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">'function'</span>) &#123;</span><br><span class="line">        warnOnFunctionType();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">'undefined'</span> &amp;&amp; !isUnkeyedTopLevelFragment) &#123;</span><br><span class="line">      <span class="comment">// If the new child is undefined, and the return fiber is a composite</span></span><br><span class="line">      <span class="comment">// component, throw an error. If Fiber return types are disabled,</span></span><br><span class="line">      <span class="comment">// we already threw above.</span></span><br><span class="line">      <span class="keyword">switch</span> (returnFiber.tag) &#123;</span><br><span class="line">        <span class="keyword">case</span> ClassComponent:</span><br><span class="line">        <span class="keyword">case</span> ClassComponentLazy: &#123;</span><br><span class="line">          <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            <span class="keyword">const</span> instance = returnFiber.stateNode;</span><br><span class="line">            <span class="keyword">if</span> (instance.render._isMockFunction) &#123;</span><br><span class="line">              <span class="comment">// We allow auto-mocks to proceed as if they're returning null.</span></span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Intentionally fall through to the next case, which handles both</span></span><br><span class="line">        <span class="comment">// functions and classes</span></span><br><span class="line">        <span class="comment">// eslint-disable-next-lined no-fallthrough</span></span><br><span class="line">        <span class="keyword">case</span> FunctionalComponent: &#123;</span><br><span class="line">          <span class="keyword">const</span> Component = returnFiber.type;</span><br><span class="line">          invariant(</span><br><span class="line">            <span class="literal">false</span>,</span><br><span class="line">            <span class="string">'%s(...): Nothing was returned from render. This usually means a '</span> +</span><br><span class="line">              <span class="string">'return statement is missing. Or, to render nothing, '</span> +</span><br><span class="line">              <span class="string">'return null.'</span>,</span><br><span class="line">            Component.displayName || Component.name || <span class="string">'Component'</span>,</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remaining cases are all treated as empty.</span></span><br><span class="line">    <span class="keyword">return</span> deleteRemainingChildren(returnFiber, currentFirstChild);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> reconcileChildFibers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Fiber架构"><a href="#Fiber架构" class="headerlink" title="Fiber架构"></a>Fiber架构</h3><p>在学习Fiber的时候，我尝试去阅读源码，发现通过这种方式很难快速理解，学习Fiber，而先了解调和器是干什么的及调和器在React中的存在形式，然后再学习Fiber的结构及算法实现思路，明白从组件被定义到渲染至页面它需要做什么，这也是本篇文章的组织形式。</p>
<h4 id="优先级（ExpirationTime-VS-PriorityLevel）"><a href="#优先级（ExpirationTime-VS-PriorityLevel）" class="headerlink" title="优先级（ExpirationTime VS PriorityLevel）"></a>优先级（ExpirationTime VS PriorityLevel）</h4><p>我们已经知道Fiber可以切分任务并设置不同优先级，那么是如何实现划分优先级的呢，其表现形式什么呢？</p>
<h5 id="ExpirationTime"><a href="#ExpirationTime" class="headerlink" title="ExpirationTime"></a>ExpirationTime</h5><p>Fiber切分任务并调用requestIdleCallback和requestAnimationFrameAPI，保证渲染任务和其他任务，在不影响应用交互，不掉帧的前提下，稳定执行，而实现调度的方式正是给每一个fiber实例设置到期执行时间，不同时间即代表不同优先级，到期时间越短，则代表优先级越高，需要尽早执行。</p>
<blockquote>
<p>所谓的到期时间（ExpirationTime），是相对于调度器初始调用的起始时间而言的一个时间段；调度器初始调用后的某一段时间内，需要调度完成这项更新，这个时间段长度值就是到期时间值。</p>
</blockquote>
<p>Fiber提供<a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberExpirationTime.js" target="_blank" rel="noopener">ReactFiberExpirationTime模块</a>实现到期时间的定义，在<code>packages/react-reconciler/src/ReactFiberExpirationTime.js</code>中：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> NoWork = <span class="number">0</span>; <span class="comment">// 没有任务等待处理</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Sync = <span class="number">1</span>; <span class="comment">// 同步模式，立即处理任务</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Never = MAX_SIGNED_31_BIT_INT; <span class="comment">// 1073741823 Max 31: Math.pow(2, 30) - 1 </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UNIT_SIZE = <span class="number">10</span>; <span class="comment">// 过期时间单元（ms）</span></span><br><span class="line"><span class="keyword">const</span> MAGIC_NUMBER_OFFSET = <span class="number">2</span>; <span class="comment">// 到期时间偏移量</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 以ExpirationTime特定单位（1单位=10ms）表示的到期执行时间</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">msToExpirationTime</span>(<span class="params">ms: number</span>): <span class="title">ExpirationTime</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 总是增加一个偏移量，在ms&lt;10时与Nowork模式进行区别</span></span><br><span class="line">  <span class="keyword">return</span> ((ms / UNIT_SIZE) | <span class="number">0</span>) + MAGIC_NUMBER_OFFSET;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以毫秒表示的到期执行时间</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">expirationTimeToMs</span>(<span class="params">expirationTime: ExpirationTime</span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (expirationTime - MAGIC_NUMBER_OFFSET) * UNIT_SIZE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向上取整（整数单位到期执行时间）</span></span><br><span class="line"><span class="comment">// precision范围精度：弥补任务执行时间误差</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ceiling</span>(<span class="params">num: number, precision: number</span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (((num / precision) | <span class="number">0</span>) + <span class="number">1</span>) * precision;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算处理误差时间在内的到期时间</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">computeExpirationBucket</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  currentTime,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationInMs,</span></span></span><br><span class="line"><span class="function"><span class="params">  bucketSizeMs,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">ExpirationTime</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    MAGIC_NUMBER_OFFSET +</span><br><span class="line">    ceiling(</span><br><span class="line">      currentTime - MAGIC_NUMBER_OFFSET + expirationInMs / UNIT_SIZE,</span><br><span class="line">      bucketSizeMs / UNIT_SIZE,</span><br><span class="line">    )</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> LOW_PRIORITY_EXPIRATION = <span class="number">5000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> LOW_PRIORITY_BATCH_SIZE = <span class="number">250</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">computeAsyncExpiration</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  currentTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">ExpirationTime</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> computeExpirationBucket(</span><br><span class="line">    currentTime,</span><br><span class="line">    LOW_PRIORITY_EXPIRATION,</span><br><span class="line">    LOW_PRIORITY_BATCH_SIZE,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// We intentionally set a higher expiration time for interactive updates in</span></span><br><span class="line"><span class="comment">// dev than in production.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If the main thread is being blocked so long that you hit the expiration,</span></span><br><span class="line"><span class="comment">// it's a problem that could be solved with better scheduling.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// People will be more likely to notice this and fix it with the long</span></span><br><span class="line"><span class="comment">// expiration time in development.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// In production we opt for better UX at the risk of masking scheduling</span></span><br><span class="line"><span class="comment">// problems, by expiring fast.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> HIGH_PRIORITY_EXPIRATION = __DEV__ ? <span class="number">500</span> : <span class="number">150</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> HIGH_PRIORITY_BATCH_SIZE = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">computeInteractiveExpiration</span>(<span class="params">currentTime: ExpirationTime</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> computeExpirationBucket(</span><br><span class="line">    currentTime,</span><br><span class="line">    HIGH_PRIORITY_EXPIRATION,</span><br><span class="line">    HIGH_PRIORITY_BATCH_SIZE,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该模块提供的功能主要有：</p>
<ol>
<li>Sync：同步模式，在UI线程立即执行此类任务，如动画反馈等；</li>
<li>异步模式：<ol>
<li>转换：到期时间特定单位和时间单位（ms）的相互转换；</li>
<li>计算：计算包含允许误差在内的到期时间；</li>
</ol>
</li>
</ol>
<h5 id="PriorityLevel"><a href="#PriorityLevel" class="headerlink" title="PriorityLevel"></a>PriorityLevel</h5><p>其实在15.x版本中出现了对于任务的优先层级划分，<a href="https://github.com/facebook/react/blob/15.6-dev/src/renderers/shared/fiber/ReactPriorityLevel.js" target="_blank" rel="noopener">ReactPriorityLevel模块</a>，在<code>/src/renderers/shared/fiber/ReactPriorityLevel.js</code>中：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> type PriorityLevel = <span class="number">0</span> | <span class="number">1</span> | <span class="number">2</span> | <span class="number">3</span> | <span class="number">4</span> | <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  NoWork: <span class="number">0</span>, <span class="comment">// No work is pending.</span></span><br><span class="line">  SynchronousPriority: <span class="number">1</span>, <span class="comment">// For controlled text inputs. Synchronous side-effects.</span></span><br><span class="line">  AnimationPriority: <span class="number">2</span>, <span class="comment">// Needs to complete before the next frame.</span></span><br><span class="line">  HighPriority: <span class="number">3</span>, <span class="comment">// Interaction that needs to complete pretty soon to feel responsive.</span></span><br><span class="line">  LowPriority: <span class="number">4</span>, <span class="comment">// Data fetching, or result from updating stores.</span></span><br><span class="line">  OffscreenPriority: <span class="number">5</span>, <span class="comment">// Won't be visible but do the work in case it becomes visible.</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>相对于PriorityLevel的简单层级划分，在16.x版本中使用的则是ExpirationTime的到期时间方式表示任务的优先级，可以更好的对任务进行切分，调度。</p>
<h4 id="调度器（Scheduler）"><a href="#调度器（Scheduler）" class="headerlink" title="调度器（Scheduler）"></a>调度器（Scheduler）</h4><p>前面介绍调和器主要作用就是在组件状态变更时，调用组件树各组件的render方法，渲染，卸载组件，而Fiber使得应用可以更好的协调不同任务的执行，调和器内关于高效协调的实现，我们可以称它为调度器（Scheduler）。</p>
<blockquote>
<p>顾名思义，调度器即调度资源以执行指定任务，React应用中应用组件的更新与渲染，需要占用系统CPU资源，如果不能很好的进行资源平衡，合理调度，优化任务执行策略，那很容易造成CPU这一紧缺资源的消耗和浪费，容易造成页面卡顿，动画掉帧，组件更新异常等诸多问题，就像城市交通调度一样，如果不能有效调度，交通状况很可能将拥堵不堪。</p>
</blockquote>
<p>在React 15.x版本中，组件的状态变更将直接导致其子组件树的重新渲染，新版本Fiber算法将在调度器方面进行全面改进，主要的关注点是：</p>
<ol>
<li>合并多次更新：没有必要在组件的每一个状态变更时都立即触发更新任务，有些中间状态变更其实是对更新任务所耗费资源的浪费，就比如用户发现错误点击时快速操作导致组件某状态从A至B再至C，这中间的B状态变更其实对于用户而言并没有意义，那么我们可以直接合并状态变更，直接从A至C只触发一次更新；</li>
<li>任务优先级：不同类型的更新有不同优先级，例如用户操作引起的交互动画可能需要有更好的体验，其优先级应该比完成数据更新高；</li>
<li>推拉式调度：基于推送的调度方式更多的需要开发者编码间接决定如何调度任务，而拉取式调度更方便React框架层直接进行全局自主调度；</li>
</ol>
<p><a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberScheduler.js" target="_blank" rel="noopener">源码</a>在<code>packages/react-reconciler/src/ReactFiberScheduler.js</code>中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  requestCurrentTime,</span><br><span class="line">  computeExpirationForFiber,</span><br><span class="line">  captureCommitPhaseError,</span><br><span class="line">  onUncaughtError,</span><br><span class="line">  renderDidSuspend,</span><br><span class="line">  renderDidError,</span><br><span class="line">  retrySuspendedRoot,</span><br><span class="line">  markLegacyErrorBoundaryAsFailed,</span><br><span class="line">  isAlreadyFailedLegacyErrorBoundary,</span><br><span class="line">  scheduleWork,</span><br><span class="line">  requestWork,</span><br><span class="line">  flushRoot,</span><br><span class="line">  batchedUpdates,</span><br><span class="line">  unbatchedUpdates,</span><br><span class="line">  flushSync,</span><br><span class="line">  flushControlled,</span><br><span class="line">  deferredUpdates,</span><br><span class="line">  syncUpdates,</span><br><span class="line">  interactiveUpdates,</span><br><span class="line">  flushInteractiveUpdates,</span><br><span class="line">  computeUniqueAsyncExpiration,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>如上调度器主要输出API为实现调度任务，拉取更新，延迟更新等功能。</p>
<h5 id="调度器与优先级"><a href="#调度器与优先级" class="headerlink" title="调度器与优先级"></a>调度器与优先级</h5><p>调度器如何切分任务划分优先级的呢？在React调和算法中，任务由fiber实例描述，所以要划分任务优先级，等效于设置fiber的到期时间（expirationTime），调度器内提供了computeExpirationForFiber方法以计算某一个fiber的到期时间，<a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberScheduler.js" target="_blank" rel="noopener">源码</a>在<code>packages/react-reconciler/src/ReactFiberScheduler.js</code>中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  NoWork,</span><br><span class="line">  Sync,</span><br><span class="line">  Never,</span><br><span class="line">  msToExpirationTime,</span><br><span class="line">  expirationTimeToMs,</span><br><span class="line">  computeAsyncExpiration,</span><br><span class="line">  computeInteractiveExpiration,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'./ReactFiberExpirationTime'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">computeExpirationForFiber</span>(<span class="params">currentTime: ExpirationTime, fiber: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> expirationTime;</span><br><span class="line">  <span class="keyword">if</span> (expirationContext !== NoWork) &#123;</span><br><span class="line">    <span class="comment">// An explicit expiration context was set;</span></span><br><span class="line">    expirationTime = expirationContext;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isWorking) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isCommitting) &#123;</span><br><span class="line">      <span class="comment">// 在提交阶段的更新任务 需要明确设置同步优先级（Sync Priority）</span></span><br><span class="line">      expirationTime = Sync;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 在渲染阶段发生的更新任务</span></span><br><span class="line">      <span class="comment">// 需要设置为下一次渲染时间的到期时间优先级</span></span><br><span class="line">      expirationTime = nextRenderExpirationTime;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// No explicit expiration context was set, and we're not currently</span></span><br><span class="line">    <span class="comment">// performing work. Calculate a new expiration time.</span></span><br><span class="line">    <span class="keyword">if</span> (fiber.mode &amp; AsyncMode) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isBatchingInteractiveUpdates) &#123;</span><br><span class="line">        <span class="comment">// This is an interactive update</span></span><br><span class="line">        expirationTime = computeInteractiveExpiration(currentTime);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// This is an async update</span></span><br><span class="line">        expirationTime = computeAsyncExpiration(currentTime);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// If we're in the middle of rendering a tree, do not update at the same</span></span><br><span class="line">      <span class="comment">// expiration time that is already rendering.</span></span><br><span class="line">      <span class="keyword">if</span> (nextRoot !== <span class="literal">null</span> &amp;&amp; expirationTime === nextRenderExpirationTime) &#123;</span><br><span class="line">        expirationTime += <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 同步更新，设置为同步标记</span></span><br><span class="line">      expirationTime = Sync;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isBatchingInteractiveUpdates) &#123;</span><br><span class="line">    <span class="comment">// This is an interactive update. Keep track of the lowest pending</span></span><br><span class="line">    <span class="comment">// interactive expiration time. This allows us to synchronously flush</span></span><br><span class="line">    <span class="comment">// all interactive updates when needed.</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      lowestPendingInteractiveExpirationTime === NoWork ||</span><br><span class="line">      expirationTime &gt; lowestPendingInteractiveExpirationTime</span><br><span class="line">    ) &#123;</span><br><span class="line">      lowestPendingInteractiveExpirationTime = expirationTime;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> expirationTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>若当前处于任务提交阶段（更新提交至DOM渲染）时，设置当前fiber到期时间为Sync，即同步执行模式；</li>
<li>若处于DOM渲染阶段时，则需要延迟此fiber任务，将fiber到期时间设置为下一次DOM渲染到期时间；</li>
<li>若不在任务执行阶段，则需重新设置fiber到期时间：<ol>
<li>若明确设置useSyncScheduling且fiber.internalContextTag值不等于AsyncUpdates，则表明是同步模式，设置为Sync；</li>
<li>否则，调用computeAsyncExpiration方法重新计算此fiber的到期时间；</li>
</ol>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重新计算当前时间（ExpirationTime单位表示）</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">recalculateCurrentTime</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">  <span class="keyword">const</span> ms = now() - startTime;  </span><br><span class="line">  <span class="comment">// ExpirationTime单位表示的当前时间  </span></span><br><span class="line">  <span class="comment">// 时间段值为 now() - startTime（起始时间）  </span></span><br><span class="line">  mostRecentCurrentTime = msToExpirationTime(ms);  </span><br><span class="line">  <span class="keyword">return</span> mostRecentCurrentTime;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算异步任务的到期时间</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">computeAsyncExpiration</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">  <span class="comment">// 计算得到ExpirationTime单位的当前时间  </span></span><br><span class="line">  <span class="comment">// 聚合相似的更新在一起  </span></span><br><span class="line">  <span class="comment">// 更新应该在 ~1000ms，最多1200ms内完成  </span></span><br><span class="line">  <span class="keyword">const</span> currentTime = recalculateCurrentTime();  </span><br><span class="line">  <span class="comment">// 对于每个fiber的期望到期时间的增值，最大值为1000ms </span></span><br><span class="line">  <span class="keyword">const</span> expirationMs = <span class="number">1000</span>;  </span><br><span class="line">  <span class="comment">// 到期时间的可接受误差时间，200ms </span></span><br><span class="line">  <span class="keyword">const</span> bucketSizeMs = <span class="number">200</span>;  </span><br><span class="line">  <span class="comment">// 返回包含误差时间在内的到期时间  </span></span><br><span class="line">  <span class="keyword">return</span> computeExpirationBucket(currentTime, expirationMs, bucketSizeMs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于每一个fiber我们期望的到期时间参数是1000ms，另外由于任务执行时间误差，接受200ms误差，最后计算得到的到期时间默认返回值为ExpirationTime单位。</p>
<h5 id="任务调度"><a href="#任务调度" class="headerlink" title="任务调度"></a>任务调度</h5><p>上一节介绍了调度器主要提供computeExpirationForFiber等方法支持计算任务优先级（到期时间），接下来介绍调度器如何调度任务。</p>
<blockquote>
<p>React应用更新时，Fiber从当前处理节点，层层遍历至组件树根组件，然后开始处理更新，调用前面的requestIdleCallback等API执行更新处理。</p>
</blockquote>
<p>主要调度逻辑实现在scheduleWork：</p>
<ol>
<li>通过fiber.return属性，从当前fiber实例层层遍历至组件树根组件；</li>
<li>依次对每一个fiber实例进行到期时间判断，若大于传入的期望任务到期时间参数，则将其更新为传入的任务到期时间；</li>
<li>调用requestWork方法开始处理任务，并传入获取的组件树根组件FiberRoot对象和任务到期时间；</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="渲染与调和"><a href="#渲染与调和" class="headerlink" title="渲染与调和"></a>渲染与调和</h3><p>在调和阶段，不涉及任何DOM处理，在处理完更新后，需要渲染模块将更新渲染至DOM，这也是React应用中虚拟DOM（Virtual DOM）的概念，即所有的更新计算都基于虚拟DOM，计算完后才将优化后的更新渲染至真实DOM。Fiber使用requestIdleCallbackAPI更高效的执行渲染更新的任务，实现任务的切分。</p>
<h2 id="本文不断更新中"><a href="#本文不断更新中" class="headerlink" title="本文不断更新中"></a>本文不断更新中</h2>
      
    </div>

    
      


    

    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/config/wechatpay.png" alt="Weich 微信支付"/>
        <p>微信打赏</p><!-- <p>微信支付</p> -->
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/config/alipay.png" alt="Weich 支付宝"/>
        <p>支付宝打赏</p><!-- <p>支付宝</p> -->
      </div>
    

    

  </div>
</div>

      </div>
    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Weich</li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://sosout.com/2018/08/12/react-source-analysis.html" title="React 源码全方位剖析">http://sosout.com/2018/08/12/react-source-analysis.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/react/" rel="tag"># react</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/08/11/macos-tutorial.html" rel="next" title="Mac OS系统使用指南">
                <i class="fa fa-chevron-left"></i> Mac OS系统使用指南
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/08/12/vue-source-analysis.html" rel="prev" title="Vue 源码全方位剖析">
                Vue 源码全方位剖析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Weich</p>
              <p class="site-description motion-element" itemprop="description">看博客上一探</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives">
                
                    <span class="site-state-item-count">53</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">25</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">48</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/sosout" target="_blank" title="GitHub" rel="external nofollow"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:sosout@139.com" target="_blank" title="E-Mail" rel="external nofollow"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://segmentfault.com/u/sosout" target="_blank" title="SegmentFault" rel="external nofollow"><i class="fa fa-fw fa-facebook"></i>SegmentFault</a>
                  
                </span>
              
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-twitter"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://es6.ruanyifeng.com/" title="ECMAScript 6 入门" target="_blank">ECMAScript 6 入门</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://wangdoc.com/javascript/stdlib/index.html" title="JavaScript 教程" target="_blank">JavaScript 教程</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#前置知识"><span class="nav-number">2.</span> <span class="nav-text">前置知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Flow-JavaScript静态类型检查工具"><span class="nav-number">2.1.</span> <span class="nav-text">Flow - JavaScript静态类型检查工具</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#为什么用静态类型检查工具-Flow"><span class="nav-number">2.1.1.</span> <span class="nav-text">为什么用静态类型检查工具 Flow</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#如何用静态类型检查工具-Flow"><span class="nav-number">2.1.2.</span> <span class="nav-text">如何用静态类型检查工具 Flow</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Flow-的类型检查方式"><span class="nav-number">2.1.3.</span> <span class="nav-text">Flow 的类型检查方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Flow-在-React-源码中的应用"><span class="nav-number">2.1.4.</span> <span class="nav-text">Flow 在 React 源码中的应用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#小结"><span class="nav-number">2.1.5.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Rollup-另一个前端模块化的打包工具"><span class="nav-number">2.2.</span> <span class="nav-text">Rollup - 另一个前端模块化的打包工具</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#为什么用前端模块化的打包工具-Rollup"><span class="nav-number">2.2.1.</span> <span class="nav-text">为什么用前端模块化的打包工具 Rollup</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#如何用前端模块化的打包工具-Rollup"><span class="nav-number">2.2.2.</span> <span class="nav-text">如何用前端模块化的打包工具 Rollup</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Webpack-和-Rollup-有什么不同"><span class="nav-number">2.2.3.</span> <span class="nav-text">Webpack 和 Rollup 有什么不同</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#小结-1"><span class="nav-number">2.2.4.</span> <span class="nav-text">小结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#项目介绍"><span class="nav-number">3.</span> <span class="nav-text">项目介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#项目目录"><span class="nav-number">3.1.</span> <span class="nav-text">项目目录</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#目录结构"><span class="nav-number">3.1.1.</span> <span class="nav-text">目录结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#monorepo"><span class="nav-number">3.1.2.</span> <span class="nav-text">monorepo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#小结-2"><span class="nav-number">3.1.3.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码构建"><span class="nav-number">3.2.</span> <span class="nav-text">源码构建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#构建命令"><span class="nav-number">3.2.1.</span> <span class="nav-text">构建命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#构建过程"><span class="nav-number">3.2.2.</span> <span class="nav-text">构建过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#小结-3"><span class="nav-number">3.2.3.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码入口"><span class="nav-number">3.3.</span> <span class="nav-text">源码入口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#React-对象"><span class="nav-number">3.3.1.</span> <span class="nav-text">React 对象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#渲染"><span class="nav-number">3.3.2.</span> <span class="nav-text">渲染</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#小结-4"><span class="nav-number">3.3.3.</span> <span class="nav-text">小结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#主要概念"><span class="nav-number">4.</span> <span class="nav-text">主要概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#首次渲染"><span class="nav-number">4.1.</span> <span class="nav-text">首次渲染</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#渲染入口"><span class="nav-number">4.1.1.</span> <span class="nav-text">渲染入口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#渲染虚拟dom树"><span class="nav-number">4.1.2.</span> <span class="nav-text">渲染虚拟dom树</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#root"><span class="nav-number">4.1.2.1.</span> <span class="nav-text">root</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#unbatchedUpdates"><span class="nav-number">4.1.2.2.</span> <span class="nav-text">unbatchedUpdates</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#更新容器内容"><span class="nav-number">4.1.3.</span> <span class="nav-text">更新容器内容</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#开始更新"><span class="nav-number">4.1.4.</span> <span class="nav-text">开始更新</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#处理更新"><span class="nav-number">4.1.5.</span> <span class="nav-text">处理更新</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#requestWork"><span class="nav-number">4.1.5.1.</span> <span class="nav-text">requestWork</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#performWork"><span class="nav-number">4.1.5.2.</span> <span class="nav-text">performWork</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#performWorkOnRoot"><span class="nav-number">4.1.5.3.</span> <span class="nav-text">performWorkOnRoot</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#renderRoot"><span class="nav-number">4.1.5.4.</span> <span class="nav-text">renderRoot</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#completeRoot"><span class="nav-number">4.1.5.5.</span> <span class="nav-text">completeRoot</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#提交更新"><span class="nav-number">4.1.6.</span> <span class="nav-text">提交更新</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#小结-5"><span class="nav-number">4.1.7.</span> <span class="nav-text">小结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#高级指南"><span class="nav-number">5.</span> <span class="nav-text">高级指南</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#插槽-Portals"><span class="nav-number">5.1.</span> <span class="nav-text">插槽(Portals)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#React-Fiber"><span class="nav-number">6.</span> <span class="nav-text">React Fiber</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#调度任务（scheduleWork）"><span class="nav-number">6.1.</span> <span class="nav-text">调度任务（scheduleWork）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Fiber与组件"><span class="nav-number">6.2.</span> <span class="nav-text">Fiber与组件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Fiber数据结构"><span class="nav-number">6.3.</span> <span class="nav-text">Fiber数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#FiberRoot-对象"><span class="nav-number">6.3.1.</span> <span class="nav-text">FiberRoot 对象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Fiber对象"><span class="nav-number">6.3.2.</span> <span class="nav-text">Fiber对象</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#alternate-fiber"><span class="nav-number">6.3.2.1.</span> <span class="nav-text">alternate fiber</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#创建Fiber实例"><span class="nav-number">6.3.2.2.</span> <span class="nav-text">创建Fiber实例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Fiber类型"><span class="nav-number">6.3.3.</span> <span class="nav-text">Fiber类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#FiberRoot对象"><span class="nav-number">6.3.4.</span> <span class="nav-text">FiberRoot对象</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#创建FiberRoot实例"><span class="nav-number">6.3.4.1.</span> <span class="nav-text">创建FiberRoot实例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ReactChildFiber"><span class="nav-number">6.3.5.</span> <span class="nav-text">ReactChildFiber</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Fiber架构"><span class="nav-number">6.4.</span> <span class="nav-text">Fiber架构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#优先级（ExpirationTime-VS-PriorityLevel）"><span class="nav-number">6.4.1.</span> <span class="nav-text">优先级（ExpirationTime VS PriorityLevel）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ExpirationTime"><span class="nav-number">6.4.1.1.</span> <span class="nav-text">ExpirationTime</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PriorityLevel"><span class="nav-number">6.4.1.2.</span> <span class="nav-text">PriorityLevel</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#调度器（Scheduler）"><span class="nav-number">6.4.2.</span> <span class="nav-text">调度器（Scheduler）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#调度器与优先级"><span class="nav-number">6.4.2.1.</span> <span class="nav-text">调度器与优先级</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#任务调度"><span class="nav-number">6.4.2.2.</span> <span class="nav-text">任务调度</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#渲染与调和"><span class="nav-number">6.5.</span> <span class="nav-text">渲染与调和</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#本文不断更新中"><span class="nav-number">7.</span> <span class="nav-text">本文不断更新中</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Weich</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">363k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">5:30</span>
  
</div>


  



  <div class="powered-by">由 <a class="theme-link" target="_blank" rel="external nofollow" href="https://hexo.io">Hexo</a> 强力驱动 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a class="theme-link" target="_blank" rel="external nofollow" href="https://theme-next.org">NexT.Mist</a> v6.3.0</div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="总访客量">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="总访问量">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>





  



  




















  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("JDFztM3Lau0XOKEA9BQR0Gz7-gzGzoHsz", "F34SJfnI4FhcOUUqjd4u3Rps");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            
              var $element = $(document.getElementById(url));
              $element.find('.leancloud-visitors-count').text(counter.get('time'));
            
            counter.save(null, {
              success: function(counter) {
                
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            
              var newcounter = new Counter();
              /* Set ACL */
              var acl = new AV.ACL();
              acl.setPublicReadAccess(true);
              acl.setPublicWriteAccess(true);
              newcounter.setACL(acl);
              /* End Set ACL */
              newcounter.set("title", title);
              newcounter.set("url", url);
              newcounter.set("time", 1);
              newcounter.save(null, {
                success: function(newcounter) {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
                },
                error: function(newcounter, error) {
                  console.log('Failed to create');
                }
              });
            
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  

  

  

  

  

  

</body>
</html>
